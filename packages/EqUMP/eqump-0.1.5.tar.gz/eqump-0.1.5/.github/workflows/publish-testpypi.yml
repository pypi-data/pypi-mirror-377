name: Publish â€¢ TestPyPI

on:
  workflow_run:
    workflows: ["Release Please"]
    types: [completed]

permissions:
  contents: write   # upload assets to Release
  id-token: write   # REQUIRED for PyPI Trusted Publishing

concurrency:
  group: publish-testpypi
  cancel-in-progress: false

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Get latest release tag
        id: gettag
        run: |
          TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq .tag_name)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check out code at release tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.gettag.outputs.tag }}

      - name: Bootstrap pip & install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv

      - name: Install Python 3.11 via uv
        run: uv python install 3.11 --force

      - name: Sync dependencies from uv.lock
        run: uv sync

      - name: Install build tools
        run: uv pip install build twine

      - name: Build package (sdist & wheel)
        run: uv run python -m build

      - name: Check artifacts
        run: uv run python -m twine check dist/*

      - name: Publish to TestPyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Upload artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*

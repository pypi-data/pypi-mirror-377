<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TubeZ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold me-auto" href="{{ url_for('index') }}"><i class="bi bi-film"></i> TubeZ</a>
            <div class="d-flex align-items-center">
                {% if session.logged_in %}
                 
                    <a id="nav-download-link" href="{{ url_for('files') }}" class="nav-link nav-download-icon me-2" title="View Downloads">
                        <i class="bi bi-download fs-5"></i>
                        <span id="nav-download-badge" class="nav-download-badge d-none">0</span>
                    </a>
                {% endif %}
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    {% if session.logged_in %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-search me-1"></i> Search</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('files') }}"><i class="bi bi-folder me-1"></i> Files</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('settings') }}"><i class="bi bi-gear me-1"></i> Settings</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a id="update-status-icon" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" title="Check for Updates">
                                <i class="bi bi-arrow-clockwise"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">Version Info</h6></li>
                                <li><p class="px-3 mb-2 small text-muted" id="version-status-message">Checking...</p></li>
                                <li><p class="px-3 mb-1"><span class="fw-bold">Current:</span> <span id="current-version-modal">N/A</span></p></li>
                                <li><p class="px-3 mb-1"><span class="fw-bold">Latest:</span> <span id="latest-version-modal">N/A</span></p></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-1"></i> Logout</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    
    <main class="container my-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <!-- Forced Update Modal -->
    <div class="modal fade" id="updateModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark-subtle border-secondary">
                <div class="modal-header"><h5 class="modal-title"><i class="bi bi-cloud-arrow-down-fill text-primary"></i> Update Required</h5></div>
                <div class="modal-body">
                    <p>A new version of TubeZ is available!</p>
                    <p>Your Version: <strong id="current-version-text"></strong><br>Latest Version: <strong id="latest-version-text" class="text-success"></strong></p>
                    <p class="mt-4">Please update to continue:</p>
                    <div class="input-group"><input type="text" class="form-control" value="pip install --upgrade TubeZ" readonly id="update-command-text"><button class="btn btn-outline-secondary" onclick="copyCommand()" id="copy-button"><i class="bi bi-clipboard"></i></button></div>
                    <p class="text-muted small mt-2">After updating, please restart the server.</p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONSOLIDATED SCRIPT ---
        // Both scripts now run inside a single DOMContentLoaded listener for efficiency.
        {% if session.logged_in %}
        document.addEventListener('DOMContentLoaded', function() {
            // --- Update Checker Logic ---
            const updateIconEl = document.getElementById('update-status-icon');
            fetch('/api/check_update').then(response => response.json()).then(data => {
                if (data.error) {
                    updateIconEl.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>'; return;
                }
                document.getElementById('current-version-modal').textContent = data.current_version;
                document.getElementById('latest-version-modal').textContent = data.latest_version;
                if (data.update_available) {
                    updateIconEl.innerHTML = '<i class="bi bi-cloud-arrow-down-fill text-info"></i>';
                    document.getElementById('version-status-message').innerHTML = '<span class="text-info">Update available!</span>';
                    document.getElementById('current-version-text').textContent = data.current_version;
                    document.getElementById('latest-version-text').textContent = data.latest_version;
                    new bootstrap.Modal(document.getElementById('updateModal')).show();
                } else {
                    updateIconEl.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    document.getElementById('version-status-message').innerHTML = '<span class="text-success">Up to date.</span>';
                }
            }).catch(error => { updateIconEl.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>'; });

           
            const downloadIcon = document.getElementById('nav-download-link').querySelector('i');
            const downloadBadge = document.getElementById('nav-download-badge');
            let lastQueueCount = 0;

            function updateQueueCount() {
                fetch('/api/get_queue_count').then(response => response.json()).then(data => {
                    const count = data.count || 0;
                    if (count > 0) {
                        downloadBadge.textContent = count;
                        downloadBadge.classList.remove('d-none');
                    } else {
                        downloadBadge.classList.add('d-none');
                    }
                    if (count > lastQueueCount) {
                        downloadIcon.classList.add('bounce-wave');
                        setTimeout(() => { downloadIcon.classList.remove('bounce-wave'); }, 500);
                    }
                    lastQueueCount = count;
                }).catch(error => console.error("Queue count check failed:", error));
            }
            setInterval(updateQueueCount, 5000);
            updateQueueCount();
        });
        {% endif %}

        function copyCommand() {
            navigator.clipboard.writeText("pip install --upgrade TubeZ").then(() => {
                const copyButton = document.getElementById('copy-button');
                const original = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
                setTimeout(() => { copyButton.innerHTML = original; }, 2000);
            });
        }
    </script>
</body>
</html>

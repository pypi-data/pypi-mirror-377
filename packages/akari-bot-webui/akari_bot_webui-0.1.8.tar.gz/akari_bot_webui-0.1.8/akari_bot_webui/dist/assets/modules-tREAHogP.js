import{_ as B,c as w,o as c,e as i,w as o,a as n,z as D,d as p,t as u,E as P,J as S,aS as L,h as g,n as R,F as V,x as I,v as z,aU as y,L as d,u as K}from"./index-BP9fQbbJ.js";import{E as U}from"./card-n_P1XWIJ.js";import{E as j,a as N,b as F}from"./table-column-D2LeTroh.js";import{E as O}from"./select-DToAKioT.js";import{E as J}from"./col-Cfkccvd4.js";import{E as v}from"./index-CM8Oi2Kc.js";import"./_initCloneObject-BOtyDZZA.js";import"./isPlainObject-FafzmMnh.js";import"./validator-MEhiVfZu.js";const q={name:"ModulesManager",data(){const{t:e}=K();return{modules:[],searchKeyword:"",loading:!1,debounceTimer:null,currentPage:1,pageSize:10,t:e}},computed:{filteredModules(){let e=this.modules;return this.searchKeyword&&(e=e.filter(a=>a.bind_prefix.toLowerCase().includes(this.searchKeyword.toLowerCase()))),e},pagedModules(){const e=(this.currentPage-1)*this.pageSize,a=e+this.pageSize;return this.filteredModules.slice(e,a)},totalModules(){return this.filteredModules.length}},mounted(){this.refreshData()},methods:{debouncedRefresh(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>this.refreshData(),300)},handleSizeChange(e){this.pageSize=e,this.currentPage=1},handleCurrentChange(e){this.currentPage=e},async refreshData(){this.loading=!0;try{const e=await y.get("/api/modules");e.status===200&&e.data.modules&&(this.modules=Object.entries(e.data.modules).map(([a,r])=>{const l=Object.keys(r).length>0;return{name:a,bind_prefix:r?.bind_prefix||a,desc:r?.desc||"",developers:r?.developers||[],loaded:l,...r}}).sort((a,r)=>a.name.localeCompare(r.name)))}catch(e){d.error(this.$t("message.error.fetch")+e.message)}finally{this.loading=!1}},async getRelatedModules(e){try{return(await y.get(`/api/module/${e}/related`)).data.modules||[]}catch{return d.error(this.$t("message.error.fetch")+error.message),[]}},async handleReload(e){const a=await this.getRelatedModules(e.name);let r="";a.length===0?r=this.t("data.modules.confirm.message.reload"):r=t("data.modules.confirm.message.reload.extra",{modules:a.map(l=>`"${l}"`).join("、")});try{await v.confirm(r,this.t("confirm.warning"),{confirmButtonText:this.t("button.confirm"),cancelButtonText:this.t("button.cancel"),type:"warning"}),(await y.post(`/api/module/${e.name}/reload`)).status===204&&(d.success(this.t("data.modules.message.reload.success")),this.refreshData())}catch(l){if(l==="cancel"||l?.message==="cancel")return;l.response?.status===422?d.error(this.t("data.modules.message.reload.error.failed")):d.error(this.$t("message.error.fetch")+l.message)}},async handleUnload(e){const a=await this.getRelatedModules(e.name);let r="";a.length===0?r=this.t("data.modules.confirm.message.unload"):r=t("data.modules.confirm.message.unload.extra",{modules:a.map(l=>`"${l}"`).join("、")});try{await v.confirm(r,this.t("confirm.warning"),{confirmButtonText:this.t("button.confirm"),cancelButtonText:this.t("button.cancel"),type:"warning"}),(await y.post(`/api/module/${e.name}/unload`)).status===204&&(d.success(this.t("data.modules.message.unload.success")),this.refreshData())}catch(l){if(l==="cancel"||l?.message==="cancel")return;l.response?.status===422?d.error(this.t("data.modules.message.unload.error.failed")):d.error(this.$t("message.error.fetch")+l.message)}},async handleLoad(e){try{(await y.post(`/api/module/${e.name}/load`)).status===204&&(d.success(this.t("data.modules.message.load.success")),this.refreshData())}catch(a){a.response?.status===422?d.error(this.t("data.modules.message.load.error.failed")):d.error(this.$t("message.error.fetch")+a.message)}}}},A={class:"header-container"},G={class:"filter-container"},H={class:"filter-item"},Q={class:"pagination-wrapper"};function W(e,a,r,l,h,m){const _=P,k=S,E=J,f=j,C=O,$=N,M=F,T=U,x=L;return c(),w("div",null,[i(T,{class:"module-card",shadow:"never"},{default:o(()=>[n("div",A,[n("h3",null,[a[2]||(a[2]=n("i",{class:"mdi mdi-puzzle"},null,-1)),p(" "+u(e.$t("data.modules.title")),1)]),i(_,{onClick:m.refreshData,type:"primary",size:"small",style:{float:"right","margin-left":"10px"}},{default:o(()=>[a[3]||(a[3]=n("i",{class:"mdi mdi-refresh"},null,-1)),p(" "+u(e.$t("data.button.refresh")),1)]),_:1},8,["onClick"])]),n("div",G,[i(E,{span:6},{default:o(()=>[n("div",H,[i(k,{modelValue:h.searchKeyword,"onUpdate:modelValue":a[0]||(a[0]=s=>h.searchKeyword=s),placeholder:e.$t("data.modules.input.module_name"),clearable:"",onInput:m.debouncedRefresh,"prefix-icon":e.Search},{prefix:o(()=>[...a[4]||(a[4]=[n("i",{class:"mdi mdi-magnify"},null,-1)])]),_:1},8,["modelValue","placeholder","onInput","prefix-icon"])])]),_:1})]),D((c(),g($,{data:m.pagedModules,style:{width:"100%"},stripe:""},{default:o(()=>[i(f,{label:e.$t("data.modules.table.name"),"min-width":"140"},{default:o(({row:s})=>[n("span",{class:R({unloaded:!s.loaded})},u(s.bind_prefix),3)]),_:1},8,["label"]),i(f,{label:e.$t("data.modules.table.desc"),"min-width":"800"},{default:o(({row:s})=>[p(u(s.desc||"-"),1)]),_:1},8,["label"]),i(f,{label:e.$t("data.modules.table.developers"),"min-width":"400"},{default:o(({row:s})=>[(c(!0),w(V,null,I(s.developers,b=>(c(),g(C,{key:b,type:"info",style:{margin:"2px"}},{default:o(()=>[p(u(b),1)]),_:2},1024))),128))]),_:1},8,["label"]),i(f,{label:e.$t("data.table.status"),"min-width":"100"},{default:o(({row:s})=>[i(C,{type:s.loaded?"success":"danger"},{default:o(()=>[p(u(s.loaded?e.$t("data.modules.tag.loaded"):e.$t("data.modules.tag.unloaded")),1)]),_:2},1032,["type"])]),_:1},8,["label"]),i(f,{label:e.$t("data.table.operation"),"min-width":"240"},{default:o(({row:s})=>[s.loaded?(c(),g(_,{key:0,size:"small",type:"warning",onClick:b=>m.handleReload(s)},{default:o(()=>[a[5]||(a[5]=n("i",{class:"mdi mdi-reload"},null,-1)),p(" "+u(e.$t("data.modules.button.reload")),1)]),_:1},8,["onClick"])):z("",!0),s.loaded?(c(),g(_,{key:1,size:"small",type:"danger",style:{"margin-left":"5px"},onClick:b=>m.handleUnload(s)},{default:o(()=>[a[6]||(a[6]=n("i",{class:"mdi mdi-puzzle-remove"},null,-1)),p(" "+u(e.$t("data.modules.button.unload")),1)]),_:1},8,["onClick"])):(c(),g(_,{key:2,size:"small",type:"success",onClick:b=>m.handleLoad(s)},{default:o(()=>[a[7]||(a[7]=n("i",{class:"mdi mdi-puzzle-plus"},null,-1)),p(" "+u(e.$t("data.modules.button.load")),1)]),_:1},8,["onClick"]))]),_:1},8,["label"])]),_:1},8,["data"])),[[x,h.loading]]),n("div",Q,[m.totalModules>0?(c(),g(M,{key:0,background:"",layout:"prev, pager, next","current-page":h.currentPage,"onUpdate:currentPage":a[1]||(a[1]=s=>h.currentPage=s),"page-size":h.pageSize,total:m.totalModules,style:{"margin-top":"20px"},onCurrentChange:e.handlePageChange},null,8,["current-page","page-size","total","onCurrentChange"])):z("",!0)])]),_:1})])}const oe=B(q,[["render",W],["__scopeId","data-v-ef39780d"]]);export{oe as default};

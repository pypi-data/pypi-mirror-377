<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}Amrita Dashboard - Amrita Bot管理后台{% endblock %}
    </title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="shortcut icon" href="/static/images/Amrita.png" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      :root {
          --primary-color: #3498db;
          --secondary-color: #2980b9;
          --accent-color: #1abc9c;
          --text-color: #333;
          --text-light: #fff;
          --bg-color: #f8f9fa;
          --sidebar-bg: #2c3e50;
          --sidebar-hover: #34495e;
          --header-height: 60px;
          --transition-speed: 0.3s;

          --dark-bg-color: #1a1a1a;
          --dark-text-color: #f0f0f0;
          --dark-sidebar-bg: #121212;
          --dark-sidebar-hover: #1e1e1e;
          --dark-header-bg: #2d2d2d;
          --dark-card-bg: #252525;
          --dark-button-bg: #3b424b;
          --dark-border-color: #444;
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      }

      body {
          background-color: var(--bg-color);
          color: var(--text-color);
          overflow-x: hidden;
      }


      body.dark-mode {
          background-color: var(--dark-bg-color);
          color: var(--dark-text-color);
      }

      body.dark-mode .topbar {
          background: var(--dark-header-bg);
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      body.dark-mode .user-info:hover {
          background: var(--dark-sidebar-hover);
      }

      body.dark-mode .toggle-sidebar:hover {
          background: var(--dark-sidebar-hover);
      }

      body.dark-mode .sidebar {
          background: var(--dark-sidebar-bg);
      }

      body.dark-mode .menu-link:hover,
      body.dark-mode .menu-link.active {
          background: var(--dark-sidebar-hover);
      }

      body.dark-mode .submenu {
          background: rgba(0, 0, 0, 0.3);
      }

      body.dark-mode .submenu-link:hover,
      body.dark-mode .submenu-link.active {
          color: var(--accent-color);
      }

      body.dark-mode .card,
      body.dark-mode .panel {
          background: var(--dark-card-bg);
          border: 1px solid var(--dark-border-color);
      }

      body.dark-mode table {
          background: var(--dark-card-bg);
          color: var(--dark-text-color);
      }

      body.dark-mode table tr:nth-child(even) {
          background-color: rgba(255, 255, 255, 0.05);
      }

      body.dark-mode table th {
          background-color: var(--dark-sidebar-bg);
          border-color: var(--dark-border-color);
      }

      body.dark-mode table td {
          border-color: var(--dark-border-color);
      }

      body.dark-mode input,
      body.dark-mode select,
      body.dark-mode textarea {
          background-color: var(--dark-card-bg);
          color: var(--dark-text-color);
          border-color: var(--dark-border-color);
      }

      body.dark-mode input:focus,
      body.dark-mode select:focus,
      body.dark-mode textarea:focus {
          border-color: var(--accent-color);
          box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25);
      }

      body.dark-mode button:not(.toggle-sidebar):not(.logout-btn) {
          background-color: var(--dark-card-bg);
          color: var(--dark-text-color);
          border-color: var(--dark-border-color);
      }

      body.dark-mode .btn-primary {
          background-color: var(--primary-color);
          border-color: var(--primary-color);
      }

      body.dark-mode .btn-danger {
          background-color: #e74c3c;
          border-color: #e74c3c;
      }

      body.dark-mode .btn-success {
          background-color: #27ae60;
          border-color: #27ae60;
      }

      body.dark-mode .alert {
          background-color: var(--dark-card-bg);
          border-color: var(--dark-border-color);
          color: var(--dark-text-color);
      }


      .dashboard-container {
          display: flex;
          min-height: 100vh;
      }


      .sidebar {
          width: 250px;
          background: var(--sidebar-bg);
          color: var(--text-light);
          transition: width var(--transition-speed);
          overflow-y: auto;
          height: 100vh;
          position: fixed;
          left: 0;
          top: 0;
          z-index: 1000;
      }

      .sidebar.collapsed {
          width: 60px;
      }

      .sidebar-header {
          padding: 20px 15px;
          display: flex;
          align-items: center;
          height: var(--header-height);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar-logo {
          width: 35px;
          height: 35px;
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 10px;
          flex-shrink: 0;
      }

      .sidebar-title {
          font-weight: 600;
          font-size: 18px;
          white-space: nowrap;
          overflow: hidden;
      }

      .sidebar.collapsed .sidebar-title {
          display: none;
      }

      .sidebar-menu {
          padding: 15px 0;
      }

      .menu-item {
          position: relative;
      }

      .menu-link {
          display: flex;
          align-items: center;
          padding: 12px 15px;
          color: var(--text-light);
          text-decoration: none;
          transition: all 0.3s;
          border-left: 3px solid transparent;
      }

      .menu-link:hover, .menu-link.active {
          background: var(--sidebar-hover);
          border-left-color: var(--accent-color);
      }

      .menu-icon {
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-right: 10px;
          flex-shrink: 0;
      }

      .menu-text {
          white-space: nowrap;
          overflow: hidden;
      }

      .sidebar.collapsed .menu-text {
          display: none;
      }

      .menu-arrow {
          margin-left: auto;
          transition: transform 0.3s;
      }

      .sidebar.collapsed .menu-arrow {
          display: none;
      }

      .menu-item.open .menu-arrow {
          transform: rotate(90deg);
      }

      .submenu {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease;
          background: rgba(0, 0, 0, 0.2);
      }

      .menu-item.open .submenu {
          max-height: 500px;
      }

      .submenu-item {
          padding: 10px 15px 10px 45px;
      }

      .submenu-link {
          color: var(--text-light);
          text-decoration: none;
          display: block;
          opacity: 0.8;
          transition: opacity 0.3s;
          font-size: 14px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .submenu-link:hover, .submenu-link.active {
          opacity: 1;
          color: var(--accent-color);
      }

      .sidebar.collapsed .submenu {
          display: none;
      }


      .main-content {
          flex: 1;
          margin-left: 250px;
          transition: margin-left var(--transition-speed);
      }

      .main-content.expanded {
          margin-left: 60px;
      }


      .topbar {
          height: var(--header-height);
          background: #fff;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0 20px;
          position: sticky;
          top: 0;
          z-index: 999;
      }

      .topbar-left {
          display: flex;
          align-items: center;
      }

      .toggle-sidebar {
          background: none;
          border: none;
          color: var(--text-color);
          font-size: 20px;
          cursor: pointer;
          margin-right: 15px;
          padding: 5px;
          border-radius: 4px;
          transition: background 0.3s;
      }

      .toggle-sidebar:hover {
          background: #f0f0f0;
      }

      .topbar-title {
          font-size: 18px;
          font-weight: 600;
          color: var(--primary-color);
      }

      .topbar-right {
          display: flex;
          align-items: center;
      }

      .theme-toggle {
          background: none;
          border: none;
          color: var(--text-color);
          cursor: pointer;
          padding: 5px;
          border-radius: 4px;
          transition: background 0.3s;
          margin-right: 10px;
          font-size: 18px;
      }

      .theme-toggle:hover {
          background: #f0f0f0;
      }

      body.dark-mode .theme-toggle:hover {
          background: var(--dark-sidebar-hover);
      }

      .user-info {
          display: flex;
          align-items: center;
          cursor: pointer;
          padding: 5px 10px;
          border-radius: 20px;
          transition: background 0.3s;
      }

      .user-info:hover {
          background: #f0f0f0;
      }

      .user-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          margin-right: 10px;
      }

      .user-name {
          margin-right: 10px;
          font-size: 14px;
      }

      .logout-btn {
          background: none;
          border: none;
          color: var(--text-color);
          cursor: pointer;
          padding: 5px;
          border-radius: 4px;
          transition: background 0.3s;
      }

      .logout-btn:hover {
          background: #f0f0f0;
      }


      .loading-bar {
          position: fixed;
          top: 0;
          left: 0;
          width: 0%;
          height: 3px;
          background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
          z-index: 9999;
          transition: width 0.3s ease;
          box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
      }

      .loading-bar.hidden {
          opacity: 0;
          transition: opacity 0.3s ease;
      }


      .content {
          padding: 20px;
      }


      .card {
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          padding: 20px;
          margin-bottom: 20px;
          transition: box-shadow 0.3s;
      }

      .card:hover {
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .card-header {
          border-bottom: 1px solid #eee;
          padding-bottom: 15px;
          margin-bottom: 15px;
      }

      .card-title {
          font-size: 20px;
          font-weight: 600;
          margin: 0;
          color: var(--primary-color);
      }


      table {
          width: 100%;
          border-collapse: collapse;
          background: #fff;
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      table th,
      table td {
          padding: 12px 15px;
          text-align: left;
          border-bottom: 1px solid #eee;
      }

      table th {
          background-color: #f8f9fa;
          font-weight: 600;
          color: #555;
      }

      table tr:last-child td {
          border-bottom: none;
      }

      table tr:nth-child(even) {
          background-color: #f8f9fa;
      }


      button {
          padding: 8px 16px;
          border-radius: 4px;
          border: 1px solid #ddd;
          cursor: pointer;
          font-size: 14px;
          transition: all 0.3s;
      }

      .btn-primary {
          background-color: var(--primary-color);
          color: white;
          border-color: var(--primary-color);
      }

      .btn-primary:hover {
          background-color: #2980b9;
          border-color: #2980b9;
      }

      .btn-danger {
          background-color: #e74c3c;
          color: white;
          border-color: #e74c3c;
      }

      .btn-danger:hover {
          background-color: #c0392b;
          border-color: #c0392b;
      }

      .btn-success {
          background-color: #27ae60;
          color: white;
          border-color: #27ae60;
      }

      .btn-success:hover {
          background-color: #219653;
          border-color: #219653;
      }


      input,
      select,
      textarea {
          padding: 8px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
          transition: border-color 0.3s;
      }

      input:focus,
      select:focus,
      textarea:focus {
          outline: none;
          border-color: var(--accent-color);
          box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25);
      }

      .form-group {
          margin-bottom: 15px;
      }

      .form-label {
          display: block;
          margin-bottom: 5px;
          font-weight: 500;
      }


      .alert {
          padding: 12px 15px;
          border-radius: 4px;
          margin-bottom: 20px;
      }

      .alert-success {
          background-color: #d4edda;
          border: 1px solid #c3e6cb;
          color: #155724;
      }

      .alert-danger {
          background-color: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
      }

      .alert-warning {
          background-color: #fff3cd;
          border: 1px solid #ffeaa7;
          color: #856404;
      }


      @media (max-width: 768px) {
          .sidebar {
              width: 0;
              overflow-x: hidden;
          }

          .sidebar.mobile-open {
              width: 250px;
          }

          .sidebar-title, .menu-text, .submenu {
              display: block;
          }

          .sidebar.collapsed .sidebar-title,
          .sidebar.collapsed .menu-text,
          .sidebar.collapsed .submenu {
              display: none;
          }

          .main-content {
              margin-left: 0;
          }

          .sidebar-overlay {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0, 0, 0, 0.5);
              z-index: 999;
          }

          .sidebar-overlay.open {
              display: block;
          }
      }

      @media (min-width: 769px) {
          .sidebar-overlay {
              display: none !important;
          }
      }

      @media (max-width: 480px) {
          .topbar {
              padding: 0 10px;
          }

          .user-name {
              display: none;
          }
      }


      {% block extra_css %}{% endblock %}
    </style>
    {% block head_extra %}{% endblock %}
  </head>
  <body>
    <div class="loading-bar" id="loadingBar"></div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="dashboard-container">
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-robot"></i>
          </div>
          <div class="sidebar-title">Amrita Dashboard</div>
        </div>
        <div class="sidebar-menu">
          {% for item in sidebar_items %}
          <div class="menu-item">
            <a
              href="{{ item.url }}"
              class="menu-link{% if item.active %} active{% endif %}"
            >
              <div class="menu-icon">
                <i class="{{ item.icon }}"></i>
              </div>
              <div class="menu-text">{{ item.name }}</div>
              {% if item.children %}
              <div class="menu-arrow">
                <i class="fas fa-chevron-right"></i>
              </div>
              {% endif %}
            </a>
            {% if item.children %}
            <div class="submenu">
              {% for child in item.children %}
              <div class="submenu-item">
                <a
                  href="{{ child.url }}"
                  class="submenu-link{% if child.active %} active{% endif %}"
                  >{{ child.name }}</a
                >
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="main-content">
        <div class="topbar">
          <div class="topbar-left">
            <button class="toggle-sidebar">
              <i class="fas fa-bars"></i>
            </button>
            <div class="topbar-title">
              {% block topbar_title %}控制台{% endblock %}
            </div>
          </div>
          <div class="topbar-right">
            <button class="theme-toggle" id="themeToggle" title="切换主题">
              <i class="fas fa-moon"></i>
            </button>
            <div class="user-info">
              <div class="user-avatar">A</div>
              <div class="user-name">Admin</div>
            </div>
            <form action="/logout" method="post">
              <button type="submit" class="logout-btn" title="退出登录">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </form>
          </div>
        </div>
        <div class="content">{% block content %}{% endblock %}</div>
      </div>
    </div>
    <script>
      const loadingBar = document.getElementById("loadingBar");

      function showLoading() {
        loadingBar.style.width = "30%";
        loadingBar.classList.remove("hidden");
      }

      function updateLoading(progress) {
        loadingBar.style.width = progress + "%";
      }

      function hideLoading() {
        loadingBar.style.width = "100%";
        setTimeout(() => {
          loadingBar.classList.add("hidden");
          loadingBar.style.width = "0%";
        }, 300);
      }

      showLoading();

      let progress = 30;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 90) {
          progress = 90;
          clearInterval(interval);
        }
        updateLoading(progress);
      }, 200);

      window.addEventListener("load", () => {
        clearInterval(interval);
        hideLoading();
      });

      document
        .querySelector(".toggle-sidebar")
        .addEventListener("click", function () {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebarOverlay");

          if (window.innerWidth <= 768) {
            sidebar.classList.toggle("mobile-open");
            overlay.classList.toggle("open");
          } else {
            sidebar.classList.toggle("collapsed");
            document
              .querySelector(".main-content")
              .classList.toggle("expanded");
          }
        });

      document
        .getElementById("sidebarOverlay")
        .addEventListener("click", function () {
          this.classList.remove("open");
          document.getElementById("sidebar").classList.remove("mobile-open");
        });

      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (window.innerWidth > 768) {
          sidebar.classList.remove("mobile-open");
          overlay.classList.remove("open");
        }
      });

      document.querySelectorAll(".menu-link").forEach((link) => {
        link.addEventListener("click", function (e) {
          const parentItem = this.parentElement;
          const submenu = parentItem.querySelector(".submenu");
          const arrow = parentItem.querySelector(".menu-arrow");

          if (submenu) {
            e.preventDefault();
            parentItem.classList.toggle("open");
          }
        });
      });

      function checkTokenExpired() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get("token_expired") === "true") {
          Swal.fire({
            title: "认证失效",
            text: "您的登录会话已过期，请重新登录。",
            icon: "warning",
            confirmButtonText: "确定",
          });
        }
      }

      function setTheme(theme) {
        if (theme === "dark") {
          document.body.classList.add("dark-mode");
          document.getElementById("themeToggle").innerHTML =
            '<i class="fas fa-sun"></i>';
          localStorage.setItem("theme", "dark");
        } else {
          document.body.classList.remove("dark-mode");
          document.getElementById("themeToggle").innerHTML =
            '<i class="fas fa-moon"></i>';
          localStorage.setItem("theme", "light");
        }
      }

      function toggleTheme() {
        if (document.body.classList.contains("dark-mode")) {
          setTheme("light");
        } else {
          setTheme("dark");
        }
      }

      function detectSystemTheme() {
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          return "dark";
        }
        return "light";
      }

      function initTheme() {
        const savedTheme = localStorage.getItem("theme");

        if (savedTheme) {
          setTheme(savedTheme);
        } else {
          const systemTheme = detectSystemTheme();
          setTheme(systemTheme);
        }

        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            if (!localStorage.getItem("theme")) {
              setTheme(e.matches ? "dark" : "light");
            }
          });
      }

      document.addEventListener("DOMContentLoaded", function () {
        initTheme();

        document
          .getElementById("themeToggle")
          .addEventListener("click", toggleTheme);

        checkTokenExpired();
      });
      async function getOnetimeToken() {
        let token;
        const response = await fetch("/api/auth/otk");
        if (response.ok) {
          const data = await response.json();
          token = data.token;
        } else {
          Swal.fire({
            title: "错误",
            text: "获取一次性令牌失败，请稍后再试。",
            icon: "error",
            confirmButtonText: "确定",
          });
        }
        return token;
      }
    </script>
    {% block scripts %} {% endblock %}
  </body>
</html>

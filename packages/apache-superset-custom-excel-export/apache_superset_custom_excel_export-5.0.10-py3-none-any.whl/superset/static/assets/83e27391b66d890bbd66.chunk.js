"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[4147],{44147:(e,t,o)=>{o.r(t),o.d(t,{default:()=>M,getLayer:()=>A,getPoints:()=>P});var a=o(2445),i=o(82101),n=o(1334),r=o(48928),s=o(12965),l=o(66341),c=o(83391),p=o(75077),d=o(23197),u=o(83102);const g={name:"screenGrid",vs:"uniform screenGridUniforms {\n  vec2 cellSizeClipspace;\n  vec2 gridSizeClipspace;\n  vec2 colorDomain;\n} screenGrid;\n",uniformTypes:{cellSizeClipspace:"vec2<f32>",gridSizeClipspace:"vec2<f32>",colorDomain:"vec2<f32>"}};class h extends p.A{getShaders(){return super.getShaders({vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\nin vec2 positions;\nin vec2 instancePositions;\nin float instanceWeights;\nin vec3 instancePickingColors;\nuniform sampler2D colorRange;\nout vec4 vColor;\nvec4 interp(float value, vec2 domain, sampler2D range) {\nfloat r = (value - domain.x) / (domain.y - domain.x);\nreturn texture(range, vec2(r, 0.5));\n}\nvoid main(void) {\nif (isnan(instanceWeights)) {\ngl_Position = vec4(0.);\nreturn;\n}\nvec2 pos = instancePositions * screenGrid.gridSizeClipspace + positions * screenGrid.cellSizeClipspace;\npos.x = pos.x - 1.0;\npos.y = 1.0 - pos.y;\ngl_Position = vec4(pos, 0., 1.);\nvColor = interp(instanceWeights, screenGrid.colorDomain, colorRange);\nvColor.a *= layer.opacity;\npicking_setPickingColor(instancePickingColors);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\nprecision highp float;\nin vec4 vColor;\nout vec4 fragColor;\nvoid main(void) {\nfragColor = vColor;\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[d.A,g]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:2,type:"float32",accessor:"getBin"},instanceWeights:{size:1,type:"float32",accessor:"getWeight"}}),this.state.model=this._getModel()}updateState(e){super.updateState(e);const{props:t,oldProps:o,changeFlags:a}=e,i=this.state.model;if(o.colorRange!==t.colorRange){this.state.colorTexture?.destroy(),this.state.colorTexture=(0,u.cp)(this.context.device,t.colorRange,t.colorScaleType);const e={colorRange:this.state.colorTexture};i.shaderInputs.setProps({screenGrid:e})}else o.colorScaleType!==t.colorScaleType&&(0,u.Pu)(this.state.colorTexture,t.colorScaleType);if(o.cellMarginPixels!==t.cellMarginPixels||o.cellSizePixels!==t.cellSizePixels||a.viewportChanged){const{width:e,height:t}=this.context.viewport,{cellSizePixels:o,cellMarginPixels:a}=this.props,n=Math.max(o-a,0),r={gridSizeClipspace:[o/e*2,o/t*2],cellSizeClipspace:[n/e*2,n/t*2]};i.shaderInputs.setProps({screenGrid:r})}}finalizeState(e){super.finalizeState(e),this.state.colorTexture?.destroy()}draw({uniforms:e}){const t=this.props.colorDomain(),o=this.state.model,a={colorDomain:t};o.shaderInputs.setProps({screenGrid:a}),o.draw(this.context.renderPass)}_getModel(){return new l.K(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new c.V({topology:"triangle-strip",attributes:{positions:{value:new Float32Array([0,0,1,0,0,1,1,1]),size:2}}}),isInstanced:!0})}}h.layerName="ScreenGridCellLayer";const f=h,m={name:"binOptions",vs:"uniform binOptionsUniforms {\n  float cellSizePixels;\n} binOptions;\n",uniformTypes:{cellSizePixels:"f32"}},v={cellSizePixels:{type:"number",value:100,min:1},cellMarginPixels:{type:"number",value:2,min:0},colorRange:u.QO,colorScaleType:"linear",getPosition:{type:"accessor",value:e=>e.position},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM"};class y extends s.A{getAggregatorType(){return this.props.gpuAggregation&&n.V.isSupported(this.context.device)?"gpu":"cpu"}createAggregator(e){return"cpu"!==e&&n.V.isSupported(this.context.device)?new n.V(this.context.device,{dimensions:2,channelCount:1,bufferLayout:this.getAttributeManager().getBufferLayouts({isInstanced:!1}),...super.getShaders({modules:[i.A,m],vs:"\n  in vec3 positions;\n  in vec3 positions64Low;\n  in float counts;\n  \n  void getBin(out ivec2 binId) {\n    vec4 pos = project_position_to_clipspace(positions, positions64Low, vec3(0.0));\n    vec2 screenCoords = vec2(pos.x / pos.w + 1.0, 1.0 - pos.y / pos.w) / 2.0 * project.viewportSize / project.devicePixelRatio;\n    vec2 gridCoords = floor(screenCoords / binOptions.cellSizePixels);\n    binId = ivec2(gridCoords);\n  }\n  void getValue(out float weight) {\n    weight = counts;\n  }\n  "})}):new r.M({dimensions:2,getBin:{sources:["positions"],getValue:({positions:e},t,o)=>{const a=this.context.viewport,i=a.project(e),n=o.cellSizePixels;return i[0]<0||i[0]>=a.width||i[1]<0||i[1]>=a.height?null:[Math.floor(i[0]/n),Math.floor(i[1]/n)]}},getValue:[{sources:["counts"],getValue:({counts:e})=>e}]})}initializeState(){super.initializeState(),this.getAttributeManager().add({positions:{size:3,accessor:"getPosition",type:"float64",fp64:this.use64bitPositions()},counts:{size:1,accessor:"getWeight"}})}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState(e){const t=super.updateState(e),{props:o,oldProps:a,changeFlags:i}=e,{cellSizePixels:r,aggregation:s}=o;if(t||i.dataChanged||i.updateTriggersChanged||i.viewportChanged||s!==a.aggregation||r!==a.cellSizePixels){const{width:e,height:t}=this.context.viewport,{aggregator:o}=this.state;o instanceof n.V&&o.setProps({binIdRange:[[0,Math.ceil(e/r)],[0,Math.ceil(t/r)]]}),o.setProps({pointCount:this.getNumInstances(),operations:[s],binOptions:{cellSizePixels:r}})}return i.viewportChanged&&this.state.aggregator.setNeedsUpdate(),t}onAttributeChange(e){const{aggregator:t}=this.state;switch(e){case"positions":t.setNeedsUpdate();break;case"counts":t.setNeedsUpdate(0)}}renderLayers(){const{aggregator:e}=this.state,t=this.getSubLayerClass("cells",f),o=e.getBins(),a=e.getResult(0);return new t(this.props,this.getSubLayerProps({id:"cell-layer"}),{data:{length:e.binCount,attributes:{getBin:o,getWeight:a}},dataComparator:(e,t)=>e.length===t.length,updateTriggers:{getBin:[o],getWeight:[a]},parameters:{depthWriteEnabled:!1,...this.props.parameters},colorDomain:()=>this.props.colorDomain||e.getResultDomain(0),extensions:[]})}getPickingInfo(e){const t=e.info,{index:o}=t;if(o>=0){const e=this.state.aggregator.getBin(o);let a;e&&(a={col:e.id[0],row:e.id[1],value:e.value[0],count:e.count},e.pointIndices&&(a.pointIndices=e.pointIndices,a.points=Array.isArray(this.props.data)?e.pointIndices.map((e=>this.props.data[e])):[])),t.object=a}return t}}y.layerName="ScreenGridLayer",y.defaultProps=v;const b=y;var C=o(95579),x=o(94963),S=o(19375),_=o(25564),w=o(68291),D=o(32548),k=o(47823);function P(e){return e.map((e=>e.position))}function z(e){var t,o,i;return(0,a.FD)("div",{className:"deckgl-tooltip",children:[(0,a.Y)(D.A,{label:(0,C.t)("Longitude and Latitude")+": ",value:`${null==e||null==(t=e.coordinate)?void 0:t[0]}, ${null==e||null==(o=e.coordinate)?void 0:o[1]}`}),(0,a.Y)(D.A,{label:(0,C.t)("Weight")+": ",value:`${null==(i=e.object)?void 0:i.value}`})]})}const A=function({formData:e,setDataMask:t,filterState:o,onContextMenu:a,payload:i,setTooltip:n,emitCrossFilters:r}){const s=e,l=s.color_scheme,c=x.getScale(l);let p=i.data.features;s.js_data_mutator&&(p=(0,_.A)(s.js_data_mutator)(p));const d=s.color_scheme_type,u=(0,w.XC)({defaultBreakpointsColor:s.deafult_breakpoint_color,colorBreakpoints:s.color_breakpoints,fixedColor:s.color_picker,colorSchemeType:d,colorScale:c});return new b({id:`screengrid-layer-${s.slice_id}`,data:p,cellSizePixels:s.grid_size,colorDomain:d===S.wP.color_breakpoints&&u?[0,u.length]:void 0,colorRange:"default"===d?[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]]:u,outline:!1,...(0,w.T$)({formData:s,setDataMask:t,setTooltip:n,setTooltipContent:z,filterState:o,onContextMenu:a,emitCrossFilters:r}),getWeight:e=>e.weight||0,colorScaleType:"default"===d?"linear":"quantize"})},M=(0,k.y)(A,P)},47823:(e,t,o)=>{o.d(t,{c:()=>S,y:()=>x});var a=o(2404),i=o.n(a),n=o(2445),r=o(96540),s=o(83505),l=o(70957),c=o(94963),p=o(66671),d=o(49443),u=o(25564),g=o(95490),h=o(19375),f=o(49672),m=o(55602);const{getScale:v}=c;function y(e,t){const o=e.color_picker||{r:0,g:0,b:0,a:1},a=[o.r,o.g,o.b,255*o.a],i=e.color_scheme,n=v(i);let r={};return e.color_scheme_type===h.wP.color_breakpoints?r=(0,f.BK)(e.color_breakpoints):t.forEach((t=>{if(null!=t.cat_color&&!r.hasOwnProperty(t.cat_color)){let i;i=e.dimension?(0,d.hexToRGB)(n(t.cat_color,e.sliceId),255*o.a):a,r[t.cat_color]={color:i,enabled:!0}}})),r}const b=e=>{const t=(0,r.useRef)(null),o=(0,r.useCallback)((()=>{let t={...e.viewport};return e.formData.autozoom&&(t=(0,g.A)(t,{width:e.width,height:e.height,points:e.getPoints(e.payload.data.features||[])})),t.zoom<0&&(t.zoom=0),t}),[e]),[a,i]=(0,r.useState)(y(e.formData,e.payload.data.features||[])),[s,c]=(0,r.useState)(e.payload.form_data),[f,b]=(0,r.useState)(o());(0,r.useEffect)((()=>{if(e.payload.form_data!==s){const t=e.payload.data.features||[],a=y(e.formData,t);b(o()),c(e.payload.form_data),i(a)}}),[o,e,s]);const C=(0,r.useCallback)((e=>{const{current:o}=t;o&&o.setTooltip(e)}),[]),x=(0,r.useCallback)(((e,t,o)=>{const a=t.color_scheme,i=v(a);let n;switch(o){case h.wP.fixed_color:return n=t.color_picker||{r:0,g:0,b:0,a:100},e.map((e=>({...e,color:[n.r,n.g,n.b,255*n.a]})));case h.wP.categorical_palette:return e.map((e=>({...e,color:(0,d.hexToRGB)(i(e.cat_color,t.slice_id))})));case h.wP.color_breakpoints:{const o=t.deafult_breakpoint_color?[t.deafult_breakpoint_color.r,t.deafult_breakpoint_color.g,t.deafult_breakpoint_color.b,255*t.deafult_breakpoint_color.a]:[m.DL.r,m.DL.g,m.DL.b,255*m.DL.a];return e.map((e=>{var a;const i=null==(a=t.color_breakpoints)?void 0:a.find((t=>e.metric>=t.minValue&&e.metric<=t.maxValue));return{...e,color:i?[null==i?void 0:i.color.r,null==i?void 0:i.color.g,null==i?void 0:i.color.b,255*(null==i?void 0:i.color.a)]:o}}))}default:return[]}}),[]),S=(0,r.useCallback)((()=>{const{getLayer:t,payload:o,formData:i,onAddFilter:n,onContextMenu:r,filterState:s,setDataMask:l,emitCrossFilters:c}=e;let p=o.data.features?[...o.data.features]:[];const d=i.color_scheme_type;return p=x(p,i,d),i.js_data_mutator&&(p=(0,u.A)(i.js_data_mutator)(p)),i.dimension&&(p=p.filter((e=>{var t;return null==(t=a[e.cat_color])?void 0:t.enabled}))),[t({formData:i,payload:{...o,data:{...o.data,features:p}},onAddFilter:n,setTooltip:C,datasource:e.datasource,onContextMenu:r,filterState:s,setDataMask:l,emitCrossFilters:c})]}),[x,a,e,C]),_=(0,r.useCallback)((e=>{const t=a[e],o={...a,[e]:{...t,enabled:!t.enabled}};Object.values(o).every((e=>!e.enabled))&&Object.values(o).forEach((e=>{e.enabled=!0})),i(o)}),[a]),w=(0,r.useCallback)((e=>{const t={...a};Object.values(t).forEach((e=>{e.enabled=!1})),t[e].enabled=!0,i(t)}),[a]);return(0,n.FD)("div",{style:{position:"relative"},children:[(0,n.Y)(l.S,{ref:t,viewport:f,layers:S(),setControlValue:e.setControlValue,mapStyle:e.formData.mapbox_style,mapboxApiAccessToken:e.mapboxApiKey,width:e.width,height:e.height}),(0,n.Y)(p.A,{forceCategorical:!0,categories:a,format:e.formData.legend_format,position:e.formData.legend_position,showSingleCategory:w,toggleCategory:_})]})},C=(0,r.memo)(b);function x(e,t){return(0,r.memo)((o=>{const a=(0,r.useRef)(),c=(0,s.Z)(o.formData),d=(0,s.Z)(o.filterState),u=(0,s.Z)(o.payload),[h,m]=(0,r.useState)((0,f.BK)(o.formData.color_breakpoints)||[]),[v,y]=(0,r.useState)((()=>{const{width:e,height:a,formData:i}=o;return i.autozoom?(0,g.A)(o.viewport,{width:e,height:a,points:t(o.payload.data.features)}):o.viewport})()),b=(0,r.useCallback)((e=>{const{current:t}=a;t&&(null==t||t.setTooltip(e))}),[]),C=(0,r.useCallback)((t=>{const{formData:o,payload:a,onAddFilter:i,filterState:n,setDataMask:r,onContextMenu:s,emitCrossFilters:l}=t;return e({formData:o,payload:a,onAddFilter:i,setTooltip:b,setDataMask:r,onContextMenu:s,filterState:n,emitCrossFilters:l})}),[b]);(0,r.useEffect)((()=>{const e=(0,f.BK)(o.formData.color_breakpoints);m(e)}),[o]);const[x,S]=(0,r.useState)(C(o));(0,r.useEffect)((()=>{const e={...c,...d,viewport:null},t={...o.formData,...o.filterState,viewport:null};i()(e,t)&&u===o.payload||S(C(o))}),[C,c,d,u,o]);const{formData:_,payload:w,setControlValue:D,height:k,width:P}=o;return(0,n.FD)("div",{style:{position:"relative"},children:[(0,n.Y)(l.S,{ref:a,mapboxApiAccessToken:w.data.mapboxApiKey,viewport:v,layers:[x],mapStyle:_.mapbox_style,setControlValue:D,width:P,height:k,onViewportChange:y}),(0,n.Y)(p.A,{forceCategorical:!0,categories:h,format:o.formData.legend_format,position:o.formData.legend_position})]})}))}function S(e,t){return function(o){const{datasource:a,formData:i,height:r,payload:s,setControlValue:l,viewport:c,width:p,setDataMask:d,filterState:u,onContextMenu:g,emitCrossFilters:h}=o;return(0,n.Y)(C,{datasource:a,formData:i,mapboxApiKey:s.data.mapboxApiKey,setControlValue:l,viewport:c,getLayer:e,payload:s,getPoints:t,width:p,height:r,setDataMask:d,onContextMenu:g,filterState:u,emitCrossFilters:h})}}},66671:(e,t,o)=>{o.d(t,{A:()=>p});var a=o(2445),i=o(96540),n=o(72234),r=o(32142);const s=n.I4.div`
  ${({theme:e})=>`\n    font-size: ${e.fontSizeSM}px;\n    position: absolute;\n    background: ${e.colors.grayscale.light5};\n    box-shadow: 0 0 ${e.sizeUnit}px ${e.colors.grayscale.light2};\n    margin: ${6*e.sizeUnit}px;\n    padding: ${3*e.sizeUnit}px ${5*e.sizeUnit}px;\n    outline: none;\n    overflow-y: scroll;\n    max-height: 200px;\n\n    & ul {\n      list-style: none;\n      padding-left: 0;\n      margin: 0;\n\n      & li a {\n        display: flex;\n        color: ${e.colors.grayscale.base};\n        text-decoration: none;\n        padding: ${e.sizeUnit}px 0;\n\n        & span {\n          margin-right: ${e.sizeUnit}px;\n        }\n      }\n    }\n  `}
`,l=" - ",c=({format:e=null,forceCategorical:t=!1,position:o="tr",categories:i={},toggleCategory:n=()=>{},showSingleCategory:c=()=>{}})=>{const p=o=>{if(!e||t)return o;const a=parseFloat(o);return(0,r.ZV)(e,a)},d=t=>{if(!e)return t;if(t.includes(l)){const e=t.split(l);return p(e[0])+l+p(e[1])}return p(t)};if(0===Object.keys(i).length||null===o)return null;const u=Object.entries(i).map((([e,t])=>{var o;const i={color:`rgba(${null==(o=t.color)?void 0:o.join(", ")})`},r=t.enabled?"◼":"◻";return(0,a.Y)("li",{children:(0,a.FD)("a",{href:"#",role:"button",onClick:()=>n(e),onDoubleClick:()=>c(e),children:[(0,a.Y)("span",{style:i,children:r})," ",d(e)]})},e)})),g="t"===(null==o?void 0:o.charAt(0))?"top":"bottom",h="r"===(null==o?void 0:o.charAt(1))?"right":"left",f={position:"absolute",[g]:"0px",[h]:"10px"};return(0,a.Y)(s,{className:"dupa",style:f,children:(0,a.Y)("ul",{children:u})})},p=(0,i.memo)(c)}}]);
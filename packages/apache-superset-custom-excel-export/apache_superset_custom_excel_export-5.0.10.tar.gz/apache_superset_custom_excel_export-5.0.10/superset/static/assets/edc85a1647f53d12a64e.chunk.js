"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[8334],{38736:(e,t,s)=>{s.d(t,{I:()=>r});var a=s(35742),i=s(95579),o=s(58561),n=s.n(o);const r=async({endpoint:e,pageSize:t=100,setData:s,filters:o,setLoadingState:r,loadingKey:l,addDangerToast:d,errorMessage:u="Error while fetching data",mapResult:c=e=>e})=>{try{const i=async s=>{const i={page_size:t,page:s};o&&(i.filters=o);const r=n().encode(i),l=await a.A.get({endpoint:`${e}?q=${r}`});return{count:l.json.count,results:l.json.result.map(c)}},r=await i(0),l=r.count,d=r.results;if(t>=l)return void s(d);const u=Math.ceil(l/t),m=Array.from({length:u-1},((e,t)=>i(t+1))),p=await Promise.all(m);s([...d,...p.flatMap((e=>e.results))])}catch(e){d((0,i.t)(u))}finally{r((e=>"boolean"!=typeof e&&{...e,[l]:!1}))}}},51383:(e,t,s)=>{s.r(t),s.d(t,{default:()=>O});var a=s(2445),i=s(96540),o=s(95579),n=s(35742),r=s(50500),l=s(70856),d=s(5261),u=s(79633),c=s(38380);const m=async e=>n.A.post({endpoint:"/api/v1/security/roles/",jsonPayload:{name:e}}),p=async(e,t)=>n.A.post({endpoint:`/api/v1/security/roles/${e}/permissions`,jsonPayload:{permission_view_menu_ids:t}}),y=async(e,t)=>n.A.put({endpoint:`/api/v1/security/roles/${e}/users`,jsonPayload:{user_ids:t}}),h=async(e,t)=>n.A.put({endpoint:`/api/v1/security/roles/${e}/groups`,jsonPayload:{group_ids:t}}),g=async(e,t)=>n.A.put({endpoint:`/api/v1/security/roles/${e}`,jsonPayload:{name:t}});var v=s(56268),b=s(17355),f=s(71781),S=s(25729),w=s(97560);const D=()=>(0,a.Y)(v.e,{name:"roleName",label:(0,o.t)("Role Name"),rules:[{required:!0,message:(0,o.t)("Role name is required")}],children:(0,a.Y)(b.A,{name:"roleName","data-test":"role-name-input"})}),Y=({permissions:e})=>(0,a.Y)(v.e,{name:"rolePermissions",label:(0,o.t)("Permissions"),children:(0,a.Y)(f.A,{mode:"multiple",name:"rolePermissions",options:e.map((e=>({label:e.label,value:e.id}))),getPopupContainer:e=>e.closest(".ant-modal-content"),"data-test":"permissions-select"})}),T=({addDangerToast:e,loading:t})=>(0,a.Y)(v.e,{name:"roleUsers",label:(0,o.t)("Users"),children:(0,a.Y)(S.A,{name:"roleUsers",mode:"multiple",placeholder:(0,o.t)("Select users"),options:(t,s,a)=>(0,w.cm)(t,s,a,e),loading:t,"data-test":"roles-select"})}),A=({groups:e})=>(0,a.Y)(v.e,{name:"roleGroups",label:(0,o.t)("Groups"),children:(0,a.Y)(f.A,{mode:"multiple",name:"roleGroups",options:e.map((e=>({label:e.name,value:e.id}))),"data-test":"groups-select"})}),k=function({show:e,onHide:t,onSave:s,permissions:i}){const{addDangerToast:n,addSuccessToast:r}=(0,d.Yf)();return(0,a.Y)(u.k,{show:e,onHide:t,name:"Add Role",title:(0,a.Y)(l.r,{title:(0,o.t)("Add Role"),icon:(0,a.Y)(c.F.PlusOutlined,{})}),onSave:s,formSubmitHandler:async e=>{try{var t;const{json:s}=await m(e.roleName);(null==(t=e.rolePermissions)?void 0:t.length)>0&&await p(s.id,e.rolePermissions),r((0,o.t)("The role has been created successfully."))}catch(e){throw n((0,o.t)("There was an error creating the role. Please, try again.")),e}},requiredFields:["roleName"],initialValues:{},children:(0,a.FD)(a.FK,{children:[(0,a.Y)(D,{}),(0,a.Y)(Y,{permissions:i})]})})};var C=s(63393),_=s(69031),P=s(38736);const H={edit:{key:"edit",name:(0,o.t)("Edit Role")},users:{key:"users",name:(0,o.t)("Users")}},F=[{accessor:"first_name",Header:(0,o.t)("First Name"),id:"first_name"},{accessor:"last_name",Header:(0,o.t)("Last Name"),id:"last_name"},{accessor:"username",Header:(0,o.t)("User Name"),id:"username"},{accessor:"email",Header:(0,o.t)("Email"),id:"email"},{accessor:"active",Header:(0,o.t)("Is Active?"),Cell:({value:e})=>e?(0,o.t)("Yes"):(0,o.t)("No"),id:"active"}],E=function({show:e,onHide:t,role:s,onSave:n,permissions:r,groups:m}){const{id:v,name:b,permission_ids:f,user_ids:S,group_ids:w}=s,[k,E]=(0,i.useState)(H.edit.key),{addDangerToast:R,addSuccessToast:N}=(0,d.Yf)(),[j,$]=(0,i.useState)([]),[U,I]=(0,i.useState)(!0),L=(0,i.useRef)(null);(0,i.useEffect)((()=>{if(!S.length)return $([]),void I(!1);const e=[{col:"id",opr:"in",value:S}];(0,P.I)({endpoint:"/api/v1/security/users/",pageSize:100,setData:$,filters:e,setLoadingState:e=>I(e),loadingKey:"roleUsers",addDangerToast:R,errorMessage:(0,o.t)("There was an error loading users."),mapResult:e=>({id:e.id,username:e.username})})}),[S]),(0,i.useEffect)((()=>{if(!U&&L.current&&j.length>=0){const e=j.map((e=>({value:e.id,label:e.username})));L.current.setFieldsValue({roleUsers:e})}}),[U,j]);const M={roleName:b,rolePermissions:f,roleUsers:(null==j?void 0:j.map((e=>({value:e.id,label:e.username}))))||[],roleGroups:w};return(0,a.Y)(u.k,{show:e,onHide:t,name:"Edit Role",title:(0,a.Y)(l.r,{title:(0,o.t)("Edit Role"),icon:(0,a.Y)(c.F.EditOutlined,{})}),onSave:n,formSubmitHandler:async e=>{try{var t;const s=(null==(t=e.roleUsers)?void 0:t.map((e=>e.value)))||[];await Promise.all([g(v,e.roleName),p(v,e.rolePermissions),y(v,s),h(v,e.roleGroups)]),N((0,o.t)("The role has been updated successfully."))}catch(e){throw R((0,o.t)("There was an error updating the role. Please, try again.")),e}},initialValues:M,bodyStyle:{height:"400px"},requiredFields:["roleName"],children:e=>(L.current=e,(0,a.FD)(C.Ay,{activeKey:k,onChange:e=>E(e),children:[(0,a.Y)(C.Ay.TabPane,{tab:H.edit.name,forceRender:!0,children:(0,a.FD)(a.FK,{children:[(0,a.Y)(D,{}),(0,a.Y)(Y,{permissions:r}),(0,a.Y)(T,{addDangerToast:R,loading:U}),(0,a.Y)(A,{groups:m})]})},H.edit.key),(0,a.Y)(C.Ay.TabPane,{tab:H.users.name,children:(0,a.Y)(_.Q,{columns:F,data:j,emptyWrapperType:_.V.Small})},H.users.key)]}))})},R=function({role:e,show:t,onHide:s,onSave:i}){const{name:n,permission_ids:r}=e,{addDangerToast:y,addSuccessToast:h}=(0,d.Yf)();return(0,a.Y)(u.k,{show:t,onHide:s,name:(0,o.t)("Duplicate role %(name)s",{name:n}),title:(0,a.Y)(l.r,{title:(0,o.t)("Duplicate role %(name)s",{name:n}),icon:(0,a.Y)(c.F.EditOutlined,{})}),onSave:i,formSubmitHandler:async e=>{try{const{json:t}=await m(e.roleName);r.length>0&&await p(t.id,r),h((0,o.t)("The role has been duplicated successfully."))}catch(e){throw y((0,o.t)("There was an error duplicating the role. Please, try again.")),e}},requiredFields:["roleName"],initialValues:{},children:(0,a.Y)(D,{})})};var N,j=s(51713),$=s(27395),U=s(83197),I=s(44344),L=s(65256),M=s(7464);!function(e){e.ADD="add",e.EDIT="edit",e.DUPLICATE="duplicate"}(N||(N={}));const O=(0,d.Ay)((function({addDangerToast:e,addSuccessToast:t,user:s}){const{state:{loading:l,resourceCount:d,resourceCollection:u,bulkSelectEnabled:m},fetchData:p,refreshData:y,toggleBulkSelect:h}=(0,r.RU)("security/roles/search",(0,o.t)("Role"),e,!1),[g,v]=(0,i.useState)({edit:!1,add:!1,duplicate:!1}),b=e=>v((t=>({...t,[e]:!0}))),f=e=>v((t=>({...t,[e]:!1}))),[S,D]=(0,i.useState)(null),[Y,T]=(0,i.useState)(null),[A,C]=(0,i.useState)([]),[_,H]=(0,i.useState)([]),[F,O]=(0,i.useState)({permissions:!0,groups:!0}),K=(0,i.useMemo)((()=>(0,L.N6)(s)),[s]),V=(0,i.useCallback)((()=>{(0,P.I)({endpoint:"/api/v1/security/permissions-resources/",setData:C,setLoadingState:O,loadingKey:"permissions",addDangerToast:e,errorMessage:"Error while fetching permissions",mapResult:({permission:e,view_menu:t,id:s})=>({label:`${e.name.replace(/_/g," ")} ${t.name.replace(/_/g," ")}`,value:`${e.name}__${t.name}`,id:s})})}),[e]),q=(0,i.useCallback)((()=>{(0,P.I)({endpoint:"/api/v1/security/groups/",setData:H,setLoadingState:O,loadingKey:"groups",addDangerToast:e,errorMessage:(0,o.t)("Error while fetching groups")})}),[e]);(0,i.useEffect)((()=>{V()}),[V]),(0,i.useEffect)((()=>{q()}),[q]);const z=[{id:"name",desc:!0}],G=(0,i.useMemo)((()=>[{accessor:"name",id:"name",Header:(0,o.t)("Name"),Cell:({row:{original:{name:e}}})=>(0,a.Y)("span",{children:e})},{accessor:"user_ids",id:"user_ids",Header:(0,o.t)("Users"),hidden:!0,Cell:({row:{original:e}})=>e.user_ids.join(", ")},{accessor:"group_ids",id:"group_ids",Header:(0,o.t)("Groups"),hidden:!0,Cell:({row:{original:e}})=>e.groups_ids.join(", ")},{accessor:"permission_ids",id:"permission_ids",Header:(0,o.t)("Permissions"),hidden:!0,Cell:({row:{original:e}})=>e.permission_ids.join(", ")},{Cell:({row:{original:e}})=>{const t=K?[{label:"role-list-edit-action",tooltip:(0,o.t)("Edit role"),placement:"bottom",icon:"EditOutlined",onClick:()=>{D(e),b(N.EDIT)}},{label:"role-list-duplicate-action",tooltip:(0,o.t)("Duplicate role"),placement:"bottom",icon:"CopyOutlined",onClick:()=>{D(e),b(N.DUPLICATE)}},{label:"role-list-delete-action",tooltip:(0,o.t)("Delete role"),placement:"bottom",icon:"DeleteOutlined",onClick:()=>T(e)}]:[];return(0,a.Y)(I.kv,{actions:t})},Header:(0,o.t)("Actions"),id:"actions",disableSortBy:!0,hidden:!K,size:"xl"}]),[K]),W=[];K&&W.push({icon:(0,a.Y)(c.F.PlusOutlined,{iconSize:"m"}),name:(0,o.t)("Role"),buttonStyle:"primary",onClick:()=>{b(N.ADD)},loading:F.permissions,"data-test":"add-role-button"},{name:(0,o.t)("Bulk select"),onClick:h,buttonStyle:"secondary"});const B=(0,i.useMemo)((()=>[{Header:(0,o.t)("Name"),key:"name",id:"name",input:"search",operator:I.c0.Contains},{Header:(0,o.t)("Users"),key:"user_ids",id:"user_ids",input:"select",operator:I.c0.RelationOneMany,unfilteredLabel:(0,o.t)("All"),fetchSelects:async(t,s,a)=>(0,w.cm)(t,s,a,e),dropdownStyle:{minWidth:M.f8}},{Header:(0,o.t)("Permissions"),key:"permission_ids",id:"permission_ids",input:"select",operator:I.c0.RelationOneMany,unfilteredLabel:(0,o.t)("All"),selects:null==A?void 0:A.map((e=>({label:e.label,value:e.id}))),loading:F.permissions,dropdownStyle:{minWidth:M.f8}},{Header:(0,o.t)("Groups"),key:"group_ids",id:"group_ids",input:"select",operator:I.c0.RelationOneMany,unfilteredLabel:(0,o.t)("All"),selects:null==_?void 0:_.map((e=>({label:e.name,value:e.id}))),loading:F.groups,dropdownStyle:{minWidth:M.f8}}]),[A,_,F.groups,F.permissions]),x={title:(0,o.t)("No roles yet"),image:"filter-results.svg",...K&&{buttonAction:()=>{b(N.ADD)},buttonText:(0,a.FD)(a.FK,{children:[(0,a.Y)(c.F.PlusOutlined,{iconSize:"m"}),(0,o.t)("Role")]})}};return(0,a.FD)(a.FK,{children:[(0,a.Y)(j.A,{name:(0,o.t)("List Roles"),buttons:W}),(0,a.Y)(k,{onHide:()=>f(N.ADD),show:g.add,onSave:()=>{y(),f(N.ADD)},permissions:A}),g.edit&&S&&(0,a.Y)(E,{role:S,show:g.edit,onHide:()=>f(N.EDIT),onSave:()=>{y(),f(N.EDIT)},permissions:A,groups:_}),g.duplicate&&S&&(0,a.Y)(R,{role:S,show:g.duplicate,onHide:()=>f(N.DUPLICATE),onSave:()=>{y(),f(N.DUPLICATE)}}),Y&&(0,a.Y)($.T,{description:(0,o.t)("This action will permanently delete the role."),onConfirm:()=>{Y&&(async({id:s,name:a})=>{try{await n.A.delete({endpoint:`/api/v1/security/roles/${s}`}),y(),T(null),t((0,o.t)("Deleted role: %s",a))}catch(t){e((0,o.t)("There was an issue deleting %s",a))}})(Y)},onHide:()=>T(null),open:!0,title:(0,o.t)("Delete Role?")}),(0,a.Y)(U.h,{title:(0,o.t)("Please confirm"),description:(0,o.t)("Are you sure you want to delete the selected roles?"),onConfirm:async s=>{const a=[];await Promise.all(s.map((async t=>{try{await n.A.delete({endpoint:`api/v1/security/roles/${t.id}`}),a.push(t.name)}catch(s){e((0,o.t)("Error deleting %s",t.name))}}))),a.length>0&&t((0,o.t)("Deleted roles: %s",a.join(", "))),y()},children:s=>{const i=K?[{key:"delete",name:(0,o.t)("Delete"),onSelect:s,type:"danger"}]:[];return(0,a.Y)(I.uO,{className:"role-list-view",columns:G,count:d,data:u,fetchData:p,filters:B,initialSort:z,loading:l,pageSize:25,bulkActions:i,bulkSelectEnabled:m,disableBulkSelect:h,addDangerToast:e,addSuccessToast:t,emptyState:x,refreshData:y})}})]})}))},79633:(e,t,s)=>{s.d(t,{k:()=>d});var a=s(2445),i=s(96540),o=s(95579),n=s(15509),r=s(29221),l=s(84335);function d({show:e,onHide:t,title:s,onSave:d,children:u,initialValues:c={},formSubmitHandler:m,bodyStyle:p={},requiredFields:y=[],name:h}){const[g]=r.l.useForm(),[v,b]=(0,i.useState)(!1),f=(0,i.useCallback)((()=>{g.resetFields(),b(!1)}),[g]),[S,w]=(0,i.useState)(!0),D=(0,i.useCallback)((()=>{f(),t()}),[t,f]),Y=(0,i.useCallback)((()=>{f(),d()}),[d,f]),T=(0,i.useCallback)((async e=>{try{b(!0),await m(e),Y()}catch(e){console.error(e)}finally{b(!1)}}),[m,Y]),A=()=>{const e=g.getFieldsError().some((({errors:e})=>e.length)),t=g.getFieldsValue(),s=y.some((e=>!t[e]));w(e||s)};return(0,a.Y)(l.aF,{name:h,show:e,title:s,onHide:D,bodyStyle:p,footer:(0,a.FD)(a.FK,{children:[(0,a.Y)(n.$,{buttonStyle:"secondary","data-test":"modal-cancel-button",onClick:D,children:(0,o.t)("Cancel")}),(0,a.Y)(n.$,{buttonStyle:"primary",htmlType:"submit",onClick:()=>g.submit(),"data-test":"form-modal-save-button",disabled:v||S,children:v?(0,o.t)("Saving..."):(0,o.t)("Save")})]}),children:(0,a.Y)(r.l,{form:g,layout:"vertical",onFinish:T,initialValues:c,onValuesChange:A,onFieldsChange:A,children:"function"==typeof u?u(g):u})})}},97560:(e,t,s)=>{s.d(t,{Ni:()=>d,cm:()=>u,vW:()=>l,wj:()=>r});var a=s(35742),i=s(95579),o=s(58561),n=s.n(o);const r=async e=>{await a.A.post({endpoint:"/api/v1/security/groups/",jsonPayload:{...e,users:e.users.map((e=>e.value))}})},l=async(e,t)=>{await a.A.put({endpoint:`/api/v1/security/groups/${e}`,jsonPayload:{...t,users:t.users.map((e=>e.value))}})},d=async e=>a.A.delete({endpoint:`/api/v1/security/groups/${e}`}),u=async(e,t,s,o)=>{const r=n().encode({filter:e,page:t,page_size:s,order_column:"username",order_direction:"asc"});try{var l,d,u;const e=await a.A.get({endpoint:`/api/v1/security/users/?q=${r}`});return{data:((null==(l=e.json)?void 0:l.result)||[]).map((e=>({value:e.id,label:e.username}))),totalCount:null!=(d=null==(u=e.json)?void 0:u.count)?d:0}}catch(e){return o((0,i.t)("There was an error while fetching users")),{data:[],totalCount:0}}}}}]);
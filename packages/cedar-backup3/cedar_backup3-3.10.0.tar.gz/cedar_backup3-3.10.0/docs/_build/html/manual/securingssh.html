<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Securing Password-less SSH Connections &#8212; cedar-backup3 3.10.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=6625fa76" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=ec641305" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <script src="../_static/documentation_options.js?v=f8d09eac"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="securing-password-less-ssh-connections">
<span id="cedar-securingssh"></span><h1>Securing Password-less SSH Connections<a class="headerlink" href="#securing-password-less-ssh-connections" title="Link to this heading">¶</a></h1>
<p>Cedar Backup relies on password-less public key SSH connections to make
various parts of its backup process work. Password-less <code class="docutils literal notranslate"><span class="pre">scp</span></code> is used
to stage files from remote clients to the master, and password-less
<code class="docutils literal notranslate"><span class="pre">ssh</span></code> is used to execute actions on managed clients.</p>
<p>Normally, it is a good idea to avoid password-less SSH connections in
favor of using an SSH agent. The SSH agent manages your SSH connections
so that you don’t need to type your passphrase over and over. You get
most of the benefits of a password-less connection without the risk.
Unfortunately, because Cedar Backup has to execute without human
involvement (through a cron job), use of an agent really isn’t feasable.
We have to rely on true password-less public keys to give the master
access to the client peers.</p>
<p>Traditionally, Cedar Backup has relied on a “segmenting” strategy to
minimize the risk. Although the backup typically runs as root — so
that all parts of the filesystem can be backed up — we don’t use the
root user for network connections. Instead, we use a dedicated backup
user on the master to initiate network connections, and dedicated users
on each of the remote peers to accept network connections.</p>
<p>With this strategy in place, an attacker with access to the backup user
on the master (or even root access, really) can at best only get access
to the backup user on the remote peers. We still concede a local attack
vector, but at least that vector is restricted to an unprivileged user.</p>
<p>Some Cedar Backup users may not be comfortable with this risk, and
others may not be able to implement the segmentation strategy — they
simply may not have a way to create a login which is only used for
backups.</p>
<p>Fortunately, there is a solution. The SSH authorized keys file supports
a way to put a “filter” in place on an SSH connection. This excerpt is
from the AUTHORIZED_KEYS FILE FORMAT section of man 8 sshd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="o">=</span><span class="s2">&quot;command&quot;</span>
   <span class="n">Specifies</span> <span class="n">that</span> <span class="n">the</span> <span class="n">command</span> <span class="ow">is</span> <span class="n">executed</span> <span class="n">whenever</span> <span class="n">this</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">used</span> <span class="k">for</span>
   <span class="n">authentication</span><span class="o">.</span>  <span class="n">The</span> <span class="n">command</span> <span class="n">supplied</span> <span class="n">by</span> <span class="n">the</span> <span class="n">user</span> <span class="p">(</span><span class="k">if</span> <span class="nb">any</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ignored</span><span class="o">.</span>  <span class="n">The</span>
   <span class="n">command</span> <span class="ow">is</span> <span class="n">run</span> <span class="n">on</span> <span class="n">a</span> <span class="n">pty</span> <span class="k">if</span> <span class="n">the</span> <span class="n">client</span> <span class="n">requests</span> <span class="n">a</span> <span class="n">pty</span><span class="p">;</span> <span class="n">otherwise</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">run</span>
   <span class="n">without</span> <span class="n">a</span> <span class="n">tty</span><span class="o">.</span>  <span class="n">If</span> <span class="n">an</span> <span class="mi">8</span><span class="o">-</span><span class="n">bit</span> <span class="n">clean</span> <span class="n">channel</span> <span class="ow">is</span> <span class="n">required</span><span class="p">,</span> <span class="n">one</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">request</span>
   <span class="n">a</span> <span class="n">pty</span> <span class="ow">or</span> <span class="n">should</span> <span class="n">specify</span> <span class="n">no</span><span class="o">-</span><span class="n">pty</span><span class="o">.</span>  <span class="n">A</span> <span class="n">quote</span> <span class="n">may</span> <span class="n">be</span> <span class="n">included</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">command</span> <span class="n">by</span>
   <span class="n">quoting</span> <span class="n">it</span> <span class="k">with</span> <span class="n">a</span> <span class="n">backslash</span><span class="o">.</span>  <span class="n">This</span> <span class="n">option</span> <span class="n">might</span> <span class="n">be</span> <span class="n">useful</span> <span class="n">to</span> <span class="n">restrict</span>
   <span class="n">certain</span> <span class="n">public</span> <span class="n">keys</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">just</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">operation</span><span class="o">.</span>  <span class="n">An</span> <span class="n">example</span> <span class="n">might</span>
   <span class="n">be</span> <span class="n">a</span> <span class="n">key</span> <span class="n">that</span> <span class="n">permits</span> <span class="n">remote</span> <span class="n">backups</span> <span class="n">but</span> <span class="n">nothing</span> <span class="k">else</span><span class="o">.</span>  <span class="n">Note</span> <span class="n">that</span> <span class="n">the</span> <span class="n">client</span>
   <span class="n">may</span> <span class="n">specify</span> <span class="n">TCP</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">X11</span> <span class="n">forwarding</span> <span class="n">unless</span> <span class="n">they</span> <span class="n">are</span> <span class="n">explicitly</span> <span class="n">prohibited</span><span class="o">.</span>
   <span class="n">Note</span> <span class="n">that</span> <span class="n">this</span> <span class="n">option</span> <span class="n">applies</span> <span class="n">to</span> <span class="n">shell</span><span class="p">,</span> <span class="n">command</span> <span class="ow">or</span> <span class="n">subsystem</span> <span class="n">execution</span><span class="o">.</span>
</pre></div>
</div>
<p>Essentially, this gives us a way to authenticate the commands that are
being executed. We can either accept or reject commands, and we can even
provide a readable error message for commands we reject. The filter is
applied on the remote peer, to the key that provides the master access
to the remote peer.</p>
<p>So, let’s imagine that we have two hosts: master “mickey”, and peer
“minnie”. Here is the original <code class="docutils literal notranslate"><span class="pre">~/.ssh/authorized_keys</span></code> file for the
backup user on minnie (remember, this is all on one line in the file):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="n">rsa</span> <span class="n">AAAAB3NzaC1yc2EAAAABIwAAAIEAxw7EnqVULBFgPcut3WYp3MsSpVB9q9iZ</span><span class="o">+</span><span class="n">awek120391k</span><span class="p">;</span><span class="n">mm0c221</span><span class="o">=</span><span class="mi">3</span><span class="o">=</span><span class="n">km</span>
<span class="o">=</span><span class="n">m</span><span class="o">=</span><span class="n">askdalkS82mlF7SusBTcXiCk1BGsg7axZ2sclgK</span><span class="o">+</span><span class="n">FfWV1Jm0</span><span class="o">/</span><span class="n">I9yo9FtAZ9U</span><span class="o">+</span><span class="n">MmpL901231asdkl</span><span class="p">;</span><span class="n">ai1</span><span class="o">-</span><span class="mi">923</span><span class="n">ma9s</span><span class="o">=</span><span class="mi">9</span><span class="o">=</span>
<span class="mi">1</span><span class="o">-</span><span class="mi">2341</span><span class="o">=-</span><span class="n">a0sd</span><span class="o">=-</span><span class="n">sa0</span><span class="o">=</span><span class="mi">1</span><span class="n">z</span><span class="o">=</span> <span class="n">backup</span><span class="nd">@mickey</span>
</pre></div>
</div>
<p>This line is the public key that minnie can use to identify the backup
user on mickey. Assuming that there is no passphrase on the private key
back on mickey, the backup user on mickey can get direct access to
minnie.</p>
<p>To put the filter in place, we add a command option to the key, like
this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="o">=</span><span class="s2">&quot;/opt/backup/validate-backup&quot;</span> <span class="n">ssh</span><span class="o">-</span><span class="n">rsa</span> <span class="n">AAAAB3NzaC1yc2EAAAABIwAAAIEAxw7EnqVULBFgPcut3WYp</span>
<span class="mi">3</span><span class="n">MsSpVB9q9iZ</span><span class="o">+</span><span class="n">awek120391k</span><span class="p">;</span><span class="n">mm0c221</span><span class="o">=</span><span class="mi">3</span><span class="o">=</span><span class="n">km</span><span class="o">=</span><span class="n">m</span><span class="o">=</span><span class="n">askdalkS82mlF7SusBTcXiCk1BGsg7axZ2sclgK</span><span class="o">+</span><span class="n">FfWV1Jm0</span><span class="o">/</span><span class="n">I9yo9F</span>
<span class="n">tAZ9U</span><span class="o">+</span><span class="n">MmpL901231asdkl</span><span class="p">;</span><span class="n">ai1</span><span class="o">-</span><span class="mi">923</span><span class="n">ma9s</span><span class="o">=</span><span class="mi">9</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="mi">2341</span><span class="o">=-</span><span class="n">a0sd</span><span class="o">=-</span><span class="n">sa0</span><span class="o">=</span><span class="mi">1</span><span class="n">z</span><span class="o">=</span> <span class="n">backup</span><span class="nd">@mickey</span>
</pre></div>
</div>
<p>Basically, the command option says that whenever this key is used to
successfully initiate a connection, the <code class="docutils literal notranslate"><span class="pre">/opt/backup/validate-backup</span></code>
command will be run <em>instead of</em> the real command that came over the SSH
connection. Fortunately, the interface gives the command access to
shell variables that can be used to invoke the original command
if you want to.</p>
<p>A very basic <code class="docutils literal notranslate"><span class="pre">validate-backup</span></code> script might look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
if [[ &quot;${SSH_ORIGINAL_COMMAND}&quot; == &quot;ls -l&quot; ]] ; then
    ${SSH_ORIGINAL_COMMAND}
else
   echo &quot;Security policy does not allow command [${SSH_ORIGINAL_COMMAND}].&quot;
   exit 1
fi
</pre></div>
</div>
<p>This script allows exactly <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-l</span></code> and nothing else. If the user attempts
some other command, they get a nice error message telling them that their
command has been disallowed.  For remote commands executed over <code class="docutils literal notranslate"><span class="pre">ssh</span></code>, the
original command is exactly what the caller attempted to invoke.</p>
<p>For remote copies using the legacy SCP protocol, the commands are either <code class="docutils literal notranslate"><span class="pre">scp</span>
<span class="pre">-f</span> <span class="pre">file</span></code> (copy <em>from</em> the peer to the master) or <code class="docutils literal notranslate"><span class="pre">scp</span> <span class="pre">-t</span> <span class="pre">file</span></code> (copy <em>to</em>
the peer from the master).  When using the SFTP protocol, which is the default
in Debian starting with bookworm, the command is simply <code class="docutils literal notranslate"><span class="pre">/usr/lib/openssh/sftp-server</span></code>.
As a result, this mechanism is really only useful if you force the legacy SCP
protocol using <code class="docutils literal notranslate"><span class="pre">scp</span> <span class="pre">-O</span></code>.</p>
<p>If you want, you can see what command SSH thinks it is executing by
using <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">-v</span></code> or <code class="docutils literal notranslate"><span class="pre">scp</span> <span class="pre">-O</span> <span class="pre">-v</span></code>. The command will be right at the top,
something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Executing</span><span class="p">:</span> <span class="n">program</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ssh</span> <span class="n">host</span> <span class="n">mickey</span><span class="p">,</span> <span class="n">user</span> <span class="p">(</span><span class="n">unspecified</span><span class="p">),</span> <span class="n">command</span> <span class="n">scp</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">f</span> <span class="o">.</span><span class="n">profile</span>
<span class="n">OpenSSH_4</span><span class="mf">.3</span><span class="n">p2</span> <span class="n">Debian</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="n">OpenSSL</span> <span class="mf">0.9.8</span><span class="n">c</span> <span class="mi">05</span> <span class="n">Sep</span> <span class="mi">2006</span>
<span class="n">debug1</span><span class="p">:</span> <span class="n">Reading</span> <span class="n">configuration</span> <span class="n">data</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">backup</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">config</span>
<span class="n">debug1</span><span class="p">:</span> <span class="n">Applying</span> <span class="n">options</span> <span class="k">for</span> <span class="n">minnie</span>
<span class="n">debug1</span><span class="p">:</span> <span class="n">Reading</span> <span class="n">configuration</span> <span class="n">data</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">ssh_config</span>
<span class="n">debug1</span><span class="p">:</span> <span class="n">Applying</span> <span class="n">options</span> <span class="k">for</span> <span class="o">*</span>
<span class="n">debug2</span><span class="p">:</span> <span class="n">ssh_connect</span><span class="p">:</span> <span class="n">needpriv</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Omit the <code class="docutils literal notranslate"><span class="pre">-v</span></code> and you have your command: <code class="docutils literal notranslate"><span class="pre">scp</span> <span class="pre">-f</span> <span class="pre">.profile</span></code>.</p>
<p>For a normal, non-managed setup, you need to allow the following
commands, where <code class="docutils literal notranslate"><span class="pre">/path/to/collect/</span></code> is replaced with the real path to
the collect directory on the remote peer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">collect</span><span class="o">/</span><span class="n">cback</span><span class="o">.</span><span class="n">collect</span>
<span class="n">scp</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">collect</span><span class="o">/*</span>
<span class="n">scp</span> <span class="o">-</span><span class="n">t</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">collect</span><span class="o">/</span><span class="n">cback</span><span class="o">.</span><span class="n">stage</span>
</pre></div>
</div>
<p>If you are configuring a managed client, then you also need to list the
exact command lines that the master will be invoking on the managed
client. You are guaranteed that the master will invoke one action at a
time, so if you list two lines per action (full and non-full) you should
be fine. Here’s an example for the collect action:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">cback3</span> <span class="o">--</span><span class="n">full</span> <span class="n">collect</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">cback3</span> <span class="n">collect</span>
</pre></div>
</div>
<p>Of course, you would have to list the actual path to the <code class="docutils literal notranslate"><span class="pre">cback3</span></code>
executable — exactly the one listed in the <code class="docutils literal notranslate"><span class="pre">&lt;cback_command&gt;</span></code>
configuration option for your managed peer.</p>
<p>Below is the script that I use for my own backups, to allow the
master to stage files from each client.  This is stored as
<code class="docutils literal notranslate"><span class="pre">~/.ssh/validate-backup</span></code> and is referenced in <code class="docutils literal notranslate"><span class="pre">~/.ssh/authorized-keys</span></code>
as described above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Since this script is specified as the command in ~/.ssh/authorized_keys, it
# acts as a &quot;filter&quot; and prevents the backup user from doing anything except
# specific Cedar Backup actions (stage, in this case, via scp).

# See the AUTHORIZED_KEYS FILE FORMAT section in sshd(8) for more information.

# As of Debian bookworm, the sshd server implements SCP over SFTP.  That breaks
# this filter, because the SSH command is just &quot;/usr/lib/openssh/sftp-server&quot;.
# The workaround is to use `scp -O` to force the old protocol.

typeset -x COLLECTDIR=/data/backup/collect

typeset -x CMD1=&quot;scp -f ${COLLECTDIR}/cback.collect&quot;    # check collect indicator
typeset -x CMD2=&quot;scp -f ${COLLECTDIR}/*&quot;                # stage all files
typeset -x CMD3=&quot;scp -t ${COLLECTDIR}/cback.stage&quot;      # write the stage indicator

if [[ &quot;${SSH_ORIGINAL_COMMAND}&quot; == &quot;${CMD1}&quot; ]] ; then
    ${SSH_ORIGINAL_COMMAND}
elif [[ &quot;${SSH_ORIGINAL_COMMAND}&quot; == &quot;${CMD2}&quot; ]]; then
   ${SSH_ORIGINAL_COMMAND}
elif [[ &quot;${SSH_ORIGINAL_COMMAND}&quot; == &quot;${CMD3}&quot; ]]; then
   ${SSH_ORIGINAL_COMMAND}
else
   echo &quot;Security policy does not allow command [${SSH_ORIGINAL_COMMAND}].&quot;
   exit 1
fi
</pre></div>
</div>
<hr class="docutils" />
<p><em>Previous</em>: <a class="reference internal" href="recovering.html"><span class="doc">Data Recovery</span></a> • <em>Next</em>: <a class="reference internal" href="copyright.html"><span class="doc">Copyright</span></a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">cedar-backup3</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=pronovic&repo=cedar-backup3&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;(c) Kenneth J. Pronovici.
      
    </div>

    
    <a href="https://github.com/pronovic/cedar-backup3" class="github">
        <img src="../_static/github-banner.svg" alt="Fork me on GitHub" class="github"/>
    </a>
    

    
  </body>
</html>
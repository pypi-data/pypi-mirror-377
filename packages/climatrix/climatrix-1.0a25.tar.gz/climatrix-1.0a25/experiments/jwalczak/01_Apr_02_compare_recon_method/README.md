# Experiment Framework with Docker
This repository provides a reproducible Docker-based environment for running experiments.  
It ensures that datasets are properly downloaded/prepared and that results are stored locally.

---

## ğŸ“‚ Project Structure

```
01_Apr_02_compare_recon_method/
â”œâ”€â”€ conf/                  # Configurations 
â”‚   â””â”€â”€ setup.sh           # Script to create virtual environment & install deps
â”‚   â””â”€â”€ requirements.txt   # Dependencies to install
â”œâ”€â”€ data/                  # Datasets (mounted from host)
â”œâ”€â”€ images/                # Container definition files (Dockerfile, experiment.def)
â”‚   â”œâ”€â”€ scripts/           # Container utility scripts
â”‚       â””â”€â”€ entrypoint.sh 
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ experiment.def
â”œâ”€â”€ src/                   # Source code (Python modules)
â”œâ”€â”€ results/               # Experiment outputs (mounted from host)
â”œâ”€â”€ notebook/              # Jupyter notebooks
â”œâ”€â”€ scripts/               # Utility scripts
â”‚   â”œâ”€â”€ download_blend_mean_temperature.sh
â”‚   â”œâ”€â”€ prepare_ecad_observations.py
```

---

## ğŸ³ Docker Setup

### 1. Build the Docker Image

From inside the `images/` directory:

```bash
cd 01_Apr_02_compare_recon_method
docker build -t my-experiments -f images/Dockerfile .
```

This creates an image named `my-experiments`.

---

### 2. Run the Container

To run experiments while keeping **data** and **results** synced with your host:

```bash
docker run --rm \
  -v $(pwd)/../data:/app/data \
  -v $(pwd)/../results:/app/results \
  my-experiments
```

- `-v $(pwd)/../data:/app/data` â†’ Mounts host `01_Apr_02_compare_recon_method/data` into container `/app/data`  
- `-v $(pwd)/../results:/app/results` â†’ Mounts host `01_Apr_02_compare_recon_method/results` into container `/app/results`  
- `--rm` â†’ Automatically removes the container after execution  

---

# ğŸ›°ï¸ Using Apptainer (Singularity)

### 1. Build the Apptainer Image

From inside the `images/` directory:

```bash
cd 01_Apr_02_compare_recon_method/images
apptainer build experiment.sif experiment.def
```

If you donâ€™t have root privileges, you may need:
```bash
apptainer build --fakeroot experiment.sif experiment.def
```

---

### 2. Run the Container

```bash
apptainer run \
  --bind ../data:/app/data \
  --bind ../results:/app/results \
  experiment.sif
```

- `--bind ../data:/app/data` â†’ Mounts host `01_Apr_02_compare_recon_method/data`  
- `--bind ../results:/app/results` â†’ Mounts host `01_Apr_02_compare_recon_method/results`  
- Results will appear in your host `01_Apr_02_compare_recon_method/results`.

---

## âš™ï¸ What Happens Inside the Container

When the container starts (`CMD` in Dockerfile):

1. **Download data** (if not already present)  
   ```bash
   scripts/download_blend_mean_temperature.sh
   ```
   - Downloads data into `/app/data` (mapped to host `01_Apr_02_compare_recon_method/data`).

2. **Prepare dataset**  
   ```bash
   python scripts/prepare_ecad_observations.py
   ```
   - Processes raw data and stores ready-to-use files in `/app/data`.

3. **Run experiments**  
   ```bash
   bash scripts/run_experiments.sh
   ```
   - Executes experiments and saves outputs in `/app/results` (mapped to host `01_Apr_02_compare_recon_method/results`).

---

## ğŸ“Œ Virtual Environment

- A Python virtual environment is created in `/app/conf/exp1` during image build.  
- Itâ€™s automatically used for all Python commands via environment variables:
  ```dockerfile
  ENV VIRTUAL_ENV=/app/conf/exp1
  ENV PATH="$VIRTUAL_ENV/bin:$PATH"
  ```
- You do **not** need to run `source activate`; `python` and `pip` already refer to the venv.

---

## ğŸ“Š Viewing Results

After the run, check results on your host machine:

```bash
ls 01_Apr_02_compare_recon_method/results
```

Outputs generated by the experiments will appear here.

---

## ğŸ“ License

The code and experiments are published under MIT license.
name: dataio API CI/CD to lightsail

on:
  push:
    branches: [staging]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # - uses: actions/checkout@v2

    # - name: Deploy to AWS EC2
    #   uses: appleboy/scp-action@master
    #   with:
    #     host: ${{ secrets.LIGHTSAIL_IP }}
    #     username: ${{ secrets.LIGHTSAIL_USER }}
    #     key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
    #     source: "./"  # This now correctly points to the current directory
    #     target: "/home/ubuntu/staging/dataio"

    - name: UV Sync & supervisorctl restart
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.LIGHTSAIL_IP }}
        username: ${{ secrets.LIGHTSAIL_USER }}
        key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        script: |
          export PATH="/home/ubuntu/.local/bin:$PATH"
          d=$(date +%Y%m%d-%H%M%S)
          cd /home/ubuntu/staging
          cp dataio/logs/dataio-api.log logs_backup/dataio/$d.log
          rm -rf dataio
          git clone git@github.com:dsih-artpark/dataio.git
          cp /home/ubuntu/infra/.dataio-env /home/ubuntu/staging/dataio/.env
          cd dataio
          mkdir logs
          uv sync --group docs
          uv run sphinx-build -b html docs/source docs/build
          sudo supervisorctl restart dataio-app


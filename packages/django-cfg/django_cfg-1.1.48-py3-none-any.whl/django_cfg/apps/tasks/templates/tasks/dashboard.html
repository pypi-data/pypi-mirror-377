<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dramatiq Queue Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            transition: transform 0.3s ease, color 0.2s ease;
        }
        
        #theme-toggle .material-icons {
            font-size: 18px;
        }
        
        /* Smooth theme transition */
        * {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900">

    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <span class="material-icons text-primary-600 dark:text-primary-400 text-3xl">analytics</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">Dramatiq Queue Dashboard</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Monitor and manage background task queues</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <a href="/admin/django_dramatiq/task/" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200">
                            <span class="material-icons text-sm mr-2">history</span>
                            Task History
                        </a>
                        <button id="theme-toggle" class="group inline-flex items-center justify-center px-3 py-2 rounded-md bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                            <span class="material-icons text-gray-600 dark:text-yellow-400 group-hover:text-primary-600 dark:group-hover:text-yellow-300 transition-colors duration-200">light_mode</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Control Buttons -->
            <div class="mb-8">
                <div class="flex flex-wrap gap-3">
                    <button class="start-workers-btn inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium text-sm rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 shadow-sm hover:shadow-md">
                        <span class="material-icons text-lg mr-2">play_arrow</span>
                        Start Workers
                    </button>
                    <button class="clear-queues-btn inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium text-sm rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-sm hover:shadow-md">
                        <span class="material-icons text-lg mr-2">delete_sweep</span>
                        Clear Queues
                    </button>
                    <button class="refresh-status-btn inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium text-sm rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 shadow-sm hover:shadow-md">
                        <span class="material-icons text-lg mr-2">refresh</span>
                        Refresh Status
                    </button>
                </div>
            </div>

            <!-- Status Dashboard -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-8">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                        <span class="material-icons text-primary-600 dark:text-primary-400 mr-2">monitor_heart</span>
                        Real-time Status
                    </h2>
                </div>
                <div class="p-6">
                    <div id="queue-status-container">
                        <div class="flex items-center justify-center py-12">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                            <span class="ml-3 text-gray-600 dark:text-gray-400">Loading status...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Quick Info Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="material-icons text-primary-600 dark:text-primary-400 mr-2">info</span>
                            Quick Info
                        </h3>
                    </div>
                    <div class="p-6">
                        <ul class="space-y-3 text-sm text-gray-600 dark:text-gray-300">
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-primary-500 rounded-full mt-2 mr-3"></span>
                                <span>Workers process tasks from queues</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-primary-500 rounded-full mt-2 mr-3"></span>
                                <span>Failed tasks can be retried or cleared</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-primary-500 rounded-full mt-2 mr-3"></span>
                                <span>Monitor Redis connection status</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-primary-500 rounded-full mt-2 mr-3"></span>
                                <span>Auto-refresh every 30 seconds</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Best Practices Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="material-icons text-green-600 dark:text-green-400 mr-2">tips_and_updates</span>
                            Best Practices
                        </h3>
                    </div>
                    <div class="p-6">
                        <ul class="space-y-3 text-sm text-gray-600 dark:text-gray-300">
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></span>
                                <span>Start 1-4 worker processes</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></span>
                                <span>Use 4-16 threads per process</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></span>
                                <span>Monitor failed task counts</span>
                            </li>
                            <li class="flex items-start">
                                <span class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></span>
                                <span>Clear failed tasks regularly</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- CLI Commands Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-shadow duration-300">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                            <span class="material-icons text-amber-600 dark:text-amber-400 mr-2">terminal</span>
                            CLI Commands
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 font-mono text-xs text-gray-700 dark:text-gray-300">
                                python manage.py rundramatiq
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 font-mono text-xs text-gray-700 dark:text-gray-300">
                                python manage.py task_status
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 font-mono text-xs text-gray-700 dark:text-gray-300">
                                python manage.py task_clear
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 space-y-2"></div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        // Dark mode toggle
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        
        // Check for saved theme preference or default to system preference
        const getInitialTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) return savedTheme;
            
            // Check system preference
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };
        
        const currentTheme = getInitialTheme();
        html.classList.toggle('dark', currentTheme === 'dark');
        
        const updateThemeIcon = (theme) => {
            const icon = themeToggle.querySelector('.material-icons');
            if (theme === 'dark') {
                icon.textContent = 'light_mode';
                icon.setAttribute('title', 'Switch to light mode');
            } else {
                icon.textContent = 'dark_mode';
                icon.setAttribute('title', 'Switch to dark mode');
            }
        };
        
        // Initialize icon
        updateThemeIcon(currentTheme);
        
        themeToggle.addEventListener('click', () => {
            // Add smooth transition
            html.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            
            // Update icon with animation
            const icon = themeToggle.querySelector('.material-icons');
            icon.style.transform = 'rotate(180deg)';
            
            setTimeout(() => {
                updateThemeIcon(newTheme);
                icon.style.transform = 'rotate(0deg)';
            }, 150);
            
            // Remove transition after animation
            setTimeout(() => {
                html.style.transition = '';
            }, 300);
        });
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                const systemTheme = e.matches ? 'dark' : 'light';
                html.classList.toggle('dark', systemTheme === 'dark');
                updateThemeIcon(systemTheme);
            }
        });

        // Dramatiq Admin functionality
        class DramatiqAdmin {
            constructor() {
                this.initializeEventListeners();
                this.loadStatus();
                this.startAutoRefresh();
            }

            initializeEventListeners() {
                document.querySelector('.start-workers-btn')?.addEventListener('click', () => this.startWorkers());
                document.querySelector('.clear-queues-btn')?.addEventListener('click', () => this.clearQueues());
                document.querySelector('.refresh-status-btn')?.addEventListener('click', () => this.loadStatus());
            }

            async makeRequest(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json',
                            ...options.headers
                        },
                        ...options
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Request failed:', error);
                    this.showNotification('Request failed: ' + error.message, 'error');
                    return null;
                }
            }

            async loadStatus() {
                const container = document.getElementById('queue-status-container');
                container.innerHTML = `
                    <div class="flex items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                        <span class="ml-3 text-gray-600 dark:text-gray-400">Loading status...</span>
                    </div>
                `;

                const data = await this.makeRequest('/admin/django_dramatiq/task/queue-status/');
                if (data && data.success) {
                    this.renderStatus(data.data);
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-icons text-red-500 text-4xl mb-4">error</span>
                            <p class="text-red-600 dark:text-red-400">Failed to load status</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${data?.data?.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            }

            renderStatus(data) {
                const container = document.getElementById('queue-status-container');
                const hasError = data.error;
                
                if (hasError) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <span class="material-icons text-red-500 text-4xl mb-4">error</span>
                            <p class="text-red-600 dark:text-red-400 font-medium">Connection Error</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${data.error}</p>
                        </div>
                    `;
                    return;
                }

                const queues = data.queues || {};
                const workers = data.workers || 0;
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-primary-600 dark:text-primary-400">${Object.keys(queues).length}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Queues</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600 dark:text-green-400">${workers}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Active Workers</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">${Object.values(queues).reduce((sum, q) => sum + (q.size || 0), 0)}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Total Tasks</div>
                        </div>
                    </div>
                    
                    ${Object.keys(queues).length > 0 ? `
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Queue Details</h3>
                            <div class="grid gap-4">
                                ${Object.entries(queues).map(([name, queue]) => `
                                    <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="font-medium text-gray-900 dark:text-white">${name}</h4>
                                            <span class="px-2 py-1 text-xs rounded-full ${queue.size > 0 ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200'}">${queue.size || 0} tasks</span>
                                        </div>
                                        ${queue.size > 0 ? `<div class="text-sm text-gray-600 dark:text-gray-400">Processing tasks...</div>` : `<div class="text-sm text-gray-500 dark:text-gray-500">No pending tasks</div>`}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <span class="material-icons text-gray-400 text-4xl mb-4">inbox</span>
                            <p class="text-gray-500 dark:text-gray-400">No queues found</p>
                        </div>
                    `}
                `;
            }

            async startWorkers() {
                const data = await this.makeRequest('/admin/django_dramatiq/task/start-workers/', { method: 'POST' });
                if (data && data.success) {
                    this.showNotification('Workers started successfully', 'success');
                    setTimeout(() => this.loadStatus(), 1000);
                }
            }

            async clearQueues() {
                if (!confirm('Are you sure you want to clear all queues? This action cannot be undone.')) {
                    return;
                }
                
                const data = await this.makeRequest('/admin/django_dramatiq/task/clear-queues/', { method: 'POST' });
                if (data && data.success) {
                    this.showNotification('Queues cleared successfully', 'success');
                    setTimeout(() => this.loadStatus(), 1000);
                }
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                
                const colors = {
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    info: 'bg-blue-500 text-white'
                };
                
                notification.className = `${colors[type]} px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-0 opacity-100`;
                notification.textContent = message;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('-translate-y-2', 'opacity-0');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            startAutoRefresh() {
                setInterval(() => this.loadStatus(), 30000); // Refresh every 30 seconds
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new DramatiqAdmin();
        });
    </script>
</body>
</html>

document.addEventListener("DOMContentLoaded",function(){const script=document.getElementById("django-issues-script");const MODAL_OVERLAY_ID="django-issues-modal-overlay";const FORM_CONTAINER_ID="django-issues-form-container";const OPENER_ID="issue-opener";const FORM_ID="django-issues-form";const SCREENSHOT_PREVIEW_CONTAINER_ID="screenshot-preview-container";const SCREENSHOT_PREVIEW_IMG_ID="screenshot-preview-img";const MESSAGE_CONTAINER_ID="form-message-container";const ERRORS_CONTAINER_ID="form-error-container";const SCREENSHOT_LIBRARY=script.dataset.engine;const SUBMIT_URL=script.dataset.url;axios.defaults.xsrfHeaderName="X-CSRFTOKEN";axios.defaults.xsrfCookieName="csrftoken";function createModal(){if(document.getElementById(MODAL_OVERLAY_ID)){return}const modalOverlay=document.createElement("div");modalOverlay.id=MODAL_OVERLAY_ID;modalOverlay.className="modal-overlay";modalOverlay.style.display="none";const modalContent=document.createElement("div");modalContent.id=FORM_CONTAINER_ID;modalContent.className="modal-content";modalOverlay.appendChild(modalContent);document.body.appendChild(modalOverlay);modalOverlay.addEventListener("click",function(event){if(event.target===this){this.style.display="none"}})}function displayMessage(container,message,isError=false){const target=container.querySelector(".message");target.innerHTML=message;container.style.backgroundColor=isError?"#f8d7da":"#d4edda";container.style.color=isError?"#721c24":"#155724";container.style.border=`1px solid ${isError?"#f5c6cb":"#c3e6cb"}`;container.style.display="block"}function clearMessage(container){const target=container.querySelector(".message");target.innerHTML="";container.style.display="none"}const issueOpener=document.getElementById(OPENER_ID);if(issueOpener){issueOpener.addEventListener("click",function(){let screenshotPromise=Promise.resolve(null);if(SCREENSHOT_LIBRARY){if(SCREENSHOT_LIBRARY==="html2canvas"){screenshotPromise=html2canvas(document.body,{width:window.innerWidth,height:document.documentElement.scrollHeight,allowTaint:true,scale:1,foreignObjectRendering:true,useCORS:true}).then(canvas=>canvas.toDataURL("image/png"))}else if(SCREENSHOT_LIBRARY==="dom-to-image"){screenshotPromise=domtoimage.toPng(document.body)}}screenshotPromise.then(function(screenshotData){createModal();axios.get(SUBMIT_URL).then(response=>{const formContainer=document.getElementById(FORM_CONTAINER_ID);const modalOverlay=document.getElementById(MODAL_OVERLAY_ID);if(formContainer&&modalOverlay){formContainer.innerHTML=response.data;const titleInput=formContainer.querySelector('input[name="title"]');const screenshotInput=formContainer.querySelector('input[name="screenshot"]');const addScreenshotCheckbox=formContainer.querySelector('input[name="add_screenshot"]');const screenshotPreviewContainer=document.getElementById(SCREENSHOT_PREVIEW_CONTAINER_ID);const screenshotPreviewImg=document.getElementById(SCREENSHOT_PREVIEW_IMG_ID);if(SCREENSHOT_LIBRARY){screenshotInput.value=screenshotData;screenshotPreviewImg.src=screenshotData;function togglePreview(show){screenshotPreviewContainer.style.visibility=show?"visible":"hidden";screenshotPreviewContainer.style.opacity=show?"1":"0"}togglePreview(addScreenshotCheckbox.checked);addScreenshotCheckbox.addEventListener("change",function(){togglePreview(this.checked)})}else{if(screenshotInput)screenshotInput.remove();if(addScreenshotCheckbox)addScreenshotCheckbox.closest("p").remove();if(screenshotPreviewContainer)screenshotPreviewContainer.remove()}modalOverlay.style.display="flex";titleInput.focus()}}).catch(error=>{console.error("Error loading form:",error)})})});issueOpener.style.display="block"}document.addEventListener("submit",function(event){if(event.target.id===FORM_ID){event.preventDefault();const form=event.target;const modalOverlay=document.getElementById(MODAL_OVERLAY_ID);const messageContainer=modalOverlay.querySelector(`#${MESSAGE_CONTAINER_ID}`);const errorContainer=modalOverlay.querySelector(`#${ERRORS_CONTAINER_ID}`);if(messageContainer)clearMessage(messageContainer);const formData=new FormData(form);const data=Object.fromEntries(formData.entries());if(!data.add_screenshot){delete data.screenshot}axios.post(SUBMIT_URL,data,{headers:{"Content-Type":"application/json","X-CSRFToken":data.csrfmiddlewaretoken}}).then(response=>{if(response.data.success){const formContainer=document.getElementById(FORM_CONTAINER_ID);const form=formContainer.querySelector("form");if(messageContainer){form.style.display="none";displayMessage(messageContainer,response.data.message,false)}setTimeout(()=>{const modalOverlay=document.getElementById(MODAL_OVERLAY_ID);if(modalOverlay){modalOverlay.style.display="none"}if(formContainer){formContainer.innerHTML=""}if(messageContainer)clearMessage(messageContainer)},3e3)}else{let errorMessage=response.data.message||"An error occurred.";if(response.data.errors){errorMessage+="<br><ul>";for(const field in response.data.errors){errorMessage+=`<li><strong>${field}:</strong> ${response.data.errors[field].join(", ")}</li>`}errorMessage+="</ul>"}if(errorContainer){displayMessage(errorContainer,errorMessage,true)}}}).catch(error=>{const errorMessage=error.response&&error.response.data&&error.response.data.message?error.response.data.message:"An unexpected error occurred.";if(messageContainer)displayMessage(messageContainer,errorMessage,true);console.error("Error submitting form:",error)})}});document.addEventListener("keydown",function(event){if(event.key==="Escape"){const modalOverlay=document.getElementById(MODAL_OVERLAY_ID);if(modalOverlay&&modalOverlay.style.display!=="none"){modalOverlay.style.display="none"}}})});

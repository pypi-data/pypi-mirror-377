(()=>{const e=function(e,t,n){let a=e.val();void 0!==a&&n.selectAll(!1);let o=[a];if(!0===t.filter){let e=[];o=[];try{e=JSON.parse(a)}catch(t){e=[]}finally{e.forEach((function(e){o.push(e.value)}))}}else if(2===t.multiselect)try{o=JSON.parse(a)}catch(e){o=[]}o.forEach((function(e){let t=n.getNodeByKey(e);t&&(t.getParentList().forEach((function(e){e.setExpanded(!0)})),t.setSelected(!0))}))};$((function(){const t=function(t){if(t.hasClass("fancytree-container"))return;t.on("change",(e=>{const t=e.target.dataset.changeTarget;if(t){const n=document.querySelector(t);n&&(n.value=e.target.value)}}));let a={};const o=e=>{if(!a.isFiltered)return void e.filterNodes((e=>(e.setExpanded(!1),!0)),{autoExpand:!1});const t={};a.data.forEach((e=>t[e.path]=e)),e.filterNodes((e=>{if(t[e.key])return!0}),{autoExpand:!0})},r=$("#"+t.data("tree-data-id")),d=$("#"+t.data("tree-additional-columns-id")),i=$("#"+t.data("tree-strings-id"));let s={},l=[],c={loading:"Loading...",loadError:"Load error!",moreData:"More...",noData:"No data."};try{s=JSON.parse(r.text())||{},l=JSON.parse(d.text())||[],c=JSON.parse(i.text())}catch(e){console.error(e)}const u=$("#"+s.input_id),f=$("#"+s.input_id+"_search"),p=$("#"+s.input_id+"_matches"),h=$("#"+s.input_id+"_label"),m={indentation:32,nodeColumnIdx:0},y=window.loadJSONScriptData("fancytree_filter_settings");s.checkbox&&(m.checkboxColumnIdx=0,m.nodeColumnIdx=1);let v=["table","gridnav","filter"];s.reorder_url&&v.push("dnd5"),t.fancytree({source:{url:s.data_url},extensions:v,checkbox:s.checkbox,selectMode:s.multiselect,dnd5:{preventVoidMoves:!0,preventRecursion:!0,autoExpandMS:400,dropMarkerParent:".tree-list-view",dropMarkerOffsetX:-8,dropMarkerInsertOffsetX:0,dragStart:function(){return!0},dragEnter:function(){return!0},dragDrop:function(e,t){t.otherNode.moveTo(e,t.hitMode)}},filter:{autoApply:!0,autoExpand:!0,counter:!1,fuzzy:!1,hideExpandedCounter:!0,hideExpanders:!0,highlight:!0,leavesOnly:!1,nodata:!0,mode:"hide",...y},table:m,gridnav:{autofocusInput:!1,handleCursorKeys:!0},strings:c,postProcess:function(t,n){setTimeout((function(){e(u,s,n.tree)}),1)},select:function(e,t){if(u.length>0){let e=null;if(s.filter)e=t.tree.getSelectedNodes().map((function(e){return{value:e.key,label:e.title}})),u.val(JSON.stringify(e));else{e=t.tree.getSelectedNodes().map((function(e){return e.key})).join(", "),2===s.multiselect&&(e=JSON.stringify(t.tree.getSelectedNodes().map((function(e){return e.key}))));let n=t.tree.getSelectedNodes().map((function(e){return e.title})).join(", ");h.text(n),u.val(e)}return u[0].dispatchEvent(new CustomEvent("SBAutocompleteChange")),void u[0].dispatchEvent(new Event("change",{bubbles:!0}))}if(s.filter_by_table_data&&t.originalEvent){const e=t.tree.getSelectedNodes().map((function(e){return e.data.id}));document.body.dispatchEvent(new CustomEvent("treeRowSelected",{detail:{data:e}}))}},enhanceTitle:function(e,t){const n=s.reorder_url,a=t.node.rendered,o=t.node.tree.enableFilter,r=s.detail_url,d=t.node.span&&t.node.span.classList.contains("fancytree-node")&&!t.node.tr.classList.contains("fancytree-hide");if(r&&(!a||o)&&!n&&d){const e=t.node.span.querySelector(".fancytree-title"),n=document.createElement("a"),a=s.detail_url.replace(-1,t.node.data.id);n.innerHTML=e.innerHTML,n.classList.add("link"),n.href=a,e.innerHTML="",e.append(n),e.addEventListener("mousedown",(function(e){e.preventDefault(),e.stopPropagation()}),!0)}},renderNode:function(e,t){const n=s.reorder_url,a=t.node.rendered,o=t.node.span&&t.node.span.classList.contains("fancytree-node")&&!t.node.tr.classList.contains("fancytree-hide");if(a&&!n)return;let r=t.node&&t.node.tr&&t.node.tr.classList.contains("fancytree-lastsib");if(r=void 0!==r&&r,t.node.parent?(t.node.treeLevel=t.node.parent.treeLevel+1,t.node.treeAdditionalLevel=[{level:t.node.treeLevel,lastSib:r},...t.node.parent.treeAdditionalLevel]):(t.node.treeLevel=0,t.node.treeAdditionalLevel=[]),t.node.rendered=!0,o){const e=t.node.span.querySelector(".fancytree-expander"),n=t.node.treeLevel,a=t.node.treeAdditionalLevel;e.innerHTML="",e.className="fancytree-expander",e.classList.add("level-"+n),t.node.parent.expanded&&e.classList.add("expanded-parent"),a.forEach(((t,n)=>{if(0!==n&&t.lastSib)return;const a=document.createElement("span");a.classList.add("expander-additional"),0===n&&a.classList.add("expander-additional-last"),a.style.left=-(50+100*n)+"%",e.append(a)}));const o=document.createElement("span");o.classList.add("expander-border"),e.append(o),e.append(document.createElement("div"))}},renderColumns:function(e,t){const n=$(t.node.tr).find(">td");l.forEach((function(e,a){let o=t.node.data[e.key];e.hide_zero&&0===o&&(o=""),n.eq(1+m.nodeColumnIdx+a).html(o)}))},init:function(e,a){s.filter_by_table_data&&o(a.tree),s.allow_select_all&&n(t,a.tree)}});const g=function(){f.val(""),p.text(""),E.visit((function(e){e.rendered=!1})),E.clearFilter()},E=$.ui.fancytree.getTree("#"+s.input_id+"_tree");u.on("SBTableFilterFormLoad",(()=>{e(u,s,E)})),u.on("clear",(()=>{E.getSelectedNodes().map((e=>{e.setSelected(!1)}))})),f.on("keyup",(function(e){let t=$(this).val(),n=E.filterNodes(t);e&&e.which===$.ui.keyCode.ESCAPE||""===$.trim(t)?g():p.text("("+n+" matches)")})).trigger("focus"),f.on("search",(function(e){e.target.value||g()})),E.saveTreeOrder=function(){const e=JSON.stringify(E.toDict());fetch(s.reorder_url,{method:"POST",headers:{"X-CSRFToken":window.csrf_token},body:e}).then((e=>e.json())).then((e=>{document.getElementById("notification-messages").innerHTML=e.messages,window.htmx.process(document.getElementById("notification-messages"))}))},s.filter_by_table_data&&(document.body.addEventListener("tableDataProcessed",(e=>{a=e.detail,"loading"!==E.getRootNode().getChildren()[0].statusNodeType&&o(E)})),document.body.addEventListener("treeDeselectAllRows",(()=>{E.selectAll(!1)})),document.body.addEventListener("treeSelectAllRows",(()=>{E.selectAll(!0)})))},n=function(e,t){e.find(".select-all-checkbox-wrapper").append('\n            <span role="checkbox" aria-label="Select All" class="fancytree-checkbox" id="fancytree-row-select-all"></span>\n        '),$("#fancytree-row-select-all").on("click",(function(){const e="fancytree-selected",n=$(this).parent().hasClass(e);t.getRootNode().findAll((e=>e.match)).forEach((e=>e.setSelected(!n))),n?$(this).parent().removeClass(e):$(this).parent().addClass(e)}))},a=function(){$(".js-tree-widget").each((function(e,n){const a=$(n);if(a.hasClass("fancytree-container"))return;const o=a.closest(".dropdown-menu");if(o.length>0){const e=function(){t(a),o.prev().off("show.bs.dropdown",e)};o.prev().on("show.bs.dropdown",e)}else t(a)}))};a(),document.addEventListener("formset:added",(()=>{a()}));$(".query-builder-advanced").on("afterCreateRuleInput.queryBuilder",(function(){setTimeout((()=>{a()}),0)}))}))})();
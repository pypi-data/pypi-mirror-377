"use strict";(self.webpackChunk_jupytercad_jupytercad_core=self.webpackChunk_jupytercad_jupytercad_core||[]).push([[868],{6868:(e,t,s)=>{var a,i,n;s.r(t),s.d(t,{IAnnotationToken:()=>C,IJCadExternalCommandRegistryToken:()=>b,IJCadFormSchemaRegistryToken:()=>j,IJCadWorkerRegistryToken:()=>y,IJupyterCadDocTracker:()=>S,JCadWorkerSupportedFormat:()=>n,JupyterCadDoc:()=>g,JupyterCadModel:()=>m,MainAction:()=>i,SCHEMA_VERSION:()=>p,WorkerAction:()=>a}),function(e){e.DRY_RUN="DRY_RUN",e.LOAD_FILE="LOAD_FILE",e.SAVE_FILE="SAVE_FILE",e.REGISTER="REGISTER",e.POSTPROCESS="POSTPROCESS"}(a||(a={})),function(e){e.DISPLAY_SHAPE="DISPLAY_SHAPE",e.INITIALIZED="INITIALIZED",e.DISPLAY_POST="DISPLAY_POST",e.DRY_RUN_RESPONSE="DRY_RUN_RESPONSE"}(i||(i={})),function(e){e.BREP="BREP",e.GLTF="GLTF",e.STL="STL"}(n||(n={}));var r=s(4602),o=s(1601),h=s.n(o),d=s(8e3),c=s(7262),l=s(2206);const p="3.0.0";class g extends d.YDocument{constructor(){super(),this.editable=!0,this._objectsObserver=e=>{const t=[];let s=!1;e.forEach(e=>{const a=e.target.get("name");a&&e.keys.forEach((i,n)=>{s||"shapeMetadata"===n||(s=!0),t.push({name:a,key:n,newValue:c.JSONExt.deepCopy(e.target.toJSON())})})}),s=0===t.length||s,s&&this._objectsChanged.emit({objectChange:t}),this._changed.emit({objectChange:t})},this._metaObserver=e=>{this._metadataChanged.emit(e.keys)},this._optionsObserver=e=>{this._optionsChanged.emit(e.keys)},this._metadataChanged=new r.Signal(this),this._optionsChanged=new r.Signal(this),this._objectsChanged=new r.Signal(this),this._options=this.ydoc.getMap("options"),this._objects=this.ydoc.getArray("objects"),this._metadata=this.ydoc.getMap("metadata"),this._outputs=this.ydoc.getMap("outputs"),this.undoManager.addToScope(this._objects),this._objects.observeDeep(this._objectsObserver),this._metadata.observe(this._metaObserver),this._options.observe(this._optionsObserver)}dispose(){super.dispose()}get version(){return p}get objects(){return this._objects.map(e=>c.JSONExt.deepCopy(e.toJSON()))}get options(){return c.JSONExt.deepCopy(this._options.toJSON())}get metadata(){return c.JSONExt.deepCopy(this._metadata.toJSON())}get outputs(){return c.JSONExt.deepCopy(this._outputs.toJSON())}get objectsChanged(){return this._objectsChanged}get optionsChanged(){return this._optionsChanged}getSource(){return{objects:this._objects.toJSON(),options:this._options.toJSON(),metadata:this._metadata.toJSON(),outputs:this._outputs.toJSON()}}setSource(e){if(!e)return;let t;t="string"==typeof e?JSON.parse(e):e,this.transact(()=>{var e,s,a,i;(null!==(e=t.objects)&&void 0!==e?e:[]).forEach(e=>{this._objects.push([new l.Map(Object.entries(e))])});const n=null!==(s=t.options)&&void 0!==s?s:{};Object.entries(n).forEach(([e,t])=>this._options.set(e,t));const r=null!==(a=t.metadata)&&void 0!==a?a:{};Object.entries(r).forEach(([e,t])=>this._metadata.set(e,t));const o=null!==(i=t.outputs)&&void 0!==i?i:{};Object.entries(o).forEach(([e,t])=>this._outputs.set(e,t))})}get metadataChanged(){return this._metadataChanged}objectExists(e){return Boolean(this._getObjectAsYMapByName(e))}getObjectByName(e){const t=this._getObjectAsYMapByName(e);if(t)return c.JSONExt.deepCopy(t.toJSON())}getDependants(e){const t=[],s=new Map;for(const e of this._objects){const t=e.get("dependencies")||[],a=e.get("name");t.forEach(e=>{const t=s.get(e);t?t.add(a):s.set(e,new Set([a]))})}const a=s.get(e);if(!a)return[];for(;a.size;)[...a].forEach(e=>{var i;t.push(e),a.delete(e),null===(i=s.get(e))||void 0===i||i.forEach(e=>a.add(e))});return t}removeObjects(e){this.transact(()=>{for(const t of e)this.removeObjectByName(t)})}removeObjectByName(e){let t=0;for(const s of this._objects){if(s.get("name")===e)break;t++}this._objects.length>t&&(this._objects.delete(t),this.removeOutput(e))}addObject(e){this.addObjects([e])}addObjects(e){this.transact(()=>{e.map(e=>{this.objectExists(e.name)?console.error("There is already an object with the name:",e.name):this._objects.push([new l.Map(Object.entries(e))])})})}updateObjectByName(e,t){const s=this._getObjectAsYMapByName(e);if(!s)return;const{key:a,value:i}=t.data;this.transact(()=>{if("parameters"===a)switch(s.get("shape")){case"Part::Cut":s.set("dependencies",[i.Base,i.Tool]);break;case"Part::Extrusion":case"Part::Fillet":case"Part::Chamfer":s.set("dependencies",[i.Base]);break;case"Part::MultiCommon":case"Part::MultiFuse":s.set("dependencies",i.Shapes)}s.set(a,i),t.meta&&s.set("shapeMetadata",t.meta)})}getOption(e){const t=this._options.get(e);if(t)return c.JSONExt.deepCopy(t)}setOption(e,t){this.transact(()=>{this._options.set(e,t)})}setOptions(e){this.transact(()=>{for(const[t,s]of Object.entries(e))this._options.set(t,s)})}getMetadata(e){return this._metadata.get(e)}setMetadata(e,t){this.transact(()=>{this._metadata.set(e,t)})}removeMetadata(e){this._metadata.has(e)&&this._metadata.delete(e)}getOutput(e){return this._outputs.get(e)}setOutput(e,t){this.transact(()=>{this._outputs.set(e,t)})}removeOutput(e){this._outputs.has(e)&&this._outputs.delete(e)}setShapeMeta(e,t){const s=this._getObjectAsYMapByName(e);t&&s&&this.transact(()=>{s.set("shapeMetadata",t)})}static create(){return new g}_getObjectAsYMapByName(e){for(const t of this._objects)if(t.get("name")===e)return t}}const _=JSON.parse('{"type":"object","title":"IJCadContent","required":["objects"],"additionalProperties":false,"properties":{"schemaVersion":{"type":"string","default":"3.0.0"},"objects":{"$ref":"#/definitions/jcadModel"},"options":{"$ref":"#/definitions/jcadOptions"},"metadata":{"type":"object","patternProperties":{"^.*$":{"type":"string"}},"additionalProperties":false},"outputs":{"type":"object","additionalProperties":false,"patternProperties":{"^.*$":{"type":"string"}}}},"definitions":{"parts":{"type":"string","enum":["Part::Any","Part::Box","Part::Cylinder","Part::Sphere","Part::Cone","Part::Torus","Part::Cut","Part::MultiFuse","Part::MultiCommon","Part::Extrusion","Part::Chamfer","Part::Fillet","Sketcher::SketchObject","Post::Operator"]},"shapeMetadata":{"title":"IShapeMetadata","type":"object","additionalProperties":false,"properties":{"shapeFormat":{"type":"string"},"workerId":{"type":"string"},"mass":{"type":"number"},"centerOfMass":{"type":"array","items":{"type":"number"}},"matrixOfInertia":{"type":"array","items":{"type":"array","items":{"type":"number"}}}}},"jcadObject":{"title":"IJCadObject","type":"object","additionalProperties":false,"required":["name","visible"],"properties":{"name":{"type":"string"},"visible":{"type":"boolean"},"shape":{"$ref":"#/definitions/parts"},"parameters":{"type":"object"},"shapeMetadata":{"$ref":"#/definitions/shapeMetadata"},"operators":{"type":"array","items":{"type":"object"}},"dependencies":{"type":"array","items":{"type":"string"}}}},"jcadModel":{"title":"IJCadModel","type":"array","default":[],"items":{"$ref":"#/definitions/jcadObject"}},"jcadOptions":{"title":"IJCadOptions","type":"object","default":{},"additionalProperties":false,"properties":{}}}}'),u="@jupytercad/jupytercad-core:jupytercad-settings";class m{constructor(e){this.collaborative=!0,this._onSharedModelChanged=(e,t)=>{var s;t&&(null===(s=null==t?void 0:t.objectChange)||void 0===s?void 0:s.length)&&(this._contentChanged.emit(void 0),this.dirty=!0)},this._onClientStateChanged=e=>{const t=this.sharedModel.awareness.getStates();this._clientStateChanged.emit(t),(e.added.length||e.removed.length)&&this._userChanged.emit(this.users)},this.defaultKernelName="",this.defaultKernelLanguage="",this._dirty=!1,this._readOnly=!1,this._isDisposed=!1,this._jcadSettings={showAxesHelper:!1,cameraType:"Perspective"},this._userChanged=new r.Signal(this),this._disposed=new r.Signal(this),this._contentChanged=new r.Signal(this),this._stateChanged=new r.Signal(this),this._themeChanged=new r.Signal(this),this._clientStateChanged=new r.Signal(this),this._sharedMetadataChanged=new r.Signal(this),this._sharedOptionsChanged=new r.Signal(this),this._sharedObjectsChanged=new r.Signal(this),this._sharedModelSwapped=new r.Signal(this);const{annotationModel:t,sharedModel:s,settingRegistry:a}=e;this._sharedModel=s||this.createSharedModel(),this._connectSignal(),this.annotationModel=t,this.settingRegistry=a,this._copiedObject=null,this._pathChanged=new r.Signal(this),this._settingsChanged=new r.Signal(this)}async initSettings(){if(this.settingRegistry)try{const e=await this.settingRegistry.load(u);this._settings=e,this._updateLocalSettings(),e.changed.connect(this._onSettingsChanged,this)}catch(e){console.error(`Failed to load settings for ${u}:`,e),this._jcadSettings={showAxesHelper:!1,cameraType:"Perspective"}}else this._jcadSettings={showAxesHelper:!1,cameraType:"Perspective"}}_onSettingsChanged(){const e=this._jcadSettings;this._updateLocalSettings();const t=this._jcadSettings;e.showAxesHelper!==t.showAxesHelper&&this._settingsChanged.emit("showAxesHelper"),e.cameraType!==t.cameraType&&this._settingsChanged.emit("cameraType")}_updateLocalSettings(){var e,t;const s=this._settings.composite;this._jcadSettings={showAxesHelper:null!==(e=s.showAxesHelper)&&void 0!==e&&e,cameraType:null!==(t=s.cameraType)&&void 0!==t?t:"Perspective"}}get jcadSettings(){return this._jcadSettings}get settingsChanged(){return this._settingsChanged}emitSettingChanged(e){this._settingsChanged.emit(e)}async getSettings(){return this._settings}get sharedModel(){return this._sharedModel}get isDisposed(){return this._isDisposed}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get themeChanged(){return this._themeChanged}get currentUserId(){var e;return null===(e=this.sharedModel)||void 0===e?void 0:e.awareness.clientID}get users(){var e;this._usersMap=null===(e=this.sharedModel)||void 0===e?void 0:e.awareness.getStates();const t=[];return this._usersMap&&this._usersMap.forEach((e,s)=>{t.push({userId:s,userData:e.user})}),t}get userChanged(){return this._userChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get localState(){return this.sharedModel.awareness.getLocalState()}get contentsManager(){return this._contentsManager}set contentsManager(e){this._contentsManager=e}get clientStateChanged(){return this._clientStateChanged}get sharedMetadataChanged(){return this._sharedMetadataChanged}get sharedOptionsChanged(){return this._sharedOptionsChanged}get sharedObjectsChanged(){return this._sharedObjectsChanged}get sharedModelSwapped(){return this._sharedModelSwapped}get filePath(){return this._filePath}set filePath(e){this._filePath=e,this._pathChanged.emit(e)}get pathChanged(){return this._pathChanged}get disposed(){return this._disposed}swapSharedModel(e){this._disconnectSignal(),this._sharedModel.dispose(),this._sharedModel=e,this._connectSignal(),this._sharedObjectsChanged.emit({objectChange:[]}),this._sharedModelSwapped.emit()}dispose(){this._isDisposed||(this._isDisposed=!0,this._disconnectSignal(),this._sharedModel.dispose(),this._disposed.emit(),r.Signal.clearData(this))}toString(){return JSON.stringify(this.getContent(),null,2)}fromString(e){const t=JSON.parse(e),s=(new(h())).compile(_);if(!s(t)){let e="JupyterCAD File format invalid:\n";for(const t of s.errors||[])e=`${e}- ${t.instancePath} ${t.message}\n`;console.warn(e)}this.sharedModel.transact(()=>{var e;this.sharedModel.addObjects(t.objects),this.sharedModel.setOptions(null!==(e=t.options)&&void 0!==e?e:{})}),this.dirty=!0}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}initialize(){}getWorker(){return m.worker}getContent(){return{objects:this.sharedModel.objects,options:this.sharedModel.options}}getAllObject(){return this.sharedModel.objects}syncPointer(e,t){this.sharedModel.awareness.setLocalStateField("pointer",{value:e,emitter:t})}syncCamera(e,t){this.sharedModel.awareness.setLocalStateField("camera",{value:e,emitter:t})}syncSelected(e,t){this.sharedModel.awareness.setLocalStateField("selected",{value:e,emitter:t})}syncSelectedPropField(e){this.sharedModel.awareness.setLocalStateField("selectedPropField",e)}setUserToFollow(e){this.sharedModel&&this.sharedModel.awareness.setLocalStateField("remoteUser",e)}syncFormData(e){this.sharedModel&&this.sharedModel.awareness.setLocalStateField("toolbarForm",e)}getClientId(){return this.sharedModel.awareness.clientID}addMetadata(e,t){this.sharedModel.setMetadata(e,t)}removeMetadata(e){this.sharedModel.removeMetadata(e)}setCopiedObject(e){this._copiedObject=e?Object.assign({},e):null}getCopiedObject(){return this._copiedObject?Object.assign({},this._copiedObject):null}createSharedModel(){return g.create()}_connectSignal(){this._sharedModel.changed.connect(this._onSharedModelChanged),this._sharedModel.awareness.on("change",this._onClientStateChanged),this._sharedModel.metadataChanged.connect(this._metadataChangedHandler,this),this._sharedModel.optionsChanged.connect(this._optionsChangedHandler,this),this._sharedModel.objectsChanged.connect(this._objectsChangedHandler,this)}_disconnectSignal(){this._sharedModel.changed.disconnect(this._onSharedModelChanged),this._sharedModel.awareness.off("change",this._onClientStateChanged),this._sharedModel.metadataChanged.disconnect(this._metadataChangedHandler,this),this._sharedModel.optionsChanged.disconnect(this._optionsChangedHandler,this),this._sharedModel.objectsChanged.disconnect(this._objectsChangedHandler,this)}_metadataChangedHandler(e,t){this._sharedMetadataChanged.emit(t)}_optionsChangedHandler(e,t){this._sharedOptionsChanged.emit(t)}_objectsChangedHandler(e,t){this._sharedObjectsChanged.emit(t)}}const S=new c.Token("jupyterCadDocTracker"),C=new c.Token("jupytercadAnnotationModel"),y=new c.Token("jupytercadWorkerRegistry"),j=new c.Token("jupytercadFormSchemaRegistry"),b=new c.Token("jupytercadExternalCommandRegistry")}}]);
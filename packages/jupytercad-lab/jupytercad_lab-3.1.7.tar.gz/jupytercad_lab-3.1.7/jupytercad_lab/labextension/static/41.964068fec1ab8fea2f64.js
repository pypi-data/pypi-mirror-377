(self.webpackChunk_jupytercad_jupytercad_lab=self.webpackChunk_jupytercad_jupytercad_lab||[]).push([[41],{41:(e,t,n)=>{"use strict";n.r(t),n.d(t,{ForkManager:()=>pt,IForkManagerToken:()=>ht,JUPYTER_COLLABORATION_FORK_EVENTS_URI:()=>ut,NotebookCellServerExecutor:()=>Le,ROOM_FORK_URL:()=>Ne,TimelineWidget:()=>dt,WebSocketAwarenessProvider:()=>Ue,WebSocketProvider:()=>We,YDrive:()=>Je,requestAPI:()=>$e,requestDocSession:()=>je,requestDocumentTimeline:()=>Oe,requestUndoRedo:()=>Pe});var s=n(206);const r=()=>new Map,o=(e,t,n)=>{let s=e.get(t);return void 0===s&&e.set(t,s=n()),s},i=()=>new Set,a=String.fromCharCode,c=(String.fromCodePoint,a(65535),/^\s*/g),l=/([A-Z])/g,d=(e,t)=>(e=>e.replace(c,""))(e.replace(l,e=>`${t}${(e=>e.toLowerCase())(e)}`)),h="undefined"!=typeof TextEncoder?new TextEncoder:null,u=h?e=>h.encode(e):e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.codePointAt(e);return s};let p="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});p&&1===p.decode(new Uint8Array).length&&(p=null);let f=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},m=!0;try{"undefined"!=typeof localStorage&&localStorage&&(f=localStorage,m=!1)}catch(e){}const g=f,y=Array.from,v=(Array.isArray,Object.assign,Object.keys),w=(Object.values,e=>v(e).length),b=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),_=(Object.freeze,Symbol("Equality")),S=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[_])return e[_](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break;case Set:if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break;case Map:if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!S(e.get(n),t.get(n)))return!1;break;case Object:if(w(e)!==w(t))return!1;for(const n in e)if(!b(e,n)||!S(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!S(e[n],t[n]))return!1;break;default:return!1}return!0};var k=n(907);const C=void 0!==k&&k.release&&/node|io\.js/.test(k.release.name)&&"[object process]"===Object.prototype.toString.call(void 0!==k?k:0),T="undefined"!=typeof window&&"undefined"!=typeof document&&!C;let U;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);const E=[],I=e=>(()=>{if(void 0===U)if(C){U=r();const e=k.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];"-"===s[0]?(null!==t&&U.set(t,""),t=s):null!==t?(U.set(t,s),t=null):E.push(s)}null!==t&&U.set(t,"")}else"object"==typeof location?(U=r(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,n]=e.split("=");U.set(`--${d(t,"-")}`,n),U.set(`-${d(t,"-")}`,n)}})):U=r();return U})().has(e),R=e=>{return void 0===(t=C?k.env[e.toUpperCase().replaceAll("-","_")]:g.getItem(e))?null:t;var t},x=e=>I("--"+e)||null!==R(e),L=((x("production"),C&&(N=k.env.FORCE_COLOR,["true","1","2"].includes(N)))||!I("--no-colors")&&!x("no-color")&&(!C||k.stdout.isTTY)&&(!C||I("--color")||null!==R("COLORTERM")||(R("TERM")||"").includes("color")),e=>new Uint8Array(e)),D=T?e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=a(e[n]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),M=T?e=>{const t=atob(e),n=L(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}:e=>{const t=Buffer.from(e,"base64");return n=t.buffer,s=t.byteOffset,r=t.byteLength,new Uint8Array(n,s,r);var n,s,r},A=new Map;var N;const $="undefined"==typeof BroadcastChannel?class{constructor(e){var t;this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:M(t.newValue||"")}),t=this._onChange,m||addEventListener("storage",t)}postMessage(e){g.setItem(this.room,D(new Uint8Array(e)))}close(){var e;e=this._onChange,m||removeEventListener("storage",e)}}:BroadcastChannel,j=e=>o(A,e,()=>{const t=i(),n=new $(e);return n.onmessage=e=>t.forEach(t=>t(e.data,"broadcastchannel")),{bc:n,subs:t}}),O=(e,t,n=null)=>{const s=j(e);s.bc.postMessage(t),s.subs.forEach(e=>e(t,n))},P=Date.now,F=Math.floor,B=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,(e,t)=>e<t?e:t),W=(Number.isNaN,Math.pow),H=(Math.sign,128),J=127;class q{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const z=()=>new q,V=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},K=e=>{const t=new Uint8Array(V(e));let n=0;for(let s=0;s<e.bufs.length;s++){const r=e.bufs[s];t.set(r,n),n+=r.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},Y=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},G=(e,t)=>{for(;t>J;)Y(e,H|J&t),t=F(t/128);Y(e,J&t)},Q=new Uint8Array(3e4),X=Q.length/3,Z=h&&h.encodeInto?(e,t)=>{if(t.length<X){const n=h.encodeInto(t,Q).written||0;G(e,n);for(let t=0;t<n;t++)Y(e,Q[t])}else ee(e,u(t))}:(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;G(e,s);for(let t=0;t<s;t++)Y(e,n.codePointAt(t))},ee=(e,t)=>{G(e,t.byteLength),((e,t)=>{const n=e.cbuf.length,s=e.cpos,r=B(n-s,t.length),o=t.length-r;var i,a;e.cbuf.set(t.subarray(0,r),s),e.cpos+=r,o>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array((i=2*n)>(a=o)?i:a),e.cbuf.set(t.subarray(r)),e.cpos=o)})(e,t)};new DataView(new ArrayBuffer(4));const te=Number.MAX_SAFE_INTEGER,ne=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),se=ne("Unexpected end of array"),re=ne("Integer out of Range");class oe{constructor(e){this.arr=e,this.pos=0}}const ie=e=>new oe(e),ae=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,le(e)),ce=e=>e.arr[e.pos++],le=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const s=e.arr[e.pos++];if(t+=(s&J)*n,n*=128,s<H)return t;if(t>te)throw re}throw se},de=p?e=>p.decode(ae(e)):e=>{let t=le(e);if(0===t)return"";{let n=String.fromCodePoint(ce(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(ce(e));else for(;t>0;){const s=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(n))}},he=(e,t)=>{G(e,0);const n=s.encodeStateVector(t);ee(e,n)},ue=(e,t,n)=>{G(e,1),ee(e,s.encodeStateAsUpdate(t,n))},pe=(e,t,n)=>{try{s.applyUpdate(t,ae(e),n)}catch(e){console.error("Caught error while handling a Yjs update",e)}},fe=pe;class me{constructor(){this._observers=r()}on(e,t){o(this._observers,e,i).add(t)}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return y((this._observers.get(e)||r()).values()).forEach(e=>e(...t))}destroy(){this._observers=r()}}class ge extends me{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=P();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((n,s)=>{s!==this.clientID&&3e4<=e-n.lastUpdated&&this.states.has(s)&&t.push(s)}),t.length>0&&ye(this,t,"timeout")},F(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,n=this.meta.get(t),s=void 0===n?0:n.clock+1,r=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:s,lastUpdated:P()});const o=[],i=[],a=[],c=[];null===e?c.push(t):null==r?null!=e&&o.push(t):(i.push(t),S(r,e)||a.push(t)),(o.length>0||a.length>0||c.length>0)&&this.emit("change",[{added:o,updated:a,removed:c},"local"]),this.emit("update",[{added:o,updated:i,removed:c},"local"])}setLocalStateField(e,t){const n=this.getLocalState();null!==n&&this.setLocalState({...n,[e]:t})}getStates(){return this.states}}const ye=(e,t,n)=>{const s=[];for(let n=0;n<t.length;n++){const r=t[n];if(e.states.has(r)){if(e.states.delete(r),r===e.clientID){const t=e.meta.get(r);e.meta.set(r,{clock:t.clock+1,lastUpdated:P()})}s.push(r)}}s.length>0&&(e.emit("change",[{added:[],updated:[],removed:s},n]),e.emit("update",[{added:[],updated:[],removed:s},n]))},ve=(e,t,n=e.states)=>{const s=t.length,r=z();G(r,s);for(let o=0;o<s;o++){const s=t[o],i=n.get(s)||null,a=e.meta.get(s).clock;G(r,s),G(r,a),Z(r,JSON.stringify(i))}return K(r)};var we=n(907);const be=[];be[0]=(e,t,n,s,r)=>{G(e,0);const o=((e,t,n,s)=>{const r=le(e);switch(r){case 0:((e,t,n)=>{ue(t,n,ae(e))})(e,t,n);break;case 1:pe(e,n,s);break;case 2:fe(e,n,s);break;default:throw new Error("Unknown message type")}return r})(t,e,n.doc,n);s&&1===o&&!n.synced&&(n.synced=!0)},be[3]=(e,t,n,s,r)=>{G(e,1),ee(e,ve(n.awareness,Array.from(n.awareness.getStates().keys())))},be[1]=(e,t,n,s,r)=>{((e,t,n)=>{const s=ie(t),r=P(),o=[],i=[],a=[],c=[],l=le(s);for(let t=0;t<l;t++){const t=le(s);let n=le(s);const l=JSON.parse(de(s)),d=e.meta.get(t),h=e.states.get(t),u=void 0===d?0:d.clock;(u<n||u===n&&null===l&&e.states.has(t))&&(null===l?t===e.clientID&&null!=e.getLocalState()?n++:e.states.delete(t):e.states.set(t,l),e.meta.set(t,{clock:n,lastUpdated:r}),void 0===d&&null!==l?o.push(t):void 0!==d&&null===l?c.push(t):null!==l&&(S(l,h)||a.push(t),i.push(t)))}(o.length>0||a.length>0||c.length>0)&&e.emit("change",[{added:o,updated:a,removed:c},n]),(o.length>0||i.length>0||c.length>0)&&e.emit("update",[{added:o,updated:i,removed:c},n])})(n.awareness,ae(t),n)},be[2]=(e,t,n,s,r)=>{((e,t,n)=>{0===le(e)&&n(0,de(e))})(t,n.doc,(e,t)=>_e(n,t))};const _e=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`),Se=(e,t,n)=>{const s=ie(t),r=z(),o=le(s),i=e.messageHandlers[o];return i?i(r,s,e,n,o):console.error("Unable to compute message"),r},ke=e=>{if(e.shouldConnect&&null===e.ws){const t=new e._WS(e.url);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=n=>{e.wsLastMessageReceived=P();const s=Se(e,new Uint8Array(n.data),!0);V(s)>1&&t.send(K(s))},t.onerror=t=>{e.emit("connection-error",[t,e])},t.onclose=t=>{e.emit("connection-close",[t,e]),e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,ye(e.awareness,Array.from(e.awareness.getStates().keys()).filter(t=>t!==e.doc.clientID),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(ke,B(100*W(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e)},t.onopen=()=>{e.wsLastMessageReceived=P(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const n=z();if(G(n,0),he(n,e.doc),t.send(K(n)),null!==e.awareness.getLocalState()){const n=z();G(n,1),ee(n,ve(e.awareness,[e.doc.clientID])),t.send(K(n))}},e.emit("status",[{status:"connecting"}])}},Ce=(e,t)=>{const n=e.ws;e.wsconnected&&n&&n.readyState===n.OPEN&&n.send(t),e.bcconnected&&O(e.bcChannel,t,e)};class Te extends me{constructor(e,t,n,{connect:s=!0,awareness:r=new ge(n),params:o={},WebSocketPolyfill:i=WebSocket,resyncInterval:a=-1,maxBackoffTime:c=2500,disableBc:l=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);const d=(e=>((e,t)=>{const n=[];for(const s in e)n.push(t(e[s],s));return n})(e,(e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&"))(o);this.maxBackoffTime=c,this.bcChannel=e+"/"+t,this.url=e+"/"+t+(0===d.length?"":"?"+d),this.roomname=t,this.doc=n,this._WS=i,this.awareness=r,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=l,this.wsUnsuccessfulReconnects=0,this.messageHandlers=be.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=s,this._resyncInterval=0,a>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=z();G(e,0),he(e,n),this.ws.send(K(e))}},a)),this._bcSubscriber=(e,t)=>{if(t!==this){const t=Se(this,new Uint8Array(e),!1);V(t)>1&&O(this.bcChannel,K(t),this)}},this._updateHandler=(e,t)=>{if(t!==this){const t=z();G(t,0),((e,t)=>{G(e,2),ee(e,t)})(t,e),Ce(this,K(t))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:t,removed:n},s)=>{const o=e.concat(t).concat(n),i=z();G(i,1),ee(i,ve(r,o)),Ce(this,K(i))},this._exitHandler=()=>{ye(this.awareness,[n.clientID],"app closed")},C&&void 0!==we&&we.on("exit",this._exitHandler),r.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&3e4<P()-this.wsLastMessageReceived&&this.ws.close()},3e3),s&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),C&&void 0!==we&&we.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,j(e).subs.add(t),this.bcconnected=!0);const n=z();G(n,0),he(n,this.doc),O(this.bcChannel,K(n),this);const s=z();G(s,0),ue(s,this.doc),O(this.bcChannel,K(s),this);const r=z();G(r,3),O(this.bcChannel,K(r),this);const o=z();G(o,1),ee(o,ve(this.awareness,[this.doc.clientID])),O(this.bcChannel,K(o),this)}disconnectBc(){const e=z();G(e,1),ee(e,ve(this.awareness,[this.doc.clientID],new Map)),Ce(this,K(e)),this.bcconnected&&(((e,t)=>{const n=j(e);n.subs.delete(t)&&0===n.subs.size&&(n.bc.close(),A.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(ke(this),this.connectBc())}}class Ue extends Te{constructor(e){super(e.url,e.roomID,e.awareness.doc,{awareness:e.awareness}),this._isDisposed=!1,this._awareness=e.awareness,this._user=e.user,this._user.ready.then(()=>this._onUserChanged(this._user)).catch(e=>console.error(e)),this._user.userChanged.connect(this._onUserChanged,this)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._user.userChanged.disconnect(this._onUserChanged,this),this._isDisposed=!0,this.destroy())}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}var Ee=n(436),Ie=n(397),Re=n(566),xe=n(690);class Le{constructor(e){var t;this._serverSettings=null!==(t=e.serverSettings)&&void 0!==t?t:Re.ServerConnection.makeSettings()}async runCell({cell:e,notebook:t,notebookConfig:n,onCellExecuted:s,onCellExecutionScheduled:r,sessionContext:o,sessionDialogs:i,translator:a}){var c,l,d;const h=(a=null!=a?a:xe.nullTranslator).load("jupyterlab");switch(e.model.type){case"markdown":e.rendered=!0,e.inputHidden=!1,s({cell:e,success:!0});break;case"code":if(o){if(o.isTerminating){await(0,Ee.showDialog)({title:h.__("Kernel Terminating"),body:h.__("The kernel for %1 appears to be terminating. You can not run any cell for now.",null===(c=o.session)||void 0===c?void 0:c.path),buttons:[Ee.Dialog.okButton()]});break}if(o.pendingInput)return await(0,Ee.showDialog)({title:h.__("Cell not executed due to pending input"),body:h.__("The cell has not been executed to avoid kernel deadlock as there is another pending input! Submit your pending input and try again."),buttons:[Ee.Dialog.okButton()]}),!1;if(o.hasNoKernel&&await o.startKernel()&&i&&await i.selectKernel(o),o.hasNoKernel)return e.model.sharedModel.transact(()=>{e.model.clearExecution()}),!0;const n=null===(d=null===(l=null==o?void 0:o.session)||void 0===l?void 0:l.kernel)||void 0===d?void 0:d.id,a=Ie.URLExt.join(this._serverSettings.baseUrl,`api/kernels/${n}/execute`),u=e.model.sharedModel.getId(),p=t.sharedModel.getState("document_id"),f={method:"POST",body:JSON.stringify({cell_id:u,document_id:p})};r({cell:e});let m=!1;try{m=(await Re.ServerConnection.makeRequest(a,f,this._serverSettings)).ok}catch(t){if(s({cell:e,success:!1}),e.isDisposed)return!1;throw t}return s({cell:e,success:m}),!0}e.model.sharedModel.transact(()=>{e.model.clearExecution()},!1)}return Promise.resolve(!0)}}const De="api/collaboration/session",Me="api/collaboration/undo_redo",Ae="api/collaboration/timeline",Ne="api/collaboration/fork";async function $e(e="",t={}){const n=Re.ServerConnection.makeSettings(),s=Ie.URLExt.join(n.baseUrl,e);let r;try{r=await Re.ServerConnection.makeRequest(s,t,n)}catch(e){throw new Re.ServerConnection.NetworkError(e)}let o=await r.text();if(o.length>0)try{o=JSON.parse(o)}catch(e){console.error("Not a JSON response body.",r)}if(!r.ok)throw new Re.ServerConnection.ResponseError(r,o.message||o);return o}async function je(e,t,n){const s=Re.ServerConnection.makeSettings(),r=Ie.URLExt.join(s.baseUrl,De,encodeURIComponent(n)),o={method:"PUT",body:JSON.stringify({format:e,type:t})};let i;try{i=await Re.ServerConnection.makeRequest(r,o,s)}catch(e){throw new Re.ServerConnection.NetworkError(e)}let a=await i.text();if(a.length>0)try{a=JSON.parse(a)}catch(e){console.log("Not a JSON response body.",i)}if(!i.ok)throw new Re.ServerConnection.ResponseError(i,a.message||a);return a}async function Oe(e,t,n){const s=Re.ServerConnection.makeSettings();let r=Ie.URLExt.join(s.baseUrl,Ae,n);r=r.concat(`?format=${e}&&type=${t}`);const o={method:"GET"};let i;try{i=await Re.ServerConnection.makeRequest(r,o,s)}catch(e){throw new Re.ServerConnection.NetworkError(e)}return i}async function Pe(e,t,n,s){const r=Re.ServerConnection.makeSettings();let o=Ie.URLExt.join(r.baseUrl,Me,encodeURIComponent(e));o=o.concat(`?action=${t}&&steps=${n}&&forkRoom=${s}`);const i={method:"PUT"};let a;try{a=await Re.ServerConnection.makeRequest(o,i,r)}catch(e){throw new Re.ServerConnection.NetworkError(e)}let c=await a.text();if(c.length>0)try{c=JSON.parse(c)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new Re.ServerConnection.ResponseError(a,c.message||c);return c}var Fe=n(602),Be=n(262);class We{constructor(e){this._onConnectionClosed=e=>{1003===e.code&&(console.error("Document provider closed:",e.reason),(0,Ee.showErrorMessage)(this._trans.__("Document session error"),e.reason,[Ee.Dialog.okButton()]),this._sharedModel.dispose())},this._onSync=e=>{e&&(this._yWebsocketProvider&&(this._yWebsocketProvider.off("sync",this._onSync),this._sharedModel.ydoc.getMap("state").set("document_id",this._yWebsocketProvider.roomname)),this._ready.resolve())},this._ready=new Be.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then(()=>{this._onUserChanged(t)}).catch(e=>console.error(e)),t.userChanged.connect(this._onUserChanged,this),this._connect().catch(e=>console.warn(e))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}get contentType(){return this._contentType}get format(){return this._format}dispose(){var e,t,n;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(n=this._yWebsocketProvider)||void 0===n||n.destroy(),this._disconnect(),Fe.Signal.clearData(this))}async reconnect(){this._disconnect(),this._connect()}async _connect(){const e=await je(this._format,this._contentType,this._path);this._yWebsocketProvider=new Te(this._serverUrl,`${e.format}:${e.type}:${e.fileId}`,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:e.sessionId},awareness:this._awareness}),this._yWebsocketProvider.on("sync",this._onSync),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)}async connectToForkDoc(e,t){this._disconnect(),this._yWebsocketProvider=new Te(this._serverUrl,e,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:t},awareness:this._awareness})}get wsProvider(){return this._yWebsocketProvider}_disconnect(){var e,t,n;null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(n=this._yWebsocketProvider)||void 0===n||n.destroy(),this._yWebsocketProvider=null}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}const He="true"===Ie.PageConfig.getOption("disableRTC");class Je extends Re.Drive{constructor(e,t,n){super({name:"RTC"}),this._onCreate=(e,t)=>{var n,s;if("string"==typeof e.format)try{const r=new We({url:Ie.URLExt.join(this.serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),o=((null===(n=this._globalAwareness)||void 0===n?void 0:n.getLocalState())||{}).documents||[];o.includes(e.path)||(o.push(`${this.name}:${e.path}`),null===(s=this._globalAwareness)||void 0===s||s.setLocalStateField("documents",o));const i=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(i,r),t.changed.connect(async(n,s)=>{var r;if(!s.stateChange)return;const o=s.stateChange.filter(e=>"hash"===e.name);if(0===o.length)return;o.length>1&&console.error("Unexpected multiple changes to hash value in a single transaction");const i=o[0],a=null!==(r=t.state.path)&&void 0!==r?r:e.path,c=await this.get(a,{content:!1});this._ydriveFileChanged.emit({type:"save",newValue:{...c,hash:i.newValue},oldValue:{hash:i.oldValue}})}),t.disposed.connect(()=>{var t,n;const s=this._providers.get(i);s&&(s.dispose(),this._providers.delete(i));const r=((null===(t=this._globalAwareness)||void 0===t?void 0:t.getLocalState())||{}).documents||[],o=r.indexOf(`${this.name}:${e.path}`);o>-1&&r.splice(o,1),null===(n=this._globalAwareness)||void 0===n||n.setLocalStateField("documents",r)})}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._ydriveFileChanged=new Fe.Signal(this),this._user=e,this._trans=t,this._globalAwareness=n,this._providers=new Map,this.sharedModelFactory=new qe(this._onCreate),super.fileChanged.connect((e,t)=>{this._ydriveFileChanged.emit(t)})}get providers(){return this._providers}dispose(){this.isDisposed||(this._providers.forEach(e=>e.dispose()),this._providers.clear(),super.dispose())}async get(e,t){if(t&&t.format&&t.type){const n=`${t.format}:${t.type}:${e}`,s=this._providers.get(n);if(s){const[n]=await Promise.all([super.get(e,{...t,content:!1}),s.ready]);return{...n,format:t.format}}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const n=`${t.format}:${t.type}:${e}`;if(this._providers.get(n)){const n={type:t.type,format:t.format,content:!1};return this.get(e,n)}}return super.save(e,t)}get fileChanged(){return this._ydriveFileChanged}}class qe{constructor(e){this._onCreate=e,this.collaborative=!He,this.documentFactories=new Map}registerDocumentFactory(e,t){if(this.documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this.documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(this.collaborative&&e.collaborative&&this.documentFactories.has(e.contentType)){const t=this.documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}var ze=n(345),Ve=n.n(ze),Ke=n(591),Ye=n.n(Ke),Ge=n(740),Qe=n.n(Ge),Xe=n(128),Ze=n.n(Xe),et=n(855),tt=n.n(et),nt=n(51),st=n.n(nt),rt=n(656),ot=n.n(rt),it=n(858),at={};at.styleTagTransform=ot(),at.setAttributes=tt(),at.insert=Ze().bind(null,"head"),at.domAPI=Qe(),at.insertStyleElement=st(),Ye()(it.A,at),it.A&&it.A.locals&&it.A.locals;var ct=n(760);const lt=({apiURL:e,provider:t,contentType:n,format:s,documentTimelineUrl:r})=>{const[o,i]=(0,ze.useState)({roomId:"",timestamps:[],forkRoom:"",sessionId:""}),[a,c]=(0,ze.useState)(o.timestamps.length-1),[l,d]=(0,ze.useState)(!1),[h,u]=(0,ze.useState)(!1),p=(0,ze.useRef)(!0),f=(0,ze.useRef)(!0),m=(0,ze.useRef)(null);function g(e){try{const t=new URL(e).pathname,n=t.lastIndexOf(r);if(-1===n)throw new Error(`API segment "${r}" not found in URL.`);return t.slice(n+r.length)}catch(e){return console.error("Invalid URL or unable to extract filename:",e),""}}return Ve().createElement("div",{className:"jp-sliderContainer"},Ve().createElement("div",{onClick:()=>{!async function(r){try{if(p.current){const o=await Oe(s,n,r);if(!o.ok)throw 404===o.status?new Error("Not found"):503===o.status?new Error("WebSocket closed"):new Error(`Failed to fetch data: ${o.statusText}`);const a=await o.text();let l={roomId:"",timestamps:[],forkRoom:"",sessionId:""};return a&&(Ee.Notification.warning("Document is now in read-only mode. Changes will not be saved.",{autoClose:2500}),l=JSON.parse(a),i(l),c(l.timestamps.length-1),t.connectToForkDoc(l.forkRoom,l.sessionId),m.current=await je(s,n,g(e))),d(!0),p.current=!1,l}}catch(e){console.error("Error fetching data:",e)}}(g(e))},className:"jp-mod-highlighted",title:"Document Timeline"},Ve().createElement(ct.historyIcon.react,{marginRight:"4px"})),l&&Ve().createElement("div",{className:"jp-timestampDisplay"},Ve().createElement("input",{type:"range",min:0,max:o.timestamps.length-1,value:a,onChange:async e=>{const t=parseInt(e.target.value),n=Math.abs(t-a);try{const e=function(e){return e<a?"undo":"redo"}(t);if(c(t),f.current&&(u(!0),f.current=!1),!m.current)return void console.error("Session is not initialized");await Pe(`${m.current.format}:${m.current.type}:${m.current.fileId}`,e,n,o.forkRoom)}catch(e){console.error("Error fetching or applying updates:",e)}},className:"jp-Slider"}),Ve().createElement("div",null,Ve().createElement("strong",null,g(e).split("/").pop()," ")," "),h&&Ve().createElement("div",{className:"jp-restoreBtnContainer"},Ve().createElement("button",{onClick:async()=>{if(!m.current)return void console.error("Session is not initialized");const e=await Pe(`${m.current.format}:${m.current.type}:${m.current.fileId}`,"restore",0,o.forkRoom);200===e.code?(Ee.Notification.success(e.status,{autoClose:4e3}),t.reconnect(),d(!1),p.current=!0):Ee.Notification.error(e.status,{autoClose:4e3})},className:"jp-ToolbarButtonComponent jp-restoreBtn"},"Restore version"," ",(e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`})(o.timestamps[a])))))};class dt extends Ee.ReactWidget{constructor(e,t,n,s,r){super(),this.apiURL=e,this.provider=t,this.contentType=n,this.format=s,this.documentTimelineUrl=r,this.addClass("jp-timelineSliderWrapper")}render(){return ze.createElement(lt,{key:this.apiURL,apiURL:this.apiURL,provider:this.provider,contentType:this.contentType,format:this.format,documentTimelineUrl:this.documentTimelineUrl})}updateContent(e,t){this.apiURL=e,this.provider=t,this.contentType=this.provider.contentType,this.format=this.provider.format,this.update()}}const ht=new Be.Token("@jupyter/docprovider:IForkManagerToken"),ut="https://schema.jupyter.org/jupyter_collaboration/fork/v1";class pt{constructor(e){this._disposed=!1,this._forkAddedSignal=new Fe.Signal(this),this._forkDeletedSignal=new Fe.Signal(this);const{drive:t,eventManager:n}=e;this._drive=t,this._eventManager=n,this._eventManager.stream.connect(this._handleEvent,this)}get isDisposed(){return this._disposed}get forkAdded(){return this._forkAddedSignal}get forkDeleted(){return this._forkDeletedSignal}dispose(){var e;this._disposed||(null===(e=this._eventManager)||void 0===e||e.stream.disconnect(this._handleEvent),this._disposed=!0)}async createFork(e){const{rootId:t,title:n,description:s,synchronize:r}=e,o={method:"PUT",body:JSON.stringify({title:n,description:s,synchronize:r})},i=Ie.URLExt.join(Ne,t);return await $e(i,o)}async getAllForks(e){const t=Ie.URLExt.join(Ne,e);return await $e(t,{method:"GET"})}async deleteFork(e){const{forkId:t,merge:n}=e,s=Ie.URLExt.join(Ne,t),r=Ie.URLExt.objectToQueryString({merge:n});await $e(`${s}${r}`,{method:"DELETE"})}getProvider(e){const{documentPath:t,format:n,type:s}=e,r=this._drive;if(r){const e=r.name;let o=t;return t.startsWith(e)&&(o=t.slice(e.length+1)),r.providers.get(`${n}:${s}:${o}`)}}_handleEvent(e,t){if(t.schema_id===ut)switch(t.action){case"create":this._forkAddedSignal.emit(t);break;case"delete":this._forkDeletedSignal.emit(t)}}}},51:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},128:e=>{"use strict";var t={};e.exports=function(e,n){var s=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(n)}},591:e=>{"use strict";var t=[];function n(e){for(var n=-1,s=0;s<t.length;s++)if(t[s].identifier===e){n=s;break}return n}function s(e,s){for(var o={},i=[],a=0;a<e.length;a++){var c=e[a],l=s.base?c[0]+s.base:c[0],d=o[l]||0,h="".concat(l," ").concat(d);o[l]=d+1;var u=n(h),p={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==u)t[u].references++,t[u].updater(p);else{var f=r(p,s);s.byIndex=a,t.splice(a,0,{identifier:h,updater:f,references:1})}i.push(h)}return i}function r(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var o=s(e=e||[],r=r||{});return function(e){e=e||[];for(var i=0;i<o.length;i++){var a=n(o[i]);t[a].references--}for(var c=s(e,r),l=0;l<o.length;l++){var d=n(o[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}o=c}}},656:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},740:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var s="";n.supports&&(s+="@supports (".concat(n.supports,") {")),n.media&&(s+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(s+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),s+=n.css,r&&(s+="}"),n.media&&(s+="}"),n.supports&&(s+="}");var o=n.sourceMap;o&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleTagTransform(s,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},758:e=>{"use strict";e.exports=function(e){return e[1]}},855:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},858:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var s=n(758),r=n.n(s),o=n(935),i=n.n(o)()(r());i.push([e.id,"/* -----------------------------------------------------------------------------\n| Copyright (c) Jupyter Development Team.\n| Distributed under the terms of the Modified BSD License.\n|---------------------------------------------------------------------------- */\n\n.jp-timelineSliderWrapper .jp-sliderContainer{\n  display: flex;\n  align-items: center;\n}\n\n.jp-Slider {\n  height: 4.5px\n}\n\n#jp-slider-status-bar {\n  display: flex;\n}\n\n.jp-timestampDisplay {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  gap: 6px;\n}\n\n.jp-restoreBtnContainer {\n  width: 192px;\n}\n\n.jp-ToolbarButtonComponent.jp-restoreBtn {\n  cursor: pointer;\n  color: var(--jp-layout-color2);\n  width: 100%;\n  background: var(--jp-accept-color-normal)\n}\n",""]);const a=i},907:e=>{var t,n,s=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(t===setTimeout)return setTimeout(e,0);if((t===r||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:r}catch(e){t=r}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var a,c=[],l=!1,d=-1;function h(){l&&a&&(l=!1,a.length?c=a.concat(c):d=-1,c.length&&u())}function u(){if(!l){var e=i(h);l=!0;for(var t=c.length;t;){for(a=c,c=[];++d<t;)a&&a[d].run();d=-1,t=c.length}a=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{return n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function f(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new p(e,t)),1!==c.length||l||i(u)},p.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=f,s.addListener=f,s.once=f,s.off=f,s.removeListener=f,s.removeAllListeners=f,s.emit=f,s.prependListener=f,s.prependOnceListener=f,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},935:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",s=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),s&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),s&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,s,r,o){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(s)for(var a=0;a<this.length;a++){var c=this[a][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);s&&i[d[0]]||(void 0!==o&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=o),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),r&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=r):d[4]="".concat(r)),t.push(d))}},t}}}]);
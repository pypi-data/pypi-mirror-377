"use strict";(self.webpackChunkjupyterlab_magic_wand=self.webpackChunkjupyterlab_magic_wand||[]).push([[339],{339:(e,t,n)=>{n.r(t),n.d(t,{IMagicProvider:()=>C,default:()=>j});var o=n(256),l=n(10),i=n(980),a=n(345),c=n(760);const s=new c.LabIcon({name:"wand:Icon",svgstr:'<svg\n  viewBox="0 0 24 24"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161">\n    <path\n        d="M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.9959.9959 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"\n    ></path>\n  </g>\n</svg>'}),r=new c.LabIcon({name:"spinner:Icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><circle cx="4" cy="12" r="3" fill="currentColor"><animate id="svgSpinners3DotsFade0" fill="freeze" attributeName="opacity" begin="0;svgSpinners3DotsFade1.end-0.25s" dur="0.75s" values="1;0.2"/></circle><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"><animate fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.15s" dur="0.75s" values="1;0.2"/></circle><circle cx="20" cy="12" r="3" fill="currentColor" opacity="0.3"><animate id="svgSpinners3DotsFade1" fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.3s" dur="0.75s" values="1;0.2"/></circle></svg>'});new c.LabIcon({name:"thumbUp:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161" fill-opacity="0" stroke="#616161" stroke-width="2px">\n    <path\n        d="M1 21h4V9H1zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73z"\n    ></path>\n  </g>\n</svg>'}),new c.LabIcon({name:"thumbDown:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161" fill-opacity="0" stroke="#616161" stroke-width="2px">\n    <path\n        d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2m4 0v12h4V3z"\n    ></path>\n  </g>\n</svg>'});var d=n(436),u=n(835);function m(e){const t=null==e?void 0:e.model.sharedModel.getSource();null==e||e.model.selections;let n=null;if("code"===(null==e?void 0:e.model.type)){const t=e,o=t.outputArea.model.length-1,l=t.outputArea.model.get(o);if(l&&"error"===l.type){const e=l.data["application/vnd.jupyter.error"];e&&(n=e.ename+": "+e.evalue)}}return{cell_id:null==e?void 0:e.model.sharedModel.getId(),type:null==e?void 0:e.model.type,error:n,source:t}}function g(e,t){var n,o,l;const i=null===(o=null===(n=e.model)||void 0===n?void 0:n.cells.get(t))||void 0===o?void 0:o.id;if(i){const t=null===(l=e._findCellById(i))||void 0===l?void 0:l.cell;if(t)return t}}function v(e){const t=function(e){if(!(e instanceof u.DocumentWidget))return null;const{content:t}=e;return t instanceof i.Notebook?t:null}(e);if(!t)return null;const n=t.activeCellIndex,o=t.activeCell;if(!o)return null;const l=m(o),a=g(t,n-1);let c=null;a&&(c=m(a));const s=g(t,n+1);let r=null;return s&&(r=m(s)),{previous:c,current:l,next:r}}function p(e){var t;return null===(t=e.currentWidget)||void 0===t?void 0:t.content.activeCell}function h(e){var t,n;const o=e.currentWidget,l=null==o?void 0:o.content.activeCellIndex;if(void 0!==l&&o)return null===(n=null===(t=o.model)||void 0===t?void 0:t.cells.get(l))||void 0===n?void 0:n.id}function b(e,t){var n,o;const l=t.currentWidget,i=null===(o=null===(n=t.currentWidget)||void 0===n?void 0:n.content._findCellById(e))||void 0===o?void 0:o.cell;if(l&&i)return{cell:i,notebook:l};const a=t.find((t=>{var n;return!!(null===(n=t.content._findCellById(e))||void 0===n?void 0:n.cell)}));return{cell:i,notebook:a}}var w=n(397),f=n(566),_=n(51),y=n(181),k=n(602);class x{constructor(e,t,n){this._pendingCells=new Map,this._completed=new k.Signal(this),this._notebookTracker=e,this._commandRegistry=t,this._options=n,this._commandRegistry.addCommand(this._options.id,{execute:e=>this.execute(e),icon:e=>this.icon(e),label:()=>this.label(),isEnabled:()=>this.isEnabled()})}label(){var e;const t=h(this._notebookTracker);return t&&t in this._pendingCells?null!==(e=this._options.pendingLabel)&&void 0!==e?e:"":this._options.label}icon(e){var t;console.log(this);const n=h(this._notebookTracker);return console.log(n),n&&this._pendingCells.get(n)?(console.log("seen?"),null!==(t=this._options.pendingIcon)&&void 0!==t?t:r):this._options.icon}isEnabled(){const e=h(this._notebookTracker);return!e||!this._pendingCells.get(e)}async execute(e){var t;const n=v(this._notebookTracker.currentWidget),o=p(this._notebookTracker);if(null==o||o.model.setMetadata("editable",null!==(t=this._options.editable)&&void 0!==t&&t),null==o||o.saveEditableState(),!n)return;const l=n.current.cell_id;if(this._options.timeout){const e=setTimeout((()=>{this._pendingCells.delete(l),this._commandRegistry.notifyCommandChanged(this._options.id),this._options.timedOut&&this._options.timedOut({}),null==o||o.model.setMetadata("editable",!0),null==o||o.saveEditableState()}),this._options.timeout);this._pendingCells.set(l,e)}this._options.execute(e),this._commandRegistry.notifyCommandChanged(this._options.id)}async complete(e,t){const n=this._pendingCells.get(e);n&&clearTimeout(n);const{cell:o}=b(e,this._notebookTracker);null==o||o.model.setMetadata("editable",!0),null==o||o.saveEditableState(),this._pendingCells.delete(e),this._commandRegistry.notifyCommandChanged(this._options.id),this._options.complete(t),this._completed.emit(t)}get completed(){return this._completed}}const C=new(n(262).Token)("jupyterlab-magic-wand:IMagicProvider"),I="jupyterlab_magic_wand",M={id:I+":agentCommands",description:"A set of custom commands that AI agents can use.",autoStart:!0,requires:[i.INotebookTracker],activate:async(e,t)=>{console.log(`Jupyter Magic Wand plugin extension activated: ${I}:agentCommands`),e.commands.addCommand("insert-cell-below",{execute:e=>{var n,o;const l=e,i=l.cell_id,a=l.new_cell_id||void 0,c=l.cell_type;if(i){const{notebook:e}=b(i,t),s=null===(n=null==e?void 0:e.model)||void 0===n?void 0:n.sharedModel.cells.findIndex((e=>e.getId()===i));if(void 0!==s&&s>=0){const t=null===(o=null==e?void 0:e.model)||void 0===o?void 0:o.sharedModel.insertCell(s+1,{cell_type:c,metadata:{},id:a});l.source&&(null==t||t.setSource(l.source),null==e||e.update())}}}}),e.commands.addCommand("update-cell-source",{execute:e=>{var n;const o=e,l=o.cell_id;if(l){const{notebook:e}=b(l,t),i=null===(n=null==e?void 0:e.model)||void 0===n?void 0:n.sharedModel.cells.find((e=>e.getId()===l));i&&o.source&&(null==i||i.setSource(o.source),null==e||e.update(),null==e||e.content.update())}}}),e.commands.addCommand("track-if-editted",{execute:async e=>{var n;const o=e.cell_id;if(!o)return;const{cell:l,notebook:i}=b(o,t);if(void 0===l)return;await l.ready;const a=null===(n=null==i?void 0:i.model)||void 0===n?void 0:n.sharedModel.cells.find((e=>e.getId()===o));if(void 0===a)return;function c(e=!1){let t={};try{t=(null==l?void 0:l.model.getMetadata("jupyter_ai"))||{}}catch(e){t={}}const n={...t,editted:e};null==l||l.model.setMetadata("jupyter_ai",n)}c(!1);const s=function(){c(!0),null==a||a.changed.disconnect(s)};null==a||a.changed.connect(s)}})}},S={id:I+":magic-provider",autoStart:!0,provides:C,activate:async e=>({magic:async({codeInput:e,content:t,cellId:n})=>{!async function(e="",t={}){const n=f.ServerConnection.makeSettings(),o=w.URLExt.join(n.baseUrl,e);let l;try{l=await f.ServerConnection.makeRequest(o,t,n)}catch(e){throw new f.ServerConnection.NetworkError(e)}let i=await l.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",l)}if(!l.ok)throw new f.ServerConnection.ResponseError(l,i.message||i)}("/api/ai/magic",{method:"POST",body:JSON.stringify({request:{input:e,context:{cell_id:n,content:t},commands:[]}})})}})},j=[{id:I+":button",description:"A cell tracker for the magic wand button.",autoStart:!0,requires:[i.INotebookTracker,_.IEventListener,y.ICellFooterTracker,C],optional:[l.ISettingRegistry],activate:async(e,t,n,l,i)=>{console.log(`Jupyter Magic Wand plugin extension activated: ${I}:button`),await e.serviceManager.ready;const c=new x(t,e.commands,{id:"jupyterlab_magic_wand:execute",label:"AI, please help!",pendingLabel:"AI is thinking...",icon:s,timeout:1e4,execute:async()=>{var e,n,o;const l=t.currentWidget,a=v(l),c=p(t);if(!a)return void console.log("AI Command not focused on a cell.");const s=a.current.cell_id,r=null!==(n=null===(e=null==c?void 0:c.model)||void 0===e?void 0:e.sharedModel.getSource())&&void 0!==n?n:"",d=null===(o=null==l?void 0:l.content.model)||void 0===o?void 0:o.toJSON();await i.magic({cellId:s,codeInput:r,content:d})},complete:n=>{const i=n,a=i.context.cell_id;if(a){const{cell:e}=b(a,t);null==e||e.model.setMetadata("editable",!0),null==e||e.saveEditableState();const n={...null==e?void 0:e.model.getMetadata("jupyter_ai"),agent:i.agent,messages:i.messages};if(null==e||e.model.setMetadata("jupyter_ai",n),e){const e=l.getFooter(a);null==e||e.removeToolbarItem("magicIcon");const t=new o.Widget({node:s.element()});t.addClass("jp-Toolbar-Icon"),null==e||e.addToolbarItemOnLeft("magicIcon",t),l.showFooter(a)}}i.commands&&i.commands.forEach((async t=>{try{await e.commands.execute(t.name,t.args)}catch(e){console.log("Could not execute AI command: "+t.name),console.error(e)}}))},error:()=>{}});n.addListener("https://events.jupyter.org/jupyter-ai/agents/Magic+Button+Agent/state",(async(e,t,n)=>{const o=n;await c.complete(o.context.cell_id,o)})),n.addListener("https://events.jupyter.org/jupyter_ai/error/v1",(async(e,n,o)=>{const l=o,{cell:i}=b(l.state.context.cell_id,t);null==i||i.model.setMetadata("editable",!0),null==i||i.saveEditableState(),d.Notification.error("An error occurred with the AI Magic button.",{autoClose:5e3,actions:[{label:"Read more",callback:()=>{var e,t;e=l.error_type,t=l.message,(0,d.showDialog)({title:a.createElement("div",{className:"jp-MagicDialog-header"},a.createElement(s.react,{tag:"div",className:"jp-MagicDialog-icon"}),a.createElement("div",{className:"jp-MagicDialog-title"},"Oops! ",e)),body:a.createElement("div",null,a.createElement("p",null),a.createElement("pre",{className:"jp-MagicDialog-code"},a.createElement("code",null,t)),a.createElement("p",null,"We recommend that you try again. If the problem persists, please open an issue on Github!")),buttons:[d.Dialog.okButton()]})}}]})}))}},M,S]}}]);
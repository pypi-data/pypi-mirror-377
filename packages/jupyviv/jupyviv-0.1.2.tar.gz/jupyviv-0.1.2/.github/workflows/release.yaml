name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    # write release notes from tag message & add "compare" link
    name: Release
    runs-on: ubuntu-latest
    steps:
      # we check out the repo to get information from tags
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      # release notes ----------------------------------------------------------
      # actions/checkout seems to have a bug where annotated tags are converted
      # to simple tags so we have to fetch them explicitly again
      # https://github.com/actions/checkout/issues/882
      - run: git fetch --tags --force origin
      - name: build release notes
        run: |
          echo -e "## What's changed\n" \
              > release.md
          git tag -l --format="%(contents)" ${{ github.ref_name }} | sed '/^-----BEGIN PGP SIGNATURE-----/,$d' \
              >> release.md
          echo -e "\n**Full changelog**: https://github.com/jannis-baum/jupyviv/compare/$(git tag --sort=version:refname | tail -2 | head -1)...${{ github.ref_name }}" \
              >> release.md
      - name: print release notes for logs
        run: cat release.md

      # release ----------------------------------------------------------------
      - name: release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          body_path: release.md

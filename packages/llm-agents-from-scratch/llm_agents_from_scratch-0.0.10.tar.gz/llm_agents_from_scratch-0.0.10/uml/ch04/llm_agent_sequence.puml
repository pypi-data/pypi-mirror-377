@startuml
!include ../common/book-clean.puml

actor user
participant "llm_agent: LLMAgent" as LLMAgent

user -> user : creates task: Task
hnote left: 1

user -> LLMAgent : wants to run task

activate LLMAgent
create participant "task_handler: TaskHandler" as TaskHandler <<Awaitable>>
LLMAgent -> TaskHandler : <<creates>> run(task)
hnote left: 2
LLMAgent -> TaskHandler : <<starts>> process loop
activate TaskHandler
hnote right: 3

LLMAgent --> user : task_handler
deactivate LLMAgent

loop
    TaskHandler -> TaskHandler : get_next_step()
    hnote left: 4a
    activate TaskHandler #DarkGrey
    deactivate TaskHandler
    TaskHandler -> TaskHandler : run_step()
    hnote left: 4b
    activate TaskHandler #DarkGrey
    deactivate TaskHandler
end

alt success
    TaskHandler -> TaskHandler : set_result()
    hnote left: 5a
else exception
    TaskHandler -> TaskHandler : set_exception()
    hnote left: 5b
end

TaskHandler --> user : <<done>> task_handler
hnote left: 6
@enduml

# MCP ä»£ç†æ¶æ„è®¾è®¡

## ğŸ¯ è®¾è®¡ç›®æ ‡

æä¾›ä¸€ä¸ª APIï¼Œè®© AI å¯ä»¥æ ¹æ® MCP æœåŠ¡åå°† MCP è¯·æ±‚ä»£ç†åˆ°å¯¹åº”çš„ MCP ç«¯å£ï¼Œå®ç°ç»Ÿä¸€çš„ MCP æœåŠ¡è®¿é—®æ¥å£ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AI å®¢æˆ·ç«¯                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   AIåº”ç”¨    â”‚  â”‚   AIæ¨¡å‹    â”‚  â”‚   AIå·¥å…·    â”‚  â”‚   å…¶ä»–AI    â”‚            â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚   å®¢æˆ·ç«¯    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼ MCP è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MCP Minder ä»£ç†å±‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    MCP ä»£ç† API                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ è¯·æ±‚è·¯ç”±    â”‚  â”‚ åè®®è§£æ    â”‚  â”‚ è¿æ¥ç®¡ç†    â”‚  â”‚ é”™è¯¯å¤„ç†    â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ æœåŠ¡å‘ç°    â”‚  â”‚ æ•°æ®è½¬æ¢    â”‚  â”‚ å¥åº·æ£€æŸ¥    â”‚  â”‚ æ—¥å¿—è®°å½•    â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼ è½¬å‘è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            MCP æœåŠ¡å±‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ å¤©æ°”æŸ¥è¯¢    â”‚  â”‚ æ–‡ä»¶ç®¡ç†    â”‚  â”‚ æ•°æ®åº“æŸ¥è¯¢  â”‚  â”‚ å…¶ä»–MCPæœåŠ¡ â”‚            â”‚
â”‚  â”‚ æœåŠ¡        â”‚  â”‚ æœåŠ¡        â”‚  â”‚ æœåŠ¡        â”‚  â”‚             â”‚            â”‚
â”‚  â”‚ :8001       â”‚  â”‚ :8002       â”‚  â”‚ :8003       â”‚  â”‚ :8004       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµæ¶æ„

```mermaid
sequenceDiagram
    participant AI as AIå®¢æˆ·ç«¯
    participant Proxy as MCPä»£ç†API
    participant Manager as ä»£ç†ç®¡ç†å™¨
    participant Service as MCPæœåŠ¡
    participant Storage as æœåŠ¡å­˜å‚¨

    Note over AI, Storage: MCPè¯·æ±‚ä»£ç†æµç¨‹
    AI->>Proxy: POST /api/mcp/proxy
    Note right of AI: {service_name, mcp_request}
    
    Proxy->>Manager: proxy_mcp_request()
    Manager->>Storage: è·å–æœåŠ¡é…ç½®
    Storage-->>Manager: æœåŠ¡ä¿¡æ¯(ç«¯å£ã€ä¸»æœº)
    
    Manager->>Manager: æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
    Manager->>Service: HTTPè¯·æ±‚åˆ°MCPç«¯å£
    Note right of Manager: è½¬å‘MCPè¯·æ±‚
    
    Service-->>Manager: MCPå“åº”
    Manager-->>Proxy: å“åº”æ•°æ®
    Proxy-->>AI: MCPä»£ç†å“åº”
    
    Note over AI, Storage: é”™è¯¯å¤„ç†æµç¨‹
    Service-->>Manager: é”™è¯¯å“åº”
    Manager->>Manager: é”™è¯¯å¤„ç†å’Œé‡è¯•
    Manager-->>Proxy: é”™è¯¯ä¿¡æ¯
    Proxy-->>AI: é”™è¯¯å“åº”
```

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### 1. MCPProxy ç±»
- **èŒè´£**: æ ¸å¿ƒä»£ç†é€»è¾‘
- **åŠŸèƒ½**:
  - æœåŠ¡é…ç½®ç®¡ç†
  - è¿æ¥æ± ç®¡ç†
  - è¯·æ±‚ä»£ç†
  - å¥åº·æ£€æŸ¥
  - é”™è¯¯å¤„ç†

### 2. MCPProxyManager ç±»
- **èŒè´£**: ä»£ç†ç®¡ç†å™¨
- **åŠŸèƒ½**:
  - ä»£ç†è¯·æ±‚è°ƒåº¦
  - æœåŠ¡åˆ—è¡¨ç®¡ç†
  - å¥åº·çŠ¶æ€ç›‘æ§
  - èµ„æºæ¸…ç†

### 3. API ç«¯ç‚¹
- **èŒè´£**: HTTP æ¥å£
- **åŠŸèƒ½**:
  - `/api/mcp/proxy` - ä»£ç†è¯·æ±‚
  - `/api/mcp/services` - æœåŠ¡åˆ—è¡¨
  - `/api/mcp/health` - å¥åº·æ£€æŸ¥

## ğŸ“Š è¯·æ±‚/å“åº”æ¨¡å‹

### MCP ä»£ç†è¯·æ±‚
```json
{
  "service_name": "å¤©æ°”æŸ¥è¯¢å•Š",
  "mcp_request": {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "get_weather",
      "arguments": {
        "city": "åŒ—äº¬"
      }
    }
  }
}
```

### MCP ä»£ç†å“åº”
```json
{
  "success": true,
  "service_name": "å¤©æ°”æŸ¥è¯¢å•Š",
  "response": {
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
      "content": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦25Â°C"
    }
  },
  "timestamp": "2025-01-12T15:30:00.000Z"
}
```

## ğŸ”§ æŠ€æœ¯å®ç°

### è¿æ¥ç®¡ç†
```python
class MCPProxy:
    def __init__(self, service_manager):
        self.connection_pool: Dict[str, httpx.AsyncClient] = {}
    
    async def _get_connection(self, config: MCPProxyConfig):
        connection_key = f"{config.host}:{config.port}"
        if connection_key not in self.connection_pool:
            self.connection_pool[connection_key] = httpx.AsyncClient(
                base_url=f"http://{config.host}:{config.port}",
                timeout=config.timeout
            )
        return self.connection_pool[connection_key]
```

### è¯·æ±‚ä»£ç†
```python
async def proxy_request(self, service_name: str, mcp_request: Dict[str, Any]):
    config = await self.get_service_config(service_name)
    connection = await self._get_connection(config)
    
    response = await connection.post("/mcp", json=mcp_request)
    return response.json()
```

### å¥åº·æ£€æŸ¥
```python
async def _check_service_health(self, config: MCPProxyConfig):
    try:
        connection = await self._get_connection(config)
        response = await connection.get("/health", timeout=5)
        return response.status_code == 200
    except Exception:
        return False
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å¼‚æ­¥ä½¿ç”¨
```python
import asyncio
from minder.client import McpMinder

async def main():
    minder = McpMinder.get_service("http://localhost:8000", "å¤©æ°”æŸ¥è¯¢å•Š")
    
    # è·å–å¯ç”¨æœåŠ¡
    services = await minder.list_mcp_services()
    
    # ä»£ç†è¯·æ±‚
    mcp_request = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "tools/call",
        "params": {"name": "get_weather", "arguments": {"city": "åŒ—äº¬"}}
    }
    
    response = await minder.proxy_mcp_request("å¤©æ°”æŸ¥è¯¢å•Š", mcp_request)
    print(response)

asyncio.run(main())
```

### åŒæ­¥ä½¿ç”¨
```python
from minder.client import McpMinder

minder = McpMinder.get_service("http://localhost:8000", "å¤©æ°”æŸ¥è¯¢å•Š")

# åŒæ­¥ä»£ç†è¯·æ±‚
response = minder.proxy_mcp_request_sync("å¤©æ°”æŸ¥è¯¢å•Š", mcp_request)
print(response)
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯
- MCP è¯·æ±‚æ ¼å¼éªŒè¯
- æœåŠ¡åç™½åå•æ£€æŸ¥
- å‚æ•°ç±»å‹éªŒè¯

### 2. è¿æ¥å®‰å…¨
- æœ¬åœ°è¿æ¥é™åˆ¶
- è¶…æ—¶æ§åˆ¶
- è¿æ¥æ± ç®¡ç†

### 3. é”™è¯¯å¤„ç†
- å¼‚å¸¸æ•è·
- é”™è¯¯ä¿¡æ¯è¿‡æ»¤
- æ—¥å¿—è®°å½•

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± 
- HTTP è¿æ¥å¤ç”¨
- è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
- è¿æ¥æ•°é™åˆ¶

### 2. ç¼“å­˜ç­–ç•¥
- æœåŠ¡é…ç½®ç¼“å­˜
- å¥åº·çŠ¶æ€ç¼“å­˜
- å“åº”ç¼“å­˜

### 3. å¹¶å‘å¤„ç†
- å¼‚æ­¥è¯·æ±‚å¤„ç†
- å¹¶å‘è¿æ¥é™åˆ¶
- è¯·æ±‚é˜Ÿåˆ—ç®¡ç†

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æ—¥å¿—è®°å½•
- è¯·æ±‚/å“åº”æ—¥å¿—
- é”™è¯¯æ—¥å¿—
- æ€§èƒ½æŒ‡æ ‡

### 2. å¥åº·ç›‘æ§
- æœåŠ¡çŠ¶æ€æ£€æŸ¥
- è¿æ¥çŠ¶æ€ç›‘æ§
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†

### 3. è°ƒè¯•å·¥å…·
- è¯·æ±‚è¿½è¸ª
- é”™è¯¯è¯Šæ–­
- æ€§èƒ½åˆ†æ

## ğŸ¯ æ‰©å±•æ€§

### 1. åè®®æ”¯æŒ
- MCP åè®®ç‰ˆæœ¬æ”¯æŒ
- è‡ªå®šä¹‰åè®®æ‰©å±•
- åè®®è½¬æ¢

### 2. æœåŠ¡å‘ç°
- åŠ¨æ€æœåŠ¡å‘ç°
- è´Ÿè½½å‡è¡¡
- æ•…éšœè½¬ç§»

### 3. æ’ä»¶ç³»ç»Ÿ
- è‡ªå®šä¹‰ä»£ç†é€»è¾‘
- ä¸­é—´ä»¶æ”¯æŒ
- æ‰©å±•ç‚¹å®šä¹‰

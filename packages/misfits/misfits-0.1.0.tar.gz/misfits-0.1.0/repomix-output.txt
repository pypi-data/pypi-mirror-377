This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-06-30T14:28:34.609Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

Additional Info:
----------------

================================================================
Directory Structure
================================================================
misfits/
  __init__.py
  app.py
  data.py
  headers.py
  log.py
  logo.py
  misfits.tcss
  mtypes.py
  screens.py
  suggester.py
  utils.py
tests/
  ascii_i4-i20.fits
  ascii.fits
  history_header.fits
  LICENSE.rst
  o4sp040b0_raw.fits
  verify.fits
.gitattributes
.gitignore
conda-env.yml
misfits-vhs.tape
pyproject.toml
README.md

================================================================
Files
================================================================

================
File: misfits/__init__.py
================
import importlib.metadata

__version__ = importlib.metadata.version("misfits")

================
File: misfits/app.py
================
"""
A terminal FITS viewer with interactive tables.

Author: Giuseppe Dilillo
Date:   August 2024
"""

from asyncio import sleep
from asyncio import to_thread
from math import ceil
from pathlib import Path
from typing import Iterable

from astropy.io.fits import FITS_rec
import click
from textual import on
from textual import work
from textual.app import App
from textual.app import ComposeResult
from textual.app import SystemCommand
from textual.containers import Horizontal
from textual.design import ColorSystem
from textual.message import Message
from textual.reactive import reactive
from textual.screen import Screen
from textual.theme import Theme
from textual.widgets import DataTable
from textual.widgets import Footer
from textual.widgets import Input
from textual.widgets import Label
from textual.widgets import Static
from textual.widgets import TabbedContent
from textual.widgets import TabPane
from textual.widgets import Tree
from textual.widgets.tabbed_content import ContentTabs

from misfits.data import _validate_fits
from misfits.data import DataContainer
from misfits.data import get_fits_content
from misfits.headers import AnimatedLabel
from misfits.headers import MainHeader
from misfits.log import log
from misfits.screens import EscapableFileExplorerScreen
from misfits.screens import FileExplorerScreen
from misfits.screens import HeaderEntry
from misfits.screens import InfoScreen
from misfits.screens import LogScreen
from misfits.suggester import PathSuggester
from misfits.utils import catchtime
from misfits.utils import disable_inputs

deepgreen_theme = Theme(
    name="deepgreen",
    primary="#03A062",  # matrix green
    secondary="#03A062",
    warning="#03A062",
    error="#ff0000",
    success="#00ff00",
    accent="#00ff00",
    dark=True,
    variables={
        "block-cursor-text-style": "none",
        "footer-key-foreground": "#88C0D0",
        "input-selection-background": "#81a1c1 35%",
    },
)

# fits table are displayed in small chunks (pages) to achieve better performances.
# this parameter set the number of rows displayed per page within a FitsTable.
PAGE_LEN = 100


class FitsTable(DataTable):
    """Displays fits data as a table arranged in pages."""

    BINDINGS = [
        ("shift+left", "back_page()", "Back"),
        ("shift+right", "next_page()", "Next"),
        ("shift+up", "first_page()", "First"),
        ("shift+down", "last_page()", "Last"),
    ]
    PAGE_DELAY = 1 / 60

    page_no = reactive(1, bindings=True)

    class QuerySucceded(Message):
        """A message to be sent when a query completes."""

        def __init__(self, query_succeded: bool) -> None:
            self.value = query_succeded
            super().__init__()

    def __init__(self, data: DataContainer):
        """
        :param data: a data container, see `misfits.data.DataContainer`.
        """
        super().__init__()
        self.data: DataContainer = data
        self.page_len = PAGE_LEN
        self.mask = None
        self.page_no = 1  # starts from one
        self.page_tot = max(ceil(len(self.data) / self.page_len), 1)
        log.push_data_info(data)

    def on_mount(self):
        self.border_title = "Table"
        self.cursor_type = "cell"
        self.add_columns(*self.data.get_columns())
        self.show_page()

    # runs possibly slow filter operation with a worker to avoid UI lags
    @work(exclusive=True, group="filter_table")
    async def filter_table(self, query: str):
        """
        Filters a table according to a query and shows a table page.

        :param query: the filter query
        """
        # noinspection PyBroadException
        try:
            _ = await to_thread(self.data.query, query)
        except Exception:
            self.post_message(self.QuerySucceded(False))
            return
        self.page_tot = max(ceil(len(self.data) / self.page_len), 1)
        self.show_page()
        self.post_message(self.QuerySucceded(True))
        log.push(
            f"Filtered table by query {repr(query)}, {len(self.data)} matching entries."
        )

    def page_slice(self):
        """Returns a slice comprising entries to be displayed in present page."""
        page = ((self.page_no - 1) * self.page_len, self.page_no * self.page_len)
        return slice(*page)

    def show_page(self):
        """Displays a table page."""
        self.clear(columns=False)
        self.add_rows(rows=self.data.get_rows(self.page_slice()))
        self.border_subtitle = f"page {self.page_no} / {self.page_tot} "

    # the function is on a worker so that, if user keeps page turn pressed
    # page displays won't accumulate in queue, resulting in pages still getting
    # loaded after user releases the button.
    # sleep enforces a maximum turning rate to tot pages per seconds.
    # maybe we can live without that?
    # TODO: make sure `PAGE_DELAY` is needed
    @work(exclusive=True, group="turn_page")
    async def action_next_page(self):
        """Scrolls to next page."""
        await sleep(self.PAGE_DELAY)
        if self.page_no < self.page_tot:
            self.page_no += 1
            self.show_page()

    @work(exclusive=True, group="turn_page")
    async def action_back_page(self):
        """Scrolls to previous page."""
        await sleep(self.PAGE_DELAY)
        if self.page_no > 1:
            self.page_no -= 1
            self.show_page()

    @work(exclusive=True, group="turn_page")
    async def action_last_page(self):
        """Scrolls to last page"""
        await sleep(self.PAGE_DELAY)
        self.page_no = self.page_tot
        self.show_page()

    @work(exclusive=True, group="turn_page")
    async def action_first_page(self):
        """Scrolls to first page"""
        await sleep(self.PAGE_DELAY)
        self.page_no = 1
        self.show_page()

    def check_action(self, action: str, parameters: tuple[object, ...]) -> bool | None:
        """Checks if an action may run or not, if not greys them out in footer."""
        if action in ["first_page", "back_page"] and self.page_no == 1:
            return None
        if action in ["last_page", "next_page"] and self.page_no == self.page_tot:
            return None
        return True

    # TODO: add methods and binding for scrolling to `n` page.


CLEAR_PROMPT_LABEL = "Clear"


class FilterInput(Static):
    """A widget displaying an input prompt for filtering a table"""

    BINDINGS = [
        ("ctrl+n", "clear()", CLEAR_PROMPT_LABEL),
    ]

    class ClearTable(Message):
        """A message to be sent when a query completes."""

        def __init__(self) -> None:
            super().__init__()

    def compose(self) -> ComposeResult:
        with Horizontal():
            yield Label("[dim italic] query: ")
            yield Input(placeholder=f"COL1 > 42 & COL2 == 3")

    def on_mount(self):
        self.border_title = "Filter"

    def action_clear(self):
        self.query_one(Input).value = ""
        self.post_message(self.ClearTable())


class TableDialog(Static):
    """A widget containing the data table and its filter."""

    def __init__(
        self,
        arr: FITS_rec,
        hide_filter: bool = False,
    ):
        """
        :param arr: The fits records data.
        :param hide_filter: Wether if to show the table filter or none. We do not show
        filter for tables which would require huge loading time, such as tables with
        variable length array columns.
        """
        super().__init__()
        self.arr = arr
        self.hide_filter = hide_filter

    def compose(self) -> ComposeResult:
        data = DataContainer(self.arr)
        yield FitsTable(data)
        if data.can_promote:
            yield FilterInput()

    def on_mount(self):
        self.border_title = "Table"

    # async is needed since `filter_table` calls a worker
    @on(Input.Submitted)
    async def maybe_filter_table(self, event: Input.Submitted):
        # noinspection PyAsyncCall
        self.query_one(FitsTable).filter_table(event.value)
        # we prevent bubbling up of the message, which would affect file input prompt
        event.stop()

    @on(FitsTable.QuerySucceded)
    def color_filter_border(self, message: FitsTable.QuerySucceded):
        if message.value:
            self.query_one(FilterInput).remove_class("error")
        else:
            self.query_one(FilterInput).add_class("error")

    @on(FilterInput.ClearTable)
    def reset_fits_table(self, message: FitsTable.QuerySucceded):
        self.query_one(FitsTable).filter_table("")


class EmptyDialog(Static):
    """A placeholder widget for when an HDU contains images or no data."""

    # TODO: Add a separate placeholder for images.

    def compose(self) -> ComposeResult:
        yield Label("No tables to show")

    def on_mount(self):
        self.border_title = "Table"


class HeaderDialog(Tree):
    """Displays a FITS header as a tree."""

    BINDINGS = [
        ("ctrl+s", "colexp_all", "Collapse/Expand all"),
    ]

    def __init__(self, header: dict, ellipsis: int = 14):
        """
        :param header:
        :param ellipsis: sets length after which apply an ellipsis.
        """
        super().__init__(label="root")
        self.leafs = []
        for key, value in header.items():
            node = self.root.add(label=key)
            label = (
                vstr
                if len(vstr := str(value).strip()) < ellipsis
                else vstr[:ellipsis] + ".."
            )
            leaf = node.add_leaf(label, data=str(value))
            self.leafs.append(leaf)

    def on_mount(self):
        self.border_title = "Header"
        self.guide_depth = 3
        self.show_guides = True
        self.root.expand()

    @on(Tree.NodeSelected)
    def display_content_popup(self, event: Tree.NodeSelected):
        """Opens a pop-up when a header entry is selected."""
        if event.node in self.leafs:
            self.app.push_screen(HeaderEntry(event.node.data))

    def action_colexp_all(self):
        """Collaps or expand all header nodes together."""
        if all(node.is_expanded for node in self.root.children):
            for c in self.root.children:
                c.collapse()
        else:  # some of the node is expanded already
            for node in self.root.children:
                if not node.is_expanded:
                    node.expand()


class HDUPane(TabPane):
    """A container for header and table widgets."""

    class FocusedUnpromotableTable(Message):
        """A message to be sent when loading tables we do not fully support."""

        def __init__(self, table_name) -> None:
            self.table_name = table_name
            super().__init__()

    def __init__(self, content: dict, **kwargs):
        self.content = content
        self._name = content["name"] if content["name"].strip() else "HDU"
        self.focused_already = False
        super().__init__(self._name, **kwargs)
        log.push_hdu_info(content)

    def compose(self) -> ComposeResult:
        with Horizontal():
            yield HeaderDialog(self.content["header"])
            if self.content["is_table"]:
                yield TableDialog(self.content["data"])
            else:
                yield EmptyDialog()

    @on(TabPane.Focused)
    def notify(self, _: TabPane.Focused) -> None:
        """This will alert main app to notify we are on a table with limitations."""
        if (
            not self.focused_already
            and self.content["is_table"]
            and not self.query_one(FitsTable).data.can_promote
        ):
            self.post_message(self.FocusedUnpromotableTable(self.content["name"]))
        self.focused_already = True


BROWSE_FILE_LABEL = "Browse files"


class FileInput(Static):
    """A widget showing an input for file paths."""

    BINDINGS = [
        ("ctrl+n", "clear()", CLEAR_PROMPT_LABEL),
    ]

    def compose(self) -> ComposeResult:
        with Horizontal():
            yield Label(f"[dim italic] path: ")
            yield Input(
                placeholder="~/path/to/some/file.fits",
                suggester=PathSuggester(),
            )

    def on_mount(self):
        self.border_title = "File"

    def set_input_value(self, value: str):
        self.query_one(Input).value = value

    def action_clear(self):
        self.query_one(Input).value = ""


class Misfits(App):
    """Misfits, the main app."""

    CSS_PATH = "misfits.tcss"
    SCREENS = {
        "log": LogScreen,
        "file_explorer": FileExplorerScreen,
        "info": InfoScreen,
    }
    BINDINGS = [
        ("ctrl+o", "open_explorer", BROWSE_FILE_LABEL),
        ("ctrl+l", "show_log", "Log"),
        ("ctrl+j", "show_info", "Info"),
    ]

    def __init__(self, filepath: Path | None, root_dir: Path = Path.cwd()) -> None:
        """
        :param filepath: the file to load at startup.
        If `None`, an unescapable file explorer is shown at startup.
        :param root_dir: will set the directory from which file explorers start.
        """
        super().__init__()
        self.filepath = filepath
        self.rootdir = root_dir
        self.fits_content = []
        self.logstack = []

    # `push_screen_wait` requires a worker
    @work
    async def on_mount(self):
        self.register_theme(deepgreen_theme)
        self.theme = "deepgreen"
        if not self.filepath:
            self.filepath = await self.push_screen_wait(
                FileExplorerScreen(self.rootdir)
            )
        self.query_one(FileInput).set_input_value(str(self.filepath))
        # noinspection PyAsyncCall
        self.populate_tabs()

    def compose(self) -> ComposeResult:
        yield MainHeader()
        yield TabbedContent()
        yield FileInput()
        yield Footer()

    def get_system_commands(self, screen: Screen) -> Iterable[SystemCommand]:
        # skips light mode toggle since, at present, it will mess with CSS and headers
        yield from (
            c for c in super().get_system_commands(screen) if c.title != "Light mode"
        )
        yield SystemCommand(
            "Show log",
            "Displays a log of misfits operations.",
            lambda: self.push_screen("log"),
        )
        yield SystemCommand(
            "More informations",
            "Displays information on misfits.",
            lambda: self.push_screen("info"),
        )

    def action_show_log(self):
        self.push_screen("log")

    def action_show_info(self):
        self.push_screen("info")

    # this is to avoid having secondary key bindings to pop up in footer, when the footer
    # is already crowded, e.g., when going through the fits's table records
    def check_action(self, action: str, parameters: tuple[object, ...]) -> bool | None:
        """Checks if an action may run or not, if not greys them out in footer."""
        _, labels, _ = zip(*self.BINDINGS)
        if action in labels and isinstance(self.focused, FitsTable):
            return False
        return True

    # `populate_tabs` requires a worker
    @on(Input.Submitted)
    async def load_file_content(self, event: Input.Submitted):
        """Accepts and checks message from file input prompt."""
        input_path = Path(event.value)
        if not _validate_fits(input_path):
            self.query_one(FileInput).add_class("error")
            return
        self.query_one(FileInput).remove_class("error")
        self.filepath = input_path
        # noinspection PyAsyncCall
        self.populate_tabs()

    @on(HDUPane.FocusedUnpromotableTable)
    def notify_unpromotable(self, message: HDUPane.FocusedUnpromotableTable):
        self.notify(
            f"Table {message.table_name} contains array columns with variable length. "
            f"Unfortunately, these columns cannot be displayed. Filter has been disabled.",
            severity="warning",
            timeout=5,
        )

    # `push_screen_wait` requires a worker
    @work
    async def action_open_explorer(self):
        self.filepath = await self.push_screen_wait(
            EscapableFileExplorerScreen(self.rootdir)
        )
        # noinspection PyAsyncCall
        self.populate_tabs()
        self.query_one(FileInput).set_input_value(str(self.filepath))
        self.query_one(FileInput).remove_class("error")

    # calls CPU-heavy `get_fits_content`, requiring a worker
    # exclusive because otherwise would result in an error everytime we attempt
    # to open a new one while still loading.
    @work(exclusive=True)
    async def populate_tabs(self) -> None:
        """
        Fills the tabs with data read from the FITS' HDUs.
        """
        async with disable_inputs(
            loading=self.query_one(TabbedContent),
            disabled=[self.query_one(FileInput)],
        ):
            with catchtime() as elapsed:
                tabs = self.query_one(TabbedContent)
                await tabs.clear_panes()
                log.push(f"Opening '{self.filepath}'")
                contents = await get_fits_content(self.filepath)
                for i, content in enumerate(contents):
                    await tabs.add_pane(HDUPane(content, id=(tab_id := f"tab-{i}")))
                    # switches to a pane if that pane contains a table
                    if content["is_table"]:
                        self.query_one(TabbedContent).active = tab_id
            log.push(f"Reading FITS file took {elapsed():.3f} s")
        # play little logo animation
        self.query_one(AnimatedLabel).play()


def click_validate_fits(
    ctx: click.Context, param: click.Parameter, filepath: Path
) -> Path:
    """Click callback validator."""
    if filepath.is_file() and not _validate_fits(filepath):
        raise click.FileError(
            f"Invalid input.",
            hint="Please, check misfits `INPUT_PATH` argument "
            "and make sure it points to a FITS file.",
        )
    return filepath


@click.command()
@click.argument(
    "input_path",
    type=click.Path(exists=True, path_type=Path),
    callback=click_validate_fits,
    default=Path("."),
)
def main(input_path: Path):
    """Misfits is an interactive FITs viewer for the terminal."""
    filepath, rootdir = (
        (None, input_path) if input_path.is_dir() else (input_path, Path.cwd())
    )
    Misfits(filepath, rootdir).run(inline=False)


if __name__ == "__main__":
    app = Misfits(None, Path("."))
    app.run()

================
File: misfits/data.py
================
from collections import OrderedDict
from pathlib import Path
import re
import warnings

from astropy.io import fits
from astropy.io.fits.verify import VerifyWarning
from numpy import round
from pandas import DataFrame
from pandas import Index

from misfits.log import log
from misfits.mtypes import ColumnType
from misfits.mtypes import LogLevel


def is_table(hdu: fits.FitsHDU):
    """Check whether and HDU contains table data."""
    return type(hdu) in [fits.TableHDU, fits.BinTableHDU]


def parse_format(tform: str) -> tuple[int, str, str]:
    """
    Based on  Starlink (STIL) Java implementation, see
    `https://github.com/Starlink/starjava/blob/master/fits/src/main/uk/ac/starlink/fits/ColumnReader.java`

    :param tform: a FITS TFORM string
    :return: an integer representing the column length (1 for scalar columns, 2+ for vector columns),
    a string, representing the type of the column values.
    a string, representing additional information used for interpreting vector and
    variable length columns.
    """
    pattern = r"([0-9]*)([LXBIJKAEDCMPQ])(.*)"
    match = re.match(pattern, tform)
    if not match:
        # TODO: Handle this error
        raise ValueError(f"Error parsing TFORM value {tform}")
    scount = match.group(1)
    type_char = match.group(2)
    matchA = match.group(3).strip()
    count = 1 if scount == "" else int(scount)
    return count, type_char, matchA


def get_column_type(tform: str) -> ColumnType:
    """Classifies a column based on its content."""
    count, type_char, matchA = parse_format(tform)
    # "PQ" type char is used for identifying variable len columns.
    if type_char[0] in "PQ":
        return ColumnType.VARLEN
    elif count == 1:
        return ColumnType.SCALAR
    else:
        return ColumnType.VECTOR


async def get_fits_content(fits_path: str | Path) -> tuple[dict]:
    """Retrieves content from a FITS file and stores it in a tuple dict.
    Each tuple's records referes to one FITS HDU.
    Can take some time for large tables"""

    content = []
    with fits.open(fits_path) as hdul:
        # for the relevant astropy documentation, see:
        # https://docs.astropy.org/en/latest/io/fits/usage/verification.html
        with warnings.catch_warnings(
            record=True,
            category=VerifyWarning,
        ) as ws:
            hdul.verify("fix")
            log.push_verification_warning(ws)
        for hdu in hdul:
            content.append(
                {
                    "name": hdu.name,
                    "type": hdu.__class__.__name__,
                    "header": dict(hdu.header) if hdu.header else None,
                    "is_table": (ist := is_table(hdu)),
                    "data": hdu.data if ist else None,
                }
            )
    return tuple(content)


FITS_SIGNATURE = b"SIMPLE  =                    T"


def _validate_fits(filepath: Path) -> bool:
    """Checks if a file is a FITS."""
    # follows the same approach of astropy.
    try:
        with open(filepath, "rb") as file:
            # FITS signature is supposed to be in the first 30 bytes, but to
            # allow reading various invalid files we will check in the first
            # card (80 bytes).
            simple = file.read(80)
    except OSError:
        return False
    match_sig = simple[:29] == FITS_SIGNATURE[:-1] and simple[29:30] in (b"T", b"F")
    return match_sig


class DataContainer:
    """This class manages FITS table data.
    It makes data representable on the user machine, determines which columns to show,
    dispatch table entries and deals with dataset queries, when queries are possible."""

    def __init__(self, records: fits.FITS_rec):
        self.records: fits.FITS_rec | DataFrame = records
        self._len = len(records)
        self.columns = {
            col.name: get_column_type(col.format) for col in records.columns
        }
        self.displayable_columns = [
            colname
            for colname, coltype in self.columns.items()
            if coltype is not ColumnType.VARLEN
        ]
        self.can_promote = all(
            [coltype != ColumnType.VARLEN for coltype in self.columns.values()]
        )
        self.promoted = False
        self.mask: None | Index = None

    def __len__(self):
        """Returns length of possibly filtered dataset."""
        return self._len

    # table gets promoted when first converted to dataframe.
    # this enables the usage of pandas queries. promotion happens at first filter call.
    # a promoted table cannot be demoted.
    def query(self, query: str):
        """Leverage pandas queries to filter dataset""" ""
        if not self.can_promote:
            raise ValueError("Trying to filter an unpromotable table")
        if not self.promoted:
            self._promote()
        filtered_df = self.records.query(query) if query else self.records
        self.mask = filtered_df.index
        self._len = len(filtered_df)

    def get_rows(self, slice):
        """Dispatch rows based on slice."""
        if self.promoted:
            table_slice = self.records.iloc[self.mask[slice]]
        else:
            # this looks eccentric but is faster than list comprehension (WHY?) and
            # has the benefit of having homogenous formatting with promoted table
            table_slice = self._to_pandas(self.records[slice])
        return table_slice.itertuples(index=False)

    def get_columns(self):
        """Dispatch table's displayable columns"""
        return self.displayable_columns

    @staticmethod
    def _maybe_correct_endianess(records: fits.FITS_rec):
        """Convert FITS records to user machine endiannes if they differ."""
        if not records.dtype.isnative:
            records = records.byteswap().view(records.dtype.newbyteorder("="))
        return records

    def _promote(self):
        """Promote a fits records table to a proper dataframe."""
        assert self.can_promote
        self.promoted = True
        self.records = self._to_pandas(self.records)  # Table(self.records).to_pandas()
        self.mask = self.records.index

    def _to_pandas(self, table):
        """Transforms a fits records table into a dataframe"""
        out = OrderedDict()
        for colname in self.displayable_columns:
            column = self._maybe_correct_endianess(table[colname])
            if self.columns[colname] is ColumnType.VECTOR:
                if column.dtype.kind == "f":
                    # this is a workaround to Textual not applying cell formatting
                    # recursively. TODO: improve this logic?
                    column = round(column, 2)
                column = column.tolist()
            out[colname] = column

        df = DataFrame(out, index=None)
        return df

================
File: misfits/headers.py
================
import asyncio

from rich.text import Text
from terminaltexteffects import Color
from terminaltexteffects import Gradient
from terminaltexteffects.effects.effect_binarypath import BinaryPath
from textual import work
from textual.app import ComposeResult
from textual.containers import Horizontal
from textual.widgets import Label
from textual.widgets import Static

from misfits import __version__


class Header(Static):
    def __init__(
        self,
        *,
        left_label: Label | str | None = None,
        mid_label: Label | str | None = None,
        right_label: Label | str | None = None,
    ):
        self.left_label = (
            Label(left_label) if isinstance(left_label, str) else left_label
        )
        self.mid_label = Label(mid_label) if isinstance(mid_label, str) else mid_label
        self.right_label = (
            Label(right_label) if isinstance(right_label, str) else right_label
        )
        super().__init__()

    def compose(self) -> ComposeResult:
        with Horizontal():
            if self.left_label:
                yield self.left_label
            yield Static()
            if self.mid_label:
                yield self.mid_label
            yield Static()
            if self.right_label:
                yield self.right_label


class AnimatedLabel(Static):
    def __init__(self, text: str):
        super().__init__()
        self.text = text
        effect = BinaryPath(self.text)
        effect.effect_config.final_gradient_stops = Color("FFFFFF")
        effect.effect_config.final_gradient_steps = 8
        effect.terminal_config.canvas_height = 1
        effect.terminal_config.canvas_width = len(self.text)
        self.effect = effect

    @work
    async def play(self) -> None:
        for frame in self.effect:
            self.update(Text.from_ansi(frame))
            await asyncio.sleep(0.0)


class MainHeader(Header):
    def __init__(self):
        self.has_run_before = False
        super().__init__(
            left_label=AnimatedLabel(" misfits"),
            right_label=Label(Text.from_markup(f"[italic dim]v.{__version__} ")),
        )

================
File: misfits/log.py
================
from datetime import datetime

from astropy.io.fits.verify import VerifyWarning

from misfits.mtypes import ColumnType
from misfits.mtypes import LogLevel


class Logger:
    def __init__(self):
        self.logstack = []

    def push(self, message: str, level: LogLevel | None = LogLevel.INFO):
        now_str = "[dim cyan]" + datetime.now().strftime("(%H:%M:%S)") + "[/]"
        match level:
            case LogLevel.INFO:
                prefix = f"{now_str} [dim green][INFO][/]: "
            case LogLevel.WARNING:
                prefix = f"{now_str} [dim yellow][WARNING][/]: "
            case LogLevel.ERROR:
                prefix = f"{now_str} [bold red][ERROR][/]: "
            case _:
                prefix = ""
        self.logstack.append(prefix + message)

    def pop(self) -> str | None:
        return self.logstack.pop(0) if self.logstack else None

    def push_hdu_info(self, content):
        # fmt: off
        self.push(f"Found HDU {repr(content['name'])} of type {repr(content['type'])}")
        if content["is_table"]:
            ncols = len(content["data"].columns)
            self.push(f"HDU contains a table with {len(content['data'])} rows and {ncols} columns")
        # fmt: on

    def push_data_info(self, data):
        # fmt: off
        columns = {coltype: [] for coltype in ColumnType}
        for colname, coltype in data.columns.items():
            columns[coltype].append(colname)

        if scalar_columns := columns[ColumnType.SCALAR]:
            self.push(f"Data table contains {len(scalar_columns)} scalar columns: {scalar_columns}")
        if vector_columns := columns[ColumnType.VECTOR]:
            self.push(f"Data table contains {len(vector_columns)} vector columns: {vector_columns}")
        if varlen_columns := columns[ColumnType.VARLEN]:
            self.push(f"Data table contains {len(varlen_columns)} variable len columns: {varlen_columns}", level = LogLevel.WARNING)
        # fmt: on

    def push_verification_warning(self, warnings: list[VerifyWarning]):
        for w in warnings:
            self.push(str(w.message).rstrip(), level=LogLevel.WARNING)


log = Logger()

================
File: misfits/logo.py
================
from random import choice
from string import ascii_letters
from string import digits

_LOGO = """
   0000000     000000               0000000000000   000000000000000     
   0000000    0000000               000000000000      000000000         
   0000000    000000  0000    0000     00000     0000  000000    0000   
   0000000   0000000  000   0000000    000000000 000   00000   00000000 
   00000000 00000000  000  0000    0   0000000   000    00000 00000   0 
   00000000 0000000   000  00000       0000      000    0000  00000     
   000000000000 0000  000   0000000    0000      000     000    00000   
    000 000000  0000  000       00000  0000      000    0000        0000
   0000  0000   000    00 0000000000   0000       00    0000 0000000000 
   0000  0000   000         00000      00               00      0000    
   0000   00    000                                                     
"""


LOGO = "".join([(choice(ascii_letters + digits) if s == "0" else s) for s in _LOGO])

================
File: misfits/misfits.tcss
================
* {
  scrollbar-color: $surface-lighten-3;
  scrollbar-color-hover: $primary 80%;
  scrollbar-color-active: $primary;
  scrollbar-background: $surface-darken-1;
  scrollbar-background-hover: $surface-darken-1;
  scrollbar-background-active: $surface-darken-1;
  scrollbar-size-vertical: 1;
  scrollbar-size-horizontal: 0;

  &:focus {
    scrollbar-color: $surface-lighten-3;
  }
}

DataTable > .datatable--header {
  text-style: bold;
  background: $primary 30%;
  color: $text;
}

DataTable > .datatable--cursor {
  background: $accent 30%;
}

FitsTable {
  height: 1fr;
  background: $background;
  border: round $secondary;
  border-subtitle-align: right;
  & :focus-within {
    border: round $accent;
  }
}

HeaderDialog {
  width: 1fr; /* change HeaderDialog's ellipsis accordingly */
  border: round $secondary;
  background: $background;
  & :focus-within {
    border: round $accent;
  }
}

TableDialog {
  width: 3fr;
}

EmptyDialog {
  width: 3fr;
  height: 1fr;
  border: round $secondary;
  align: center middle;
  hatch: right green 20%;
}

EmptyDialog Label {
  width: auto;
}

TabbedContent {
  margin-top: 1;
  height: 1fr;  /* keeps loading indicator at center */
  background: $background;
}

TabPane {
  padding: 0;
  border: none;
}

Tabs .-active {
  background: transparent;  /* disables block highlighting */
}

HeaderEntry {
  align: center middle;
}

HeaderEntry Container {
  width: 48;
  height: 12;
  border: thick $background;
  background: $surface;
}

HeaderEntry TextArea {
  margin: 1;
  border: none;
}

LogScreen RichLog {
  background: $background;
}

InfoScreen {
  align: center middle;
}

InfoScreen Container {
  width: 76;
  height: 18;
  border: ascii $primary;
  background: $surface;
}

FileExplorerScreen {
  align: center middle;
}

FileExplorerScreen Container {
  align: center middle;
  width: 75%;
  height: 75%;
  padding: 0 1;
  border: thick $background;
  background: $surface;
}

FileExplorerScreen DirectoryTree {
  border: round $secondary;
  background: $background;
  &.error {
    border: round $error;
  }
}

FileInput {
  /* will align prompt of FileInput to prompt of filter */
  height: 3;
  padding: 0 0 0 1;
  background: $background;
  border: round $primary;
  & :focus-within {
    border: round $accent;
  }
  &.error {
    border: round $error;
  }
}

FileInput Input {
  height: 1;
  width: 1fr;
  border: none;
}

FilterInput {
  border: round $secondary;
  height: 3;
  &:focus-within {
    border: round $accent;
  }
  &.error {
    border: round $error;
  }
}

FilterInput Input {
  height: 1;
  width: 1fr;
  border: none;
}

Header {
  height: 1;
  background: $footer-background;
}

Header Static {
  width: 1fr;
}

Header Label {
  width: auto;
}

================
File: misfits/mtypes.py
================
from enum import Enum


class ColumnType(Enum):
    SCALAR = 0
    VECTOR = 1
    VARLEN = 2


class LogLevel(Enum):
    INFO = 0
    WARNING = 1
    ERROR = 2

================
File: misfits/screens.py
================
import asyncio
from pathlib import Path
from typing import Iterable

from rich.text import Text
from textual import work
from textual.app import ComposeResult
from textual.containers import Container
from textual.screen import ModalScreen
from textual.widgets import DirectoryTree
from textual.widgets import Footer
from textual.widgets import Label
from textual.widgets import RichLog
from textual.widgets import Static
from textual.widgets import TextArea

from misfits.data import _validate_fits
from misfits.headers import Header
from misfits.log import log
from misfits.logo import LOGO


class LogScreen(ModalScreen):
    """An alternative screen showing a log"""

    BINDINGS = [("escape", "app.pop_screen", "Return to dashboard")]

    def compose(self) -> ComposeResult:
        yield Header(mid_label="Log")
        yield RichLog(highlight=True, markup=True)
        yield Footer()

    def on_screen_resume(self):
        """When screen is shown, pushes message on the stack to the screen."""
        while line := log.pop():
            self.query_one(RichLog).write(line)


class InfoScreen(ModalScreen):
    """Shows an information screen."""

    BINDINGS = [("escape", "app.pop_screen", "Return to dashboard")]

    @staticmethod
    def get_text():
        return Text.from_markup(
            f"   A FITS table viewer. [italic]~p24[/].\n"
            f"   [dim]https://github.com/peppedilillo - https://gdilillo.com\n",
        )

    def compose(self) -> ComposeResult:
        with Container():
            yield Label(Text(LOGO, style="green bold"))
            yield Static(self.get_text())
        yield Footer()


class FileExplorerScreen(ModalScreen):
    """A pop-up screen showing a file explorer so that the user may choose an
    input navigating the file system.
    To be used at main app's start-up, if no input file is provided.
    For this reason the screen is not escapable without quitting."""

    BINDINGS = [("ctrl+q", "app.quit", "Quit")]

    def __init__(self, rootdir: Path = Path.cwd()):
        super().__init__()
        self.rootdir = rootdir

    def compose(self) -> ComposeResult:
        with Container():
            yield Header(mid_label="Open File")
            yield FilteredDirectoryTree(self.rootdir)
        yield Footer()

    # threaded because validating requires IO which may cause laggish behaviour
    @work(exclusive=True, group="file_check")
    async def on_directory_tree_file_selected(self, event: DirectoryTree.FileSelected):
        isvalid = await asyncio.to_thread(_validate_fits, event.path)
        if not isvalid:
            self.query_one(DirectoryTree).add_class("error")
            return
        self.query_one(DirectoryTree).remove_class("error")
        # noinspection PyAsyncCall
        self.dismiss(event.path)


class EscapableFileExplorerScreen(FileExplorerScreen):
    """Like `FileExplorer` but with bindings to leave the screen.
    To be used when a file input has already been provided."""

    BINDINGS = [("escape", "app.pop_screen", "Return to dashboard")]


class FilteredDirectoryTree(DirectoryTree):
    """A directory tree widget filtering hidden files."""

    def filter_paths(self, paths: Iterable[Path]) -> Iterable[Path]:
        return [path for path in paths if not path.name.startswith(".")]


class HeaderEntry(ModalScreen):
    """Displays header's entries in a pop-up screen. Useful with long entries."""

    BINDINGS = [("escape", "app.pop_screen", "Return to dashboard")]

    def __init__(self, text: str):
        super().__init__()
        self.text = text

    def compose(self) -> ComposeResult:
        with Container():
            yield Header(mid_label="Header entry")
            yield TextArea.code_editor(self.text, read_only=True)
        yield Footer()

================
File: misfits/suggester.py
================
import itertools
from pathlib import Path

from textual.suggester import Suggester


def is_directory_or_fitsfile(path: Path):
    return path.is_dir() or path.suffix == ".fits"


class PathSuggester(Suggester):
    """Suggest either directories of file with `fits` extension.
    This class is based on an original implementation by Will McGugan, https://github.com/willmcgugan.
    The code was not released as part of a package but provided via private communication.
    It comes with no license.
    Thank you very much for letting me use this, Will!
    TODO: remove once the suggester will be released with textual.
    """

    def __init__(self):
        super().__init__(case_sensitive=True)

    async def get_suggestion(self, value: str) -> str | None:
        """Suggest the first matching directory"""
        try:
            path = Path(value)
            if is_directory_or_fitsfile(path):
                return None
            name = path.name
            possible_paths = [
                str(sibling_path)
                for sibling_path in itertools.islice(
                    path.parent.expanduser().iterdir(), 100
                )
                if sibling_path.name.lower().startswith(name.lower())
                and is_directory_or_fitsfile(sibling_path)
            ]
            if possible_paths:
                possible_paths.sort(key=str.__len__)
                suggestion = possible_paths[0]
                if "~" in value:
                    home = str(Path("~").expanduser())
                    suggestion = suggestion.replace(home, "~")
                return suggestion

        except FileNotFoundError:
            pass
        return None

================
File: misfits/utils.py
================
from asyncio import sleep
from contextlib import asynccontextmanager
from contextlib import contextmanager
from time import perf_counter
from typing import Callable

from textual.widget import Widget


@contextmanager
def catchtime() -> Callable[[], float]:
    """A context manager for measuring computing times."""
    t1 = t2 = perf_counter()
    yield lambda: t2 - t1
    t2 = perf_counter()


@asynccontextmanager
async def disable_inputs(loading: Widget, disabled: list[Widget], delay: float = 0.25):
    """
    Disables input and shows a loading animation while tables are read into memory.

    :param disabled:
    :param loading:
    :param delay: seconds delay between end of loading indicator and
    file input prompt release.
    :return:
    """
    for widget in disabled:
        widget.disabled = True
    loading.loading = True
    yield
    loading.loading = False
    # we wait a bit before releasing the input because quick, repeated sends can
    # cause a tab to not load properly
    await sleep(delay)
    for widget in disabled:
        widget.disabled = False

================
File: tests/ascii_i4-i20.fits
================
SIMPLE  =                    T / conforms to FITS standard                      BITPIX  =                    8 / array data type                                NAXIS   =                    0 / number of array dimensions                     EXTEND  =                    T                                                  END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             XTENSION= 'TABLE   '           / ASCII table extension                          BITPIX  =                    8 / array data type                                NAXIS   =                    2 / number of array dimensions                     NAXIS1  =                   50 / length of dimension 1                          NAXIS2  =                    5 / length of dimension 2                          PCOUNT  =                    0 / number of group parameters                     GCOUNT  =                    1 / number of groups                               TFIELDS =                    5 / number of table fields                         TTYPE1  = 'col0    '                                                            TFORM1  = 'I8      '                                                            TBCOL1  =                    1                                                  TTYPE2  = 'col1    '                                                            TFORM2  = 'I8      '                                                            TBCOL2  =                    9                                                  TTYPE3  = 'col2    '                                                            TFORM3  = 'I10     '                                                            TBCOL3  =                   17                                                  TTYPE4  = 'col3    '                                                            TFORM4  = 'I20     '                                                            TBCOL4  =                   27                                                  TTYPE5  = 'col4    '                                                            TFORM5  = 'I4      '                                                            TBCOL5  =                   47                                                  END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    8      16       256               65536 256 8388608167772162147483647 92233720368547758078192-4194304-8388608-536870912-9223372036854775808-512      10      20        30                  40  50 8388608167772162147483647 92233720368547758078192

================
File: tests/ascii.fits
================
SIMPLE  =                    T / file does conform to FITS standard             BITPIX  =                   16 / number of bits per data pixel                  NAXIS   =                    0 / number of data axes                            EXTEND  =                    T / FITS dataset may contain extensions            COMMENT   FITS (Flexible Image Transport System) format defined in Astronomy andCOMMENT   Astrophysics Supplement Series v44/p363, v44/p371, v73/p359, v73/p365.COMMENT   Contact the NASA Science Office of Standards and Technology for the   COMMENT   FITS Definition document #100 and other FITS information.             END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             XTENSION= 'TABLE   '           / ASCII table extension                          BITPIX  =                    8 / 8-bit ASCII characters                         NAXIS   =                    2 / 2-dimensional ASCII table                      NAXIS1  =                   16 / width of table in characters                   NAXIS2  =                    5                                                  PCOUNT  =                    0 / no group parameters (required keyword)         GCOUNT  =                    1 / one data group (required)                      TFIELDS =                    2                                                  TTYPE1  = 'a       '           / label for field   1                            TBCOL1  =                    1 / beginning column of field   1                  TFORM1  = 'E10.4   '           / Fortran-77 format of field                     TUNIT1  = 'pixels  '           / physical unit of field                         TTYPE2  = 'b       '           / label for field   2                            TBCOL2  =                   12 / beginning column of field   2                  TFORM2  = 'I5      '           / Fortran-77 format of field                     TUNIT2  = 'counts  '           / physical unit of field                         TNULL1  = '*       '           / string representing an undefined value         TNULL2  = '*       '           / string representing an undefined value         HISTORY   This FITS file was created by the FCREATE task.                       HISTORY   fcreate3.0d at 23/4/97 9:21:56.                                       END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             .10123E+02    37.52000E+01    23.15610E+02    17*          *    .34500E+03   345

================
File: tests/history_header.fits
================
SIMPLE  =                    T / conforms to FITS standard                      BITPIX  =                    8 / array data type                                NAXIS   =                    0 / number of array dimensions                     HISTORY I updated this file on 02/03/2011                                       HISTORY I updated this file on 02/04/2011                                       END

================
File: tests/LICENSE.rst
================
Copyright (c) 2011-2024, Astropy Developers

All rights reserved.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above copyright notice, this
  list of conditions and the following disclaimer in the documentation and/or
  other materials provided with the distribution.
* Neither the name of the Astropy Team nor the names of its contributors may be
  used to endorse or promote products derived from this software without
  specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

================
File: tests/o4sp040b0_raw.fits
================
SIMPLE  =                    T / Fits standard                                  BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    0 / Number of axes                                 EXTEND  =                    T / File may contain extensions                    ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        IRAF-TLM= '14:58:02 (23/02/2007)' / Time of last modification                   NEXTEND =                    6 / Number of standard extensions                  DATE    = '2007-02-23T19:57:58' / date this file was written (yyyy-mm-dd)       FILENAME= 'o4sp040b0_raw.fits                     ' / name of file              FILETYPE= 'SCI      '          / type of data found in data file                                                                                                TELESCOP= 'HST'                / telescope used to acquire data                 INSTRUME= 'STIS  '             / identifier for instrument used to acquire data EQUINOX =               2000.0 / equinox of celestial coord. system                                                                                                           / DATA DESCRIPTION KEYWORDS                                                                                                                       ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setPRIMESI = 'STIS  '             / instrument designated as prime                                                                                                               / TARGET INFORMATION                                                                                                                              TARGNAME= 'HD101998                      ' / proposer's target name             RA_TARG =   1.761216666667E+02 / right ascension of the target (deg) (J2000)    DEC_TARG=   4.851611111111E+01 / declination of the target (deg) (J2000)                                                                                                      / PROPOSAL INFORMATION                                                                                                                            PROPOSID=                 7932 / PEP proposal identifier                        LINENUM = '3.120          '    / proposal logsheet line number                  PR_INV_L= 'Leitherer                     ' / last name of principal investigatorPR_INV_F= 'Claus               ' / first name of principal investigator         PR_INV_M= '                    ' / middle name / initial of principal investigat                                                                                              / SUMMARY EXPOSURE INFORMATION                                                                                                                    TDATEOBS= '1998-04-20'         / UT date of start of first exposure in file     TTIMEOBS= '18:38:15'           / UT start time of first exposure in file        TEXPSTRT=   5.092377657113E+04 / start time (MJD) of 1st exposure in file       TEXPEND =       50923.77948761 / end time (MJD) of last exposure in the file    TEXPTIME=                 120. / total exposure time (seconds)                                                                                                                / TARGET OFFSETS (POSTARGS)                                                                                                                       POSTARG1=             0.000000 / POSTARG in axis 1 direction                    POSTARG2=             0.000000 / POSTARG in axis 2 direction                                                                                                                  / DIAGNOSTIC KEYWORDS                                                                                                                             OVERFLOW=                    0 / Number of science data overflows               CAL_VER = '                        ' / CALSTIS code version                     PROCTIME=   5.279415092593E+04 / Pipeline processing time (MJD)                                                                                                               / SCIENCE INSTRUMENT CONFIGURATION                                                                                                                CFSTATUS= 'SUPPORTED  '        / configuration status (support., avail., eng.)  OBSTYPE = 'SPECTROSCOPIC '     / observation type - imaging or spectroscopic    OBSMODE = 'ACCUM     '         / operating mode                                 PHOTMODE= '                                                  ' / observation conSCLAMP  = 'NONE     '          / lamp status, NONE or name of lamp which is on  LAMPSET = '0.0   '             / spectral cal lamp current value (milliamps)    NRPTEXP =                    1 / number of repeat exposures in set: default 1   SUBARRAY=                    F / data from a subarray (T) or full frame (F)     DETECTOR= 'CCD       '         / detector in use: NUV-MAMA, FUV-MAMA, or CCD    OPT_ELEM= 'G750M   '           / optical element in use                         APERTURE= '0.2X0.2         '   / aperture name                                  PROPAPER= '0.2X0.2         '   / proposed aperture name                         FILTER  = 'Clear             ' / filter in use                                  APER_FOV= '0.2x0.2         '   / aperture field of view                         CENWAVE =                 8561 / central wavelength of spectrum                 CRSPLIT =                    4 / number of cosmic ray split exposures                                                                                                         / ENGINEERING PARAMETERS                                                                                                                          CCDAMP  = 'D  '                / CCD amplifier read out (A,B,C,D)               CCDGAIN =                    4 / commanded gain of CCD                          CCDOFFST=                    3 / commanded CCD bias offset                                                                                                                    / READOUT DEFINITION PARAMETERS                                                                                                                   CENTERA1=                  532 / subarray axis1 center pt in unbinned dect. pix CENTERA2=                  523 / subarray axis2 center pt in unbinned dect. pix SIZAXIS1=                 1062 / subarray axis1 size in unbinned detector pixelsSIZAXIS2=                 1044 / subarray axis2 size in unbinned detector pixelsBINAXIS1=                    1 / axis1 data bin size in unbinned detector pixelsBINAXIS2=                    1 / axis2 data bin size in unbinned detector pixels                                                                                              / CALIBRATION SWITCHES: PERFORM, OMIT, COMPLETE                                                                                                   DQICORR = 'PERFORM '           / data quality initialization                    ATODCORR= 'OMIT    '           / correct for A to D conversion errors           BLEVCORR= 'PERFORM '           / subtract bias level computed from overscan img BIASCORR= 'PERFORM '           / Subtract bias image                            CRCORR  = 'PERFORM '           / combine observations to reject cosmic rays     RPTCORR = 'OMIT    '           / add individual repeat observations             EXPSCORR= 'PERFORM '           / process individual observations after cr-rejectDARKCORR= 'PERFORM '           / Subtract dark image                            FLATCORR= 'PERFORM '           / flat field data                                SHADCORR= 'OMIT    '           / apply shutter shading correction               STATFLAG=                    T / Calculate statistics?                          WAVECORR= 'PERFORM '           / use wavecal to adjust wavelength zeropoint     X1DCORR = 'PERFORM '           / Perform 1-D spectral extraction                BACKCORR= 'PERFORM '           / subtract background (sky and interorder)       HELCORR = 'PERFORM '           / convert to heliocenttric wavelengths           DISPCORR= 'PERFORM '           / apply 2-dimensional dispersion solutions       FLUXCORR= 'PERFORM '           / convert to absolute flux units                 X2DCORR = 'PERFORM '           / rectify 2-D spectral image                                                                                                                   / CALIBRATION REFERENCE FILES                                                                                                                     BPIXTAB = 'otab$h1v11475o_bpx.fits' / bad pixel table                           DARKFILE= 'oref$jce11265o_drk.fits' / dark image file name                      PFLTFILE= 'oref$k2910265o_pfl.fits' / pixel to pixel flat field file name       DFLTFILE= 'N/A     '                / delta flat field file name                LFLTFILE= '        '                / low order flat                            PHOTTAB = 'otab$k9f1452qo_pht.fits' / Photometric throughput table              APERTAB = 'otab$laf13369o_apt.fits' / relative aperture throughput table        CCDTAB  = 'otab$k2g1502eo_ccd.fits' / CCD calibration parameters                ATODTAB = 'N/A     '                / analog to digital correction file         BIASFILE= 'oref$k5h1101io_bia.fits' / bias image file name                      SHADFILE= 'N/A     '                / shutter shading correction file           CRREJTAB= 'otab$j3m1403io_crr.fits' / cosmic ray rejection parameters           WAVECAL = 'o4sp040b0_wav.fits     ' / wavecal image file name                   APDESTAB= 'otab$m9a16591o_apd.fits' / aperture description table                SPTRCTAB= 'otab$l2j0137so_1dt.fits' / spectrum trace table                      DISPTAB = 'otab$l2j0137to_dsp.fits' / dispersion coefficient table              INANGTAB= 'otab$h5s11397o_iac.fits' / incidence angle correction table          LAMPTAB = 'otab$l421050oo_lmp.fits' / template calibration lamp spectra table   SDCTAB  = 'otab$laf1336ao_sdc.fits' / 2-D spatial distortion correction table   XTRACTAB= 'otab$lb21642oo_1dx.fits' / parameters for 1-D spectral extraction tabPCTAB   = 'otab$n2o1817ko_pct.fits' / Photometry correction table               WBIAFILE= 'oref$k5h1101io_bia.fits' / associated wavecal bias image file name   WCPTAB  = 'otab$lag1815lo_wcp.fits' / wavecal parameters table                  TDSTAB  = 'N/A     '                / time-dependent sensitivity algorithm used                                                                                               / COSMIC RAY REJECTION ALGORITHM PARAMETERS                                                                                                       MEANEXP =             0.000000 / reference exposure time for parameters         SCALENSE=             0.000000 / multiplicative scale factor applied to noise   INITGUES= '   '                / initial guess method (MIN or MED)              SKYSUB  = '    '               / sky value subtracted (MODE or NONE)            CRSIGMAS= '               '    / statistical rejection criteria                 CRRADIUS=             0.000000 / rejection propagation radius (pixels)          CRTHRESH=             0.000000 / rejection propagation threshold                BADINPDQ=                    0 / data quality flag bits to reject               REJ_RATE=                  0.0 / rate at which pixels are affected by cosmic rayCRMASK  =                    F / flag CR-rejected pixels in input files (T/F)                                                                                                 / CALIBRATED ENGINEERING PARAMETERS                                                                                                               ATODGAIN=             0.000000 / calibrated CCD amplifier gain value            READNSE =             0.000000 / calibrated CCD read noise value                                                                                                              / TARGET ACQUISITION DATASET IDENTIFIERS                                                                                                          ACQNAME = 'o4sp04DHT '         / rootname of acquisition exposure               ACQTYPE = '               '    / type of acquisition                            PEAKNAM1= 'o4sp04EMT '         / rootname of 1st peakup exposure                PEAKNAM2= 'o4sp04ENT '         / rootname of 2nd peakup exposure                                                                                                              / PATTERN KEYWORDS                                                                                                                                PATTERN1= 'NONE                    ' / primary pattern type                     P1_SHAPE= '                  ' / primary pattern shape                          P1_PURPS= '          '         / primary pattern purpose                        P1_NPTS =                    0 / number of points in primary pattern            P1_PSPAC=             0.000000 / point spacing for primary pattern (arc-sec)    P1_LSPAC=             0.000000 / line spacing for primary pattern (arc-sec)     P1_ANGLE=             0.000000 / angle between sides of parallelogram patt (deg)P1_FRAME= '         '          / coordinate frame of primary pattern            P1_ORINT=             0.000000 / orientation of pattern to coordinate frame (degP1_CENTR= '   '                / center pattern relative to pointing (yes/no)                                                                                                 / ARCHIVE SEARCH KEYWORDS                                                                                                                         BANDWID =                572.0 / bandwidth of the data                          SPECRES =               7780.0 / approx. resolving power at central wavelength  CENTRWV =               8561.0 / central wavelength of the data                 MINWAVE =               8275.0 / minimum wavelength in spectrum                 MAXWAVE =               8847.0 / maximum wavelength in spectrum                 PLATESC =                 0.05 / plate scale (arcsec/pixel)                                                                                                                   / PAPER PRODUCT SUPPORT KEYWORDS                                                                                                                  PROPTTL1= 'Spectral Purity and slit throughputs for the First Order Spectroscop'PROPTTL2= 'ic Modes                                                            'OBSET_ID= '04'                 / observation set id                             TARDESCR= 'STAR                                                                'MTFLAG  = ' '                  / moving target flag; T if it is a moving target PARALLAX=   0.000000000000E+00 / target parallax from proposal                  MU_RA   =   0.000000000000E+00 / target proper motion from proposal (degrees RA)MU_DEC  =   0.000000000000E+00 / target proper motion from proposal (deg. DEC)  MU_EPOCH= 'J2000.0'            / epoch of proper motion from proposal                                                                                                         / ASSOCIATION KEYWORDS                                                                                                                            ASN_ID  = 'O4SP040B0 '         / unique identifier assigned to association      ASN_TAB = 'o4sp040b0_asn.fits     ' / name of the association table             LRC_XSTS=                    F                                                  LRC_FAIL=                    F                                                  HISTORY   Copied from o4sp040b0_raw.fits                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        END                                                                             XTENSION= 'IMAGE   '           / Image extension                                BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    2 / Number of axes                                 NAXIS1  =                   62 / Axis length                                    NAXIS2  =                   44 / Axis length                                    PCOUNT  =                    0 / No 'random' parameters                         GCOUNT  =                    1 / Only one group                                 ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        EXTNAME = 'SCI     '           / Extension name                                 EXTVER  =                    1 / Extension version                              INHERIT =                    F / Inherits global header                         DATE    = '2007-02-23T19:57:58' / Date FITS file was generated                  IRAF-TLM= '14:57:58 (23/02/2007)' / Time of last modification                   ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setEXPNAME = 'o4sp04ezq                ' / exposure identifier                     BUNIT   = 'COUNTS            ' / brightness units                               ASN_MTYP= 'CRSPLIT     '       / Role of the Member in the Association                                                                                                        / World Coordinate System and Related Parameters                                                                                                  WCSAXES =                    2 / number of World Coordinate System axes         CRPIX1  =              535.384 / x-coordinate of reference pixel                CRPIX2  =               536.67 / y-coordinate of reference pixel                CRVAL1  =   8.561000000000E+03 / first axis value at reference pixel            CRVAL2  =   0.000000000000E+00 / second axis value at reference pixel           CTYPE1  = 'LAMBDA  '           / the coordinate type for the first axis         CTYPE2  = 'ANGLE   '           / the coordinate type for the second axis        CD1_1   =                0.554 / partial of first axis coordinate w.r.t. x      CD1_2   =                  0.0 / partial of first axis coordinate w.r.t. y      CD2_1   =                  0.0 / partial of second axis coordinate w.r.t. x     CD2_2   =          1.38889E-05 / partial of second axis coordinate w.r.t. y     LTV1    =                 19.0 / offset in X to subsection start                LTV2    =                 20.0 / offset in Y to subsection start                LTM1_1  =                  1.0 / reciprocal of sampling rate in X               LTM2_2  =                  1.0 / reciprocal of sampling rate in Y               RA_APER =   1.761216666667E+02 / RA of aperture reference position              DEC_APER=   4.851611111111E+01 / Declination of aperture reference position     PA_APER =   1.143617019653E+02 / Position Angle of reference aperture center (deDISPAXIS=                    1 / dispersion axis; 1 = axis 1, 2 = axis 2, none  CUNIT1  = 'angstrom'           / units of first coordinate value                CUNIT2  = 'deg     '           / units of second coordinate value                                                                                                             / OFFSETS FROM ASSOCIATED WAVECAL                                                                                                                 SHIFTA1 =             0.000000 / Spectrum shift in AXIS1 calculated from WAVECALSHIFTA2 =             0.000000 / Spectrum shift in AXIS2 calculated from WAVECAL                                                                                              / EXPOSURE INFORMATION                                                                                                                            ORIENTAT=              114.362 / position angle of image y axis (deg. e of n)   SUNANGLE=           113.360931 / angle between sun and V1 axis                  MOONANGL=           131.851257 / angle between moon and V1 axis                 SUN_ALT =           -52.544285 / altitude of the sun above Earth's limb         FGSLOCK = 'FINE              ' / commanded FGS lock (FINE,COARSE,GYROS,UNKNOWN)                                                                                 DATE-OBS= '1998-04-20'         / UT date of start of observation (yyyy-mm-dd)   TIME-OBS= '18:38:15'           / UT time of start of observation (hh:mm:ss)     EXPSTART=   5.092377657113E+04 / exposure start time (Modified Julian Date)     EXPEND  =   5.092377691835E+04 / exposure end time (Modified Julian Date)       EXPTIME =            30.000000 / exposure duration (seconds)--calculated        EXPFLAG = 'NORMAL       '      / Exposure interruption indicator                                                                                                              / PATTERN KEYWORDS                                                                                                                                PATTSTEP=                    0 / position number of this point in the pattern                                                                                                 / REPEATED EXPOSURES INFO                                                                                                                         NCOMBINE=                    1 / number of image sets combined during CR rejecti                                                                                              / DATA PACKET INFORMATION                                                                                                                         FILLCNT =                    0 / number of segments containing fill             ERRCNT  =                    0 / number of segments containing errors           PODPSFF =                    F / podps fill present (T/F)                       STDCFFF =                    F / ST DDF fill present (T/F)                      STDCFFP = '0x5569'             / ST DDF fill pattern (hex)                                                                                                                    / ENGINEERING PARAMETERS                                                                                                                          OSWABSP =              1234272 / Slit Wheel Absolute position                   OMSCYL1P=                 4008 / Mode select cylinder 1 position                OMSCYL3P=                 1177 / Mode select cylinder 3 position                OMSCYL4P=                 5297 / Mode select cylinder 4 position                OCBABAV =              26.7024 / (V) CEB A&B Amp Bias                           OCBCDAV =              26.6827 / (V) CEB C&D amp bias                           OCBLGCDV=             -3.38871 / (V) CEB last gate C&D                          OCBSWALV=             -6.00587 / (V) CB summing well A Lo                       OCBRCDLV=            0.0487692 / (V) CB reset gate CD Lo                        OCCDHTAV=            -1.000000 / average CCD housing temperature (degC)                                                                                                       / IMAGE STATISTICS AND DATA QUALITY FLAGS                                                                                                         NGOODPIX=              1108728 / number of good pixels                          SDQFLAGS=                31743 / serious data quality flags                     GOODMIN =               1486.0 / minimum value of good pixels                   GOODMAX =              14113.0 / maximum value of good pixels                   GOODMEAN=          1526.857056 / mean value of good pixels                      SNRMIN  =             0.000000 / minimum signal to noise of good pixels         SNRMAX  =             0.000000 / maximum signal to noise of good pixels         SNRMEAN =             0.000000 / mean value of signal to noise of good pixels   SOFTERRS=                    0 / number of soft error pixels (DQF=1)            MEANDARK=                  0.0 / average of the dark values subtracted          MEANBLEV=                  0.0 / average of all bias levels subtracted                                                                                                        / PHOTOMETRY KEYWORDS                                                                                                                             SPORDER =                    1 / Spectral order                                 DIFF2PT =                  1.0 / Diffuse to point source conversion factor      CONT2EML=             0.000000 / Intensity conversion: continuum -> emission    SCALE_A1=             0.000000 / Size of one pixel (arcsec) along dispersion axiOMEGAPIX=             0.000000 / Solid angle (arcsec**2) subtended by one pixel BZERO   =                32768                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             XTENSION= 'IMAGE   '           / Image extension                                BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    0 / Number of axes                                 PCOUNT  =                    0 / No 'random' parameters                         GCOUNT  =                    1 / Only one group                                 ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        EXTNAME = 'ERR     '           / Extension name                                 EXTVER  =                    1 / Extension version                              INHERIT =                    F / Inherits global header                         DATE    = '2007-02-23T19:57:58' / Date FITS file was generated                  IRAF-TLM= '14:57:58 (23/02/2007)' / Time of last modification                   ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setEXPNAME = 'o4sp04ezq                ' / exposure identifier                     BUNIT   = 'COUNTS            ' / brightness units                               NPIX1   =                   62 / length of constant array axis 1                NPIX2   =                   44 / length of constant array axis 2                PIXVALUE=                  0.0 / values of pixels in constant array                                                                                                           / World Coordinate System and Related Parameters                                                                                                  WCSAXES =                    2 / number of World Coordinate System axes         CRPIX1  =              535.384 / x-coordinate of reference pixel                CRPIX2  =               536.67 / y-coordinate of reference pixel                CRVAL1  =   8.561000000000E+03 / first axis value at reference pixel            CRVAL2  =   0.000000000000E+00 / second axis value at reference pixel           CTYPE1  = 'LAMBDA  '           / the coordinate type for the first axis         CTYPE2  = 'ANGLE   '           / the coordinate type for the second axis        CD1_1   =                0.554 / partial of first axis coordinate w.r.t. x      CD1_2   =                   0. / partial of first axis coordinate w.r.t. y      CD2_1   =                   0. / partial of second axis coordinate w.r.t. x     CD2_2   =  1.38889000000000E-5 / partial of second axis coordinate w.r.t. y     LTV1    =                  19. / offset in X to subsection start                LTV2    =                  20. / offset in Y to subsection start                LTM1_1  =                   1. / reciprocal of sampling rate in X               LTM2_2  =                   1. / reciprocal of sampling rate in Y               RA_APER =   1.761216666667E+02 / RA of aperture reference position              DEC_APER=   4.851611111111E+01 / Declination of aperture reference position     PA_APER =   1.143617019653E+02 / Position Angle of reference aperture center (deDISPAXIS=                    1 / dispersion axis; 1 = axis 1, 2 = axis 2, none  CUNIT1  = 'angstrom'           / units of first coordinate value                CUNIT2  = 'deg     '           / units of second coordinate value                                                                                                             / OFFSETS FROM ASSOCIATED WAVECAL                                                                                                                 SHIFTA1 =             0.000000 / Spectrum shift in AXIS1 calculated from WAVECALSHIFTA2 =             0.000000 / Spectrum shift in AXIS2 calculated from WAVECAL                                                                                              / NOISE MODEL KEYWORDS                                                                                                                            NOISEMOD= '                                        ' / noise model equation     NOISCOF1=   0.000000000000E+00 / noise coefficient 1                            NOISCOF2=   0.000000000000E+00 / noise coefficient 2                            NOISCOF3=   0.000000000000E+00 / noise coefficient 3                            NOISCOF4=   0.000000000000E+00 / noise coefficient 4                            NOISCOF5=   0.000000000000E+00 / noise coefficient 5                                                                                                                          / IMAGE STATISTICS AND DATA QUALITY FLAGS                                                                                                         NGOODPIX=              1108728 / number of good pixels                          SDQFLAGS=                31743 / serious data quality flags                     GOODMIN =               1486.0 / minimum value of good pixels                   GOODMAX =              14113.0 / maximum value of good pixels                   GOODMEAN=          1526.857056 / mean value of good pixels                      LTM2_1  =                   0.                                                  LTM1_2  =                   0.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END                                                                             XTENSION= 'IMAGE   '           / Image extension                                BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    0 / Number of axes                                 PCOUNT  =                    0 / No 'random' parameters                         GCOUNT  =                    1 / Only one group                                 ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        EXTNAME = 'DQ      '           / Extension name                                 EXTVER  =                    1 / Extension version                              INHERIT =                    F / Inherits global header                         DATE    = '2007-02-23T19:57:58' / Date FITS file was generated                  IRAF-TLM= '14:57:58 (23/02/2007)' / Time of last modification                   ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setEXPNAME = 'o4sp04ezq                ' / exposure identifier                     BUNIT   = 'UNITLESS          ' / brightness units                               NPIX1   =                   62 / length of constant array axis 1                NPIX2   =                   44 / length of constant array axis 2                PIXVALUE=                    0 / values of pixels in constant array                                                                                                           / World Coordinate System and Related Parameters                                                                                                  WCSAXES =                    2 / number of World Coordinate System axes         CRPIX1  =              535.384 / x-coordinate of reference pixel                CRPIX2  =               536.67 / y-coordinate of reference pixel                CRVAL1  =   8.561000000000E+03 / first axis value at reference pixel            CRVAL2  =   0.000000000000E+00 / second axis value at reference pixel           CTYPE1  = 'LAMBDA  '           / the coordinate type for the first axis         CTYPE2  = 'ANGLE   '           / the coordinate type for the second axis        CD1_1   =                0.554 / partial of first axis coordinate w.r.t. x      CD1_2   =                   0. / partial of first axis coordinate w.r.t. y      CD2_1   =                   0. / partial of second axis coordinate w.r.t. x     CD2_2   =  1.38889000000000E-5 / partial of second axis coordinate w.r.t. y     LTV1    =                  19. / offset in X to subsection start                LTV2    =                  20. / offset in Y to subsection start                LTM1_1  =                   1. / reciprocal of sampling rate in X               LTM2_2  =                   1. / reciprocal of sampling rate in Y               RA_APER =   1.761216666667E+02 / RA of aperture reference position              DEC_APER=   4.851611111111E+01 / Declination of aperture reference position     PA_APER =   1.143617019653E+02 / Position Angle of reference aperture center (deDISPAXIS=                    1 / dispersion axis; 1 = axis 1, 2 = axis 2, none  CUNIT1  = 'angstrom'           / units of first coordinate value                CUNIT2  = 'deg     '           / units of second coordinate value                                                                                                             / OFFSETS FROM ASSOCIATED WAVECAL                                                                                                                 SHIFTA1 =             0.000000 / Spectrum shift in AXIS1 calculated from WAVECALSHIFTA2 =             0.000000 / Spectrum shift in AXIS2 calculated from WAVECALLTM2_1  =                   0.                                                  LTM1_2  =                   0.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END                                                                             XTENSION= 'IMAGE   '           / Image extension                                BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    2 / Number of axes                                 NAXIS1  =                   62 / Axis length                                    NAXIS2  =                   44 / Axis length                                    PCOUNT  =                    0 / No 'random' parameters                         GCOUNT  =                    1 / Only one group                                 ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        EXTNAME = 'SCI     '           / Extension name                                 EXTVER  =                    2 / Extension version                              INHERIT =                    F / Inherits global header                         DATE    = '2007-02-23T19:57:59' / Date FITS file was generated                  IRAF-TLM= '14:57:58 (23/02/2007)' / Time of last modification                   ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setEXPNAME = 'o4sp04f0q                ' / exposure identifier                     BUNIT   = 'COUNTS            ' / brightness units                               ASN_MTYP= 'CRSPLIT     '       / Role of the Member in the Association                                                                                                        / World Coordinate System and Related Parameters                                                                                                  WCSAXES =                    2 / number of World Coordinate System axes         CRPIX1  =              535.384 / x-coordinate of reference pixel                CRPIX2  =               536.67 / y-coordinate of reference pixel                CRVAL1  =   8.561000000000E+03 / first axis value at reference pixel            CRVAL2  =   0.000000000000E+00 / second axis value at reference pixel           CTYPE1  = 'LAMBDA  '           / the coordinate type for the first axis         CTYPE2  = 'ANGLE   '           / the coordinate type for the second axis        CD1_1   =                0.554 / partial of first axis coordinate w.r.t. x      CD1_2   =                  0.0 / partial of first axis coordinate w.r.t. y      CD2_1   =                  0.0 / partial of second axis coordinate w.r.t. x     CD2_2   =          1.38889E-05 / partial of second axis coordinate w.r.t. y     LTV1    =                 19.0 / offset in X to subsection start                LTV2    =                 20.0 / offset in Y to subsection start                LTM1_1  =                  1.0 / reciprocal of sampling rate in X               LTM2_2  =                  1.0 / reciprocal of sampling rate in Y               RA_APER =   1.761216666667E+02 / RA of aperture reference position              DEC_APER=   4.851611111111E+01 / Declination of aperture reference position     PA_APER =   1.143617019653E+02 / Position Angle of reference aperture center (deDISPAXIS=                    1 / dispersion axis; 1 = axis 1, 2 = axis 2, none  CUNIT1  = 'angstrom'           / units of first coordinate value                CUNIT2  = 'deg     '           / units of second coordinate value                                                                                                             / OFFSETS FROM ASSOCIATED WAVECAL                                                                                                                 SHIFTA1 =             0.000000 / Spectrum shift in AXIS1 calculated from WAVECALSHIFTA2 =             0.000000 / Spectrum shift in AXIS2 calculated from WAVECAL                                                                                              / EXPOSURE INFORMATION                                                                                                                            ORIENTAT=              114.362 / position angle of image y axis (deg. e of n)   SUNANGLE=           113.360229 / angle between sun and V1 axis                  MOONANGL=           131.857269 / angle between moon and V1 axis                 SUN_ALT =           -58.053928 / altitude of the sun above Earth's limb         FGSLOCK = 'FINE              ' / commanded FGS lock (FINE,COARSE,GYROS,UNKNOWN)                                                                                 DATE-OBS= '1998-04-20'         / UT date of start of observation (yyyy-mm-dd)   TIME-OBS= '18:39:29'           / UT time of start of observation (hh:mm:ss)     EXPSTART=   5.092377742742E+04 / exposure start time (Modified Julian Date)     EXPEND  =   5.092377777464E+04 / exposure end time (Modified Julian Date)       EXPTIME =            30.000000 / exposure duration (seconds)--calculated        EXPFLAG = 'NORMAL       '      / Exposure interruption indicator                                                                                                              / PATTERN KEYWORDS                                                                                                                                PATTSTEP=                    0 / position number of this point in the pattern                                                                                                 / REPEATED EXPOSURES INFO                                                                                                                         NCOMBINE=                    1 / number of image sets combined during CR rejecti                                                                                              / DATA PACKET INFORMATION                                                                                                                         FILLCNT =                    0 / number of segments containing fill             ERRCNT  =                    0 / number of segments containing errors           PODPSFF =                    F / podps fill present (T/F)                       STDCFFF =                    F / ST DDF fill present (T/F)                      STDCFFP = '0x5569'             / ST DDF fill pattern (hex)                                                                                                                    / ENGINEERING PARAMETERS                                                                                                                          OSWABSP =              1234272 / Slit Wheel Absolute position                   OMSCYL1P=                 4008 / Mode select cylinder 1 position                OMSCYL3P=                 1177 / Mode select cylinder 3 position                OMSCYL4P=                 5297 / Mode select cylinder 4 position                OCBABAV =              26.7024 / (V) CEB A&B Amp Bias                           OCBCDAV =              26.7024 / (V) CEB C&D amp bias                           OCBLGCDV=             -3.37895 / (V) CEB last gate C&D                          OCBSWALV=             -5.99614 / (V) CB summing well A Lo                       OCBRCDLV=            0.0390036 / (V) CB reset gate CD Lo                        OCCDHTAV=            -1.000000 / average CCD housing temperature (degC)                                                                                                       / IMAGE STATISTICS AND DATA QUALITY FLAGS                                                                                                         NGOODPIX=              1108728 / number of good pixels                          SDQFLAGS=                31743 / serious data quality flags                     GOODMIN =               1484.0 / minimum value of good pixels                   GOODMAX =              14089.0 / maximum value of good pixels                   GOODMEAN=          1526.973145 / mean value of good pixels                      SNRMIN  =             0.000000 / minimum signal to noise of good pixels         SNRMAX  =             0.000000 / maximum signal to noise of good pixels         SNRMEAN =             0.000000 / mean value of signal to noise of good pixels   SOFTERRS=                    0 / number of soft error pixels (DQF=1)            MEANDARK=                  0.0 / average of the dark values subtracted          MEANBLEV=                  0.0 / average of all bias levels subtracted                                                                                                        / PHOTOMETRY KEYWORDS                                                                                                                             SPORDER =                    1 / Spectral order                                 DIFF2PT =                  1.0 / Diffuse to point source conversion factor      CONT2EML=             0.000000 / Intensity conversion: continuum -> emission    SCALE_A1=             0.000000 / Size of one pixel (arcsec) along dispersion axiOMEGAPIX=             0.000000 / Solid angle (arcsec**2) subtended by one pixel BZERO   =                32768                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END                                                                                                                                                                                                                                             p&                                                                                                                                                                                                                                                                                                                XTENSION= 'IMAGE   '           / Image extension                                BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    0 / Number of axes                                 PCOUNT  =                    0 / No 'random' parameters                         GCOUNT  =                    1 / Only one group                                 ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        EXTNAME = 'ERR     '           / Extension name                                 EXTVER  =                    2 / Extension version                              INHERIT =                    F / Inherits global header                         DATE    = '2007-02-23T19:57:59' / Date FITS file was generated                  IRAF-TLM= '14:57:59 (23/02/2007)' / Time of last modification                   ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setEXPNAME = 'o4sp04f0q                ' / exposure identifier                     BUNIT   = 'COUNTS            ' / brightness units                               NPIX1   =                   62 / length of constant array axis 1                NPIX2   =                   44 / length of constant array axis 2                PIXVALUE=                  0.0 / values of pixels in constant array                                                                                                           / World Coordinate System and Related Parameters                                                                                                  WCSAXES =                    2 / number of World Coordinate System axes         CRPIX1  =              535.384 / x-coordinate of reference pixel                CRPIX2  =               536.67 / y-coordinate of reference pixel                CRVAL1  =   8.561000000000E+03 / first axis value at reference pixel            CRVAL2  =   0.000000000000E+00 / second axis value at reference pixel           CTYPE1  = 'LAMBDA  '           / the coordinate type for the first axis         CTYPE2  = 'ANGLE   '           / the coordinate type for the second axis        CD1_1   =                0.554 / partial of first axis coordinate w.r.t. x      CD1_2   =                   0. / partial of first axis coordinate w.r.t. y      CD2_1   =                   0. / partial of second axis coordinate w.r.t. x     CD2_2   =  1.38889000000000E-5 / partial of second axis coordinate w.r.t. y     LTV1    =                  19. / offset in X to subsection start                LTV2    =                  20. / offset in Y to subsection start                LTM1_1  =                   1. / reciprocal of sampling rate in X               LTM2_2  =                   1. / reciprocal of sampling rate in Y               RA_APER =   1.761216666667E+02 / RA of aperture reference position              DEC_APER=   4.851611111111E+01 / Declination of aperture reference position     PA_APER =   1.143617019653E+02 / Position Angle of reference aperture center (deDISPAXIS=                    1 / dispersion axis; 1 = axis 1, 2 = axis 2, none  CUNIT1  = 'angstrom'           / units of first coordinate value                CUNIT2  = 'deg     '           / units of second coordinate value                                                                                                             / OFFSETS FROM ASSOCIATED WAVECAL                                                                                                                 SHIFTA1 =             0.000000 / Spectrum shift in AXIS1 calculated from WAVECALSHIFTA2 =             0.000000 / Spectrum shift in AXIS2 calculated from WAVECAL                                                                                              / NOISE MODEL KEYWORDS                                                                                                                            NOISEMOD= '                                        ' / noise model equation     NOISCOF1=   0.000000000000E+00 / noise coefficient 1                            NOISCOF2=   0.000000000000E+00 / noise coefficient 2                            NOISCOF3=   0.000000000000E+00 / noise coefficient 3                            NOISCOF4=   0.000000000000E+00 / noise coefficient 4                            NOISCOF5=   0.000000000000E+00 / noise coefficient 5                                                                                                                          / IMAGE STATISTICS AND DATA QUALITY FLAGS                                                                                                         NGOODPIX=              1108728 / number of good pixels                          SDQFLAGS=                31743 / serious data quality flags                     GOODMIN =               1484.0 / minimum value of good pixels                   GOODMAX =              14089.0 / maximum value of good pixels                   GOODMEAN=          1526.973145 / mean value of good pixels                      LTM2_1  =                   0.                                                  LTM1_2  =                   0.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END                                                                             XTENSION= 'IMAGE   '           / Image extension                                BITPIX  =                   16 / Bits per pixel                                 NAXIS   =                    0 / Number of axes                                 PCOUNT  =                    0 / No 'random' parameters                         GCOUNT  =                    1 / Only one group                                 ORIGIN  = 'NOAO-IRAF FITS Image Kernel July 2003' / FITS file originator        EXTNAME = 'DQ      '           / Extension name                                 EXTVER  =                    2 / Extension version                              INHERIT =                    F / Inherits global header                         DATE    = '2007-02-23T19:57:59' / Date FITS file was generated                  IRAF-TLM= '14:57:59 (23/02/2007)' / Time of last modification                   ROOTNAME= 'o4sp040b0                         ' / rootname of the observation setEXPNAME = 'o4sp04f0q                ' / exposure identifier                     BUNIT   = 'UNITLESS          ' / brightness units                               NPIX1   =                   62 / length of constant array axis 1                NPIX2   =                   44 / length of constant array axis 2                PIXVALUE=                    0 / values of pixels in constant array                                                                                                           / World Coordinate System and Related Parameters                                                                                                  WCSAXES =                    2 / number of World Coordinate System axes         CRPIX1  =              535.384 / x-coordinate of reference pixel                CRPIX2  =               536.67 / y-coordinate of reference pixel                CRVAL1  =   8.561000000000E+03 / first axis value at reference pixel            CRVAL2  =   0.000000000000E+00 / second axis value at reference pixel           CTYPE1  = 'LAMBDA  '           / the coordinate type for the first axis         CTYPE2  = 'ANGLE   '           / the coordinate type for the second axis        CD1_1   =                0.554 / partial of first axis coordinate w.r.t. x      CD1_2   =                   0. / partial of first axis coordinate w.r.t. y      CD2_1   =                   0. / partial of second axis coordinate w.r.t. x     CD2_2   =  1.38889000000000E-5 / partial of second axis coordinate w.r.t. y     LTV1    =                  19. / offset in X to subsection start                LTV2    =                  20. / offset in Y to subsection start                LTM1_1  =                   1. / reciprocal of sampling rate in X               LTM2_2  =                   1. / reciprocal of sampling rate in Y               RA_APER =   1.761216666667E+02 / RA of aperture reference position              DEC_APER=   4.851611111111E+01 / Declination of aperture reference position     PA_APER =   1.143617019653E+02 / Position Angle of reference aperture center (deDISPAXIS=                    1 / dispersion axis; 1 = axis 1, 2 = axis 2, none  CUNIT1  = 'angstrom'           / units of first coordinate value                CUNIT2  = 'deg     '           / units of second coordinate value                                                                                                             / OFFSETS FROM ASSOCIATED WAVECAL                                                                                                                 SHIFTA1 =             0.000000 / Spectrum shift in AXIS1 calculated from WAVECALSHIFTA2 =             0.000000 / Spectrum shift in AXIS2 calculated from WAVECALLTM2_1  =                   0.                                                  LTM1_2  =                   0.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END

================
File: tests/verify.fits
================
SIMPLE  =                    T / conforms to FITS standard                      NAXIS   =                    0 / NUMBER OF AXES                                 BITPIX  =                    8 / BITS PER PIXEL                                 END

================
File: .gitattributes
================
* text=auto eol=lf

*.png binary
*.jpg binary
*.fits binary

================
File: .gitignore
================
**/.DS_Store
**/.idea
**/__pycache__
**/.ipynb_checkpoints
**/.mypy-cache
*venv*/
dist/

================
File: conda-env.yml
================
name: misfits
dependencies:
   - python>=3.11
   - pip
   - pip:
     - misfits

================
File: misfits-vhs.tape
================
Output assets/misfits.gif

Set FontSize 24
Set Width 1400
Set Height 900

Type "misfits tests/tests_high_energy_events.fits"
Enter

# show cheesy animation
Sleep 5s

# go to header tab
Tab
Sleep 1s

# select and open a node
Down
Sleep 1s
Enter
Sleep 1s

# expands all other nodes
Ctrl+S
Sleep 1s

# collapse nodes
Ctrl+S
Sleep 1s

# move to event tab
Tab
Sleep 1s

# scroll pages
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 50ms
Ctrl+N
Sleep 1s
Ctrl+A
Sleep 1s

# Use filter
Tab
Sleep 1s
Type "ENERGY > 666 & TIME > 81015781.70"
Sleep 500ms
Enter
Sleep 1s

# Swith to file tab
Tab
Sleep 1s

# Open file explorer
Ctrl+O
Sleep 1s
Down
Sleep 500ms
Down
Sleep 500ms
Down
Sleep 500ms
Down
Sleep 500ms
Up
Sleep 500ms
Up
Sleep 500ms
Up
Sleep 500ms
Up
Sleep 500ms
Escape
Sleep 1s

# Open Credits
Ctrl+J
Sleep 500ms
Sleep 5s

================
File: pyproject.toml
================
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "misfits"
version = "0.0.11"
authors = [
    { name="Giuseppe Dilillo", email="peppedilillo@gmail.com" },
]
description = "A FITS table viewer for the terminal."
keywords = ["FITS", "Flexible Image Transport System", "Astrophysics"]
readme = "README.md"
license = {file = "LICENSE.txt"}
requires-python = ">=3.11"
classifiers = [
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
]
dependencies = [
    "astropy == 7.1.0",
    "pandas == 2.3.0",
    "textual == 3.5.0",
    "terminaltexteffects == 0.12.0",
    "click == 8.2.1",
]

[project.optional-dependencies]
dev = [
    "textual-dev>=1.5",
    "black>=24.8",
    "isort>=5.13",
    "mypy>=1.11",
    "ipython>=8.27",
]

[project.urls]
"Homepage" = "https://github.com/peppedilillo/misfits"

[project.scripts]
misfits = 'misfits.app:main'

================
File: README.md
================
![misfits's interface](https://github.com/peppedilillo/misfits/blob/main/assets/misfits.gif?raw=true)

# misfits

Misfits is a FITs table viewer for the terminal, written in python.
I want it to be snappy as hell and fully usable without touching the mouse.
It currently has some limitations (e.g. won't display VLA columns), but will work on them eventually.
It leverages astropy and pandas, and is built using [textual](https://www.textualize.io/).
Works on Linux, macOS and Windows. Performances on Windows are worse.
Renders best on modern terminals.

### Installation

#### Installing with `pip`

`pip install misfits`

Make sure to be installing into a fresh python>=3.11 environment!

#### Installing with `uv`

`uv tool install misfits`

With the other methods, you are supposed to activate the misfits environment first to use it.
Installing with uv you won't need that, and you will be able to call misfits from terminal with one line: `misfits`.
If you are unsure about uv: don't, give it a [try](https://docs.astral.sh/uv/getting-started/installation/)!
It is a great package manager from the people behind ruff and other python tools.

#### Installing with anaconda

`conda env create -f conda-env.yml`

Will create a new environment and install `misfits` in it.

### Usage

From the terminal, run `misfits path_to_file.fits`, `misfits .`, or simply `misfits`. 

### Contributing

Found a bug? Want a feature? Open an issue, a PR, or post in the discussion section of this repo.

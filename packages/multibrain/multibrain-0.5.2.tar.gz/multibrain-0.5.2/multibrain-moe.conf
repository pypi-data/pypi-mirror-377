<VirtualHost *:80>
    ServerName multibrain.moe
    ServerAdmin webmaster@libre.is
    
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/multibrain-error.log
    CustomLog ${APACHE_LOG_DIR}/multibrain-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName multibrain.moe
    ServerAdmin webmaster@multibrain.moe
    
    # Document root for Svelte frontend
    DocumentRoot /var/www/multibrain/frontend/dist
    
    # Frontend static files
    <Directory /var/www/multibrain/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
        </IfModule>
        
        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpg "access plus 1 month"
            ExpiresByType image/jpeg "access plus 1 month"
            ExpiresByType image/gif "access plus 1 month"
            ExpiresByType image/png "access plus 1 month"
            ExpiresByType text/css "access plus 1 week"
            ExpiresByType application/javascript "access plus 1 week"
        </IfModule>
        
        # SPA fallback - serve index.html for all routes
        FallbackResource /index.html
    </Directory>
    
    # Serve article images from the existing static directory
    Alias /static /var/www/multibrain/static
    <Directory /var/www/multibrain/static>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Cache images
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
        </IfModule>
    </Directory>
    
    # Proxy configuration
    ProxyPreserveHost On
    ProxyTimeout 7200
    
    # Proxy API requests to FastAPI backend
    ProxyPass /api http://localhost:8000/api
    ProxyPassReverse /api http://localhost:8000/api
    
    # Proxy WebSocket connections
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/ws$ ws://localhost:8000/ws [P,L]
    
    ProxyPass /ws ws://localhost:8000/ws
    ProxyPassReverse /ws ws://localhost:8000/ws
    
    # Proxy health check endpoints
    ProxyPass /health http://localhost:8000/health
    ProxyPassReverse /health http://localhost:8000/health
    ProxyPass /ready http://localhost:8000/ready
    ProxyPassReverse /ready http://localhost:8000/ready
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/multibrain.moe/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/multibrain.moe/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Additional security headers for modern browsers
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss://multibrain.moe ws://localhost:8000"
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/multibrain-error.log
    CustomLog ${APACHE_LOG_DIR}/multibrain-access.log combined
</VirtualHost>

# Enable required Apache modules:
# a2enmod proxy proxy_http proxy_wstunnel rewrite headers ssl expires deflate
# a2ensite multibrain.moe
# systemctl reload apache2

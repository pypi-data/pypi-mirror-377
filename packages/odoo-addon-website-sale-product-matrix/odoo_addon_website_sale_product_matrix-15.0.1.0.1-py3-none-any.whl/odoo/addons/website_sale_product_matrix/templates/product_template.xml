<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <template id="product_matrix" name="Product matrix">
        <div class="table-responsive">
            <table
                class="o_matrix_input_table o_product_variant_matrix table table-sm table-striped"
            >
                <thead>
                    <tr>
                        <t
                            t-foreach="product_matrix.get('header', [])"
                            t-as="column_header"
                        >
                            <th class="border-top-0 text-center">
                                <t t-if="not column_header_first">
                                    <span t-esc="column_header.get('name')" />
                                    <t t-if="column_header.get('price')">
                                        <span class="badge badge-pill badge-secondary">
                                            <span
                                                class="variant_price_extra"
                                                style="white-space: nowrap;"
                                            >
                                                + <t
                                                    t-esc="column_header['price']"
                                                    t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"
                                                />
                                            </span>
                                        </span>
                                    </t>
                                </t>
                            </th>
                        </t>
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="product_matrix.get('matrix', [])" t-as="row">
                        <t t-foreach="row" t-as="cell">
                            <td t-if="'name' in cell" class="text-left">
                                <strong t-esc="cell['name']" />
                                <t t-if="cell.get('price')">
                                    <span class="badge badge-pill badge-secondary">
                                        <span
                                            class="variant_price_extra"
                                            style="white-space: nowrap;"
                                        >
                                            <t
                                                t-esc="cell['price']"
                                                t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"
                                            />
                                        </span>
                                    </span>
                                </t>
                            </td>
                            <td t-else="" class="text-center">
                                <div
                                    t-if="cell.get('is_possible_combination')"
                                    class="input-group justify-content-center css_quantity"
                                >
                                    <div class="input-group-prepend">
                                        <a
                                            href=""
                                            class="btn btn-primary js_add_cart_json d-none d-inline-block"
                                            aria-label="Remove one"
                                            title="Remove one"
                                        >
                                            <i class="fa fa-minus" />
                                        </a>
                                    </div>
                                    <input
                                        class="o_matrix_input text-center form-control"
                                        data-min="0"
                                        t-att-data-ptav_ids="cell['ptav_ids']"
                                        t-att-value="cell['qty'] and int(cell['qty']) or None"
                                    />
                                    <div class="input-group-append">
                                        <a
                                            href=""
                                            class="btn btn-primary float_left js_add_cart_json d-none d-inline-block"
                                            aria-label="Add one"
                                            title="Add one"
                                        >
                                            <i class="fa fa-plus" />
                                        </a>
                                    </div>
                                    <!-- TODO: module for stock managing -->
                                    <!-- <small class="text-success ml-2">3 Units</small> -->
                                </div>
                                <span
                                    t-else=""
                                    class="o_matrix_cell o_matrix_text_muted o_matrix_nocontent_container"
                                > Not available </span>
                            </td>
                        </t>
                    </tr>
                </tbody>
            </table>
        </div>
    </template>
    <template
        id="product"
        inherit_id="website_sale.product"
        name="Product matrix"
        customize_show="True"
    >
        <xpath
            expr="//div[hasclass('js_product')]//t[@t-placeholder='select']"
            position="attributes"
        >
            <attribute name="t-if">product.product_add_mode != 'matrix'</attribute>
        </xpath>
        <xpath expr="//div[@id='add_to_cart_wrap']" position="after">
            <a
                t-if="product.product_add_mode == 'matrix'"
                href="#modalMatrix"
                data-toggle="modal"
                aria-expanded="false"
                aria-controls="modalMatrix"
                role="button"
                class="btn btn-primary btn-lg my-1 mr-1 px-5 font-weight-bold flex-grow-1 text-uppercase"
            ><i class="fa fa-cart-plus mr-2" /> Configure options</a>
        </xpath>
        <xpath expr="//div[@id='add_to_cart_wrap']" position="attributes">
            <attribute name="t-if">product.product_add_mode != 'matrix'</attribute>
        </xpath>
        <xpath expr="//section[@id='product_detail']">
        <div
                class="modal fade"
                id="modalMatrix"
                tabindex="-1"
                role="dialog"
                aria-hidden="true"
            >
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form
                            t-if="product.product_add_mode == 'matrix' and product._is_add_to_cart_possible()"
                            t-att-data-product_template_id="product.id"
                            method="POST"
                            id="product_matrix_form"
                        >
                        <div class="modal-header">
                            <h5 class="modal-title">Configure product options</h5>
                            <button
                                    type="button"
                                    class="close"
                                    data-dismiss="modal"
                                    aria-label="Close"
                                >
                            <span aria-hidden="true">&amp;times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                                <input
                                    type="hidden"
                                    name="csrf_token"
                                    t-att-value="request.csrf_token()"
                                />
                                <t t-call="website_sale_product_matrix.product_matrix">
                                    <t
                                        t-set="website_sale_order"
                                        t-value="website.sale_get_order()"
                                    />
                                    <t
                                        t-set="product_matrix"
                                        t-value="website_sale_order._get_matrix(product)"
                                    />
                                    <t t-set="show_buy_button" t-value="True" />
                                </t>
                        </div>
                        <div class="modal-footer">
                            <a
                                    role="button"
                                    class="btn btn-primary btn px-5 font-weight-bold o_we_order_matrix"
                                    href="#"
                                ><i
                                        class="fa fa-shopping-cart mr-2"
                                    />UPDATE CART WITH OPTIONS</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        </xpath>
    </template>
    <template
        id="product_quantity_hidden"
        inherit_id="website_sale.product_quantity"
        name="Hide quantity for matrix"
    >
        <xpath expr="//div[hasclass('css_quantity')]" position="attributes">
            <attribute name="t-if">product.product_add_mode != 'matrix'</attribute>
        </xpath>
    </template>
    <template
        id="add_to_cart_product_add_mode"
        inherit_id="website_sale.add_to_cart_redirect"
        name="Product Add Mode info"
        priority="1"
    >
        <xpath expr="//t[@t-set='html_data']" position="after">
            <t
                t-if="product"
                t-set="html_data"
                t-value="dict(html_data, **{'data-product-add-mode': product.product_add_mode})"
            />
        </xpath>
    </template>
</odoo>

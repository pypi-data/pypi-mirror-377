Metadata-Version: 2.4
Name: query-builder-tool
Version: 0.2.1
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: MacOS
Classifier: Operating System :: MacOS :: MacOS X
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Rust
Classifier: Topic :: Database
Classifier: Topic :: Security
Classifier: Topic :: Software Development :: Libraries :: Python Modules
License-File: LICENSE
Summary: A secure SQL query builder for Python using Rust and pyo3. Supports dynamic templates with safety checks against SQL injection.
Keywords: sql,query,builder,security,rust,pyo3
Author-email: ç¼ªå…‹æ‹‰ <2972799448@qq.com>
Requires-Python: >=3.8, <3.13
Description-Content-Type: text/markdown; charset=UTF-8; variant=GFM
Project-URL: Homepage, https://github.com/miaokela/query-builder
Project-URL: Repository, https://github.com/miaokela/query-builder
Project-URL: Documentation, https://github.com/miaokela/query-builder#readme
Project-URL: Bug Tracker, https://github.com/miaokela/query-builder/issues

# Query Builder

ä¸€ä¸ªé«˜æ€§èƒ½çš„SQLæŸ¥è¯¢æ„å»ºå™¨ï¼Œä½¿ç”¨Rust + PyO3å¼€å‘ï¼Œä¸ºPythonæä¾›å†…å­˜ç¼“å­˜çš„SQLæ¨¡æ¿æ¸²æŸ“åŠŸèƒ½ã€‚

## ğŸš€ ç‰¹æ€§

- **âš¡ æé€Ÿæ€§èƒ½**: ä½¿ç”¨Rustå¼€å‘ + å†…å­˜æ¨¡æ¿ç¼“å­˜ï¼Œæä¾›åŸç”Ÿçº§åˆ«çš„æ€§èƒ½
- **ğŸ”’ å®‰å…¨ç¬¬ä¸€**: å†…ç½®SQLæ³¨å…¥é˜²æŠ¤å’Œå±é™©å…³é”®è¯æ£€æµ‹
- **ğŸ§  æ™ºèƒ½ç¼“å­˜**: å¯åŠ¨æ—¶ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ¨¡æ¿åˆ°å†…å­˜ï¼ŒæŸ¥è¯¢æ—¶é›¶IOæ“ä½œ
- **ğŸ¯ æ¨¡æ¿å¼•æ“**: åŸºäºTeraæ¨¡æ¿å¼•æ“ï¼Œæ”¯æŒæ¡ä»¶è¯­å¥ã€å¾ªç¯ç­‰é«˜çº§åŠŸèƒ½
- **ğŸ Pythonå‹å¥½**: å®Œæ•´çš„ç±»å‹æç¤ºæ”¯æŒï¼ŒVS Codeæ™ºèƒ½æ„ŸçŸ¥
- **ğŸŒ è·¨å¹³å°**: æ”¯æŒmacOSã€Windowsã€Linuxå¤šå¹³å°

## ğŸ—ï¸ æ¶æ„ä¼˜åŠ¿

### ğŸ”¥ æ€§èƒ½ä¼˜åŒ–
```
ä¼ ç»Ÿæ–¹å¼:  æŸ¥è¯¢æ—¶è¯»å–æ–‡ä»¶ â†’ è§£æYAML â†’ æ¸²æŸ“SQL
æ–°æ¶æ„:    å¯åŠ¨æ—¶åŠ è½½å…¨éƒ¨ â†’ æŸ¥è¯¢æ—¶å†…å­˜è¯»å– âš¡ â†’ æ¸²æŸ“SQL
```

### ğŸ’¾ å†…å­˜ç¼“å­˜æœºåˆ¶
- **ä¸€æ¬¡åŠ è½½** - åº”ç”¨å¯åŠ¨æ—¶å°†æ‰€æœ‰SQLæ¨¡æ¿åŠ è½½åˆ°å†…å­˜
- **é›¶IOæŸ¥è¯¢** - æ„å»ºSQLæ—¶ç›´æ¥ä»å†…å­˜è·å–æ¨¡æ¿
- **ç”Ÿäº§å°±ç»ª** - é€‚åˆé«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„ç”Ÿäº§ç¯å¢ƒ

### ğŸ¯ VS Codeå®Œæ•´æ”¯æŒ
- **æ™ºèƒ½æ„ŸçŸ¥** - å®Œæ•´çš„æ–¹æ³•å’Œå±æ€§æç¤º
- **ç±»å‹æ£€æŸ¥** - å‚æ•°ç±»å‹éªŒè¯å’Œé”™è¯¯é¢„é˜²
- **æ–‡æ¡£æ‚¬æµ®** - ä¸°å¯Œçš„APIè¯´æ˜å’Œç¤ºä¾‹

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **ä»…æ”¯æŒ SELECT æŸ¥è¯¢** - ä¸¥æ ¼é™åˆ¶åªèƒ½æ„é€ æŸ¥è¯¢è¯­å¥
- **SQL æ³¨å…¥é˜²æŠ¤** - æ£€æµ‹å’Œé˜»æ­¢å¸¸è§çš„ SQL æ³¨å…¥æ”»å‡»æ¨¡å¼
- **å±é™©å…³é”®è¯è¿‡æ»¤** - é˜»æ­¢ DROPã€UPDATEã€DELETE ç­‰å±é™©æ“ä½œ
- **æ¨¡å¼åŒ¹é…æ£€æµ‹** - è¯†åˆ«æ³¨é‡Šæ³¨å…¥ã€UNION æ³¨å…¥ç­‰æ”»å‡»

## ğŸ“¦ å®‰è£…

```bash
pip install query-builder-tool
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç»„ç»‡SQLæ¨¡æ¿

åˆ›å»ºæ¨¡æ¿ç›®å½•ç»“æ„ï¼š
```
sql/
â”œâ”€â”€ users.yaml          # ç”¨æˆ·æŸ¥è¯¢
â”œâ”€â”€ orders.yaml         # è®¢å•æŸ¥è¯¢
â””â”€â”€ api.yaml            # APIæŸ¥è¯¢
```

#### users.yaml
```yaml
select_by_id: |
  SELECT id, name, email, created_at 
  FROM users 
  WHERE id = {{ user_id }};

list_active: |
  SELECT id, name, email 
  FROM users 
  WHERE status = "{{ status }}"
  {% if limit %}LIMIT {{ limit }}{% endif %};

search: |
  SELECT id, name, email 
  FROM users 
  WHERE name LIKE "%{{ keyword }}%" 
  ORDER BY created_at DESC
  {% if limit %}LIMIT {{ limit }}{% endif %};
```

#### orders.yaml
```yaml
recent: |
  SELECT * FROM orders 
  WHERE created_at >= "{{ start_date }}"
  ORDER BY created_at DESC
  LIMIT {{ limit }};

by_customer: |
  SELECT * FROM orders 
  WHERE customer_id = {{ customer_id }}
  AND status = "{{ status }}";
```

### 2. åŸºæœ¬ç”¨æ³•ï¼ˆæ–°æ¶æ„ï¼‰

```python
from query_builder import PyQueryBuilder

# ğŸ”¥ æ–°çš„ä¼˜åŒ–ç”¨æ³•
qb = PyQueryBuilder()

# 1. è®¾ç½®æ¨¡æ¿ç›®å½•
qb.sql_path = "./sql"

# 2. ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ¨¡æ¿åˆ°å†…å­˜ï¼ˆé‡è¦ï¼ï¼‰
qb.load_all_templates()

# 3. ç°åœ¨å¯ä»¥å¿«é€Ÿæ„å»ºæŸ¥è¯¢ï¼ˆä»å†…å­˜ï¼‰
sql = qb.build("users.select_by_id", user_id=123)
print(sql)
# è¾“å‡º: SELECT id, name, email, created_at FROM users WHERE id = 123;

# å¤æ‚æŸ¥è¯¢ç¤ºä¾‹
sql = qb.build("users.list_active", status="active", limit=10)
sql = qb.build("orders.recent", start_date="2024-01-01", limit=50)
sql = qb.build("users.search", keyword="john", limit=20)
```

### 3. æ¨¡æ¿é”®æ ¼å¼

ä½¿ç”¨ `æ–‡ä»¶å.æ¨¡æ¿å` çš„æ ¼å¼ï¼š
- `users.select_by_id` â†’ `sql/users.yaml` ä¸­çš„ `select_by_id`
- `orders.recent` â†’ `sql/orders.yaml` ä¸­çš„ `recent`  
- `api.search` â†’ `sql/api.yaml` ä¸­çš„ `search`

### 4. æŸ¥çœ‹å¯ç”¨æ¨¡æ¿

```python
# è·å–æ‰€æœ‰å·²åŠ è½½çš„æ¨¡æ¿é”®
keys = qb.get_template_keys()
print("å¯ç”¨æ¨¡æ¿:", keys)
# ['users.select_by_id', 'users.list_active', 'orders.recent', ...]

# æ£€æŸ¥ç‰¹å®šæ¨¡æ¿æ˜¯å¦å­˜åœ¨
if "users.select_by_id" in keys:
    sql = qb.build("users.select_by_id", user_id=123)
```

### 5. é”™è¯¯å¤„ç†

```python
try:
    qb = PyQueryBuilder()
    qb.sql_path = "./sql"
    qb.load_all_templates()  # å¯èƒ½æŠ›å‡º ValueError æˆ– IOError
    
    sql = qb.build("users.select_by_id", user_id=123)  # å¯èƒ½æŠ›å‡º KeyError
    
except ValueError as e:
    print(f"é…ç½®é”™è¯¯: {e}")
except IOError as e:
    print(f"æ–‡ä»¶è¯»å–é”™è¯¯: {e}")
except KeyError as e:
    print(f"æ¨¡æ¿ä¸å­˜åœ¨: {e}")
```

## ğŸ¨ æ¨¡æ¿è¯­æ³•

Query Builderä½¿ç”¨Teraæ¨¡æ¿å¼•æ“ï¼Œæ”¯æŒä»¥ä¸‹è¯­æ³•ï¼š

### å˜é‡æ›¿æ¢
```sql
SELECT * FROM users WHERE id = {{ user_id }};
```

### æ¡ä»¶è¯­å¥
```sql
SELECT * FROM products 
WHERE category = "{{ category }}"
{% if min_price %}AND price >= {{ min_price }}{% endif %}
{% if max_price %}AND price <= {{ max_price }}{% endif %};
```

### å¾ªç¯
```sql
SELECT * FROM users 
WHERE id IN ({% for id in user_ids %}{{ id }}{% if not loop.last %},{% endif %}{% endfor %});
```

### å­—ç¬¦ä¸²å¤„ç†
```sql
SELECT * FROM users 
WHERE name LIKE "%{{ keyword | lower }}%";
```

## ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥

ä»¥ä¸‹ç±»å‹çš„ SQL ä¼šè¢«è‡ªåŠ¨é˜»æ­¢ï¼š

- é SELECT è¯­å¥ï¼ˆUPDATEã€DELETEã€INSERT ç­‰ï¼‰
- åŒ…å«å±é™©å…³é”®è¯ï¼ˆDROPã€TRUNCATEã€EXEC ç­‰ï¼‰
- SQL æ³¨å…¥æ”»å‡»æ¨¡å¼ï¼ˆæ³¨é‡Šæ³¨å…¥ã€UNION æ³¨å…¥ç­‰ï¼‰
- è„šæœ¬æ³¨å…¥æ”»å‡»ï¼ˆJavaScriptã€VBScript ç­‰ï¼‰

### å®‰å…¨ç¤ºä¾‹

```python
# âŒ è¿™äº›æ“ä½œä¼šè¢«é˜»æ­¢
try:
    qb.build('malicious', query='DROP TABLE users;')  # æŠ›å‡º ValueError
except ValueError as e:
    print("å®‰å…¨æ£€æŸ¥é˜»æ­¢äº†å±é™©æ“ä½œ:", e)

# âœ… åªå…è®¸å®‰å…¨çš„SELECTæŸ¥è¯¢
sql = qb.build('users.select_by_id', user_id=123)  # æ­£å¸¸å·¥ä½œ
```

## ğŸ“‹ å®Œæ•´APIå‚è€ƒ

### PyQueryBuilder ç±»

#### å±æ€§
- `sql_path: Optional[str]` - SQLæ¨¡æ¿ç›®å½•è·¯å¾„

#### æ–¹æ³•

##### `__init__() -> None`
åˆ›å»ºæ–°çš„æŸ¥è¯¢æ„å»ºå™¨å®ä¾‹ã€‚

##### `load_all_templates() -> None`
å°†æ‰€æœ‰SQLæ¨¡æ¿åŠ è½½åˆ°å†…å­˜ã€‚å¿…é¡»åœ¨æ„å»ºæŸ¥è¯¢å‰è°ƒç”¨ã€‚
- **å¼‚å¸¸**: `ValueError`, `IOError`

##### `build(key: str, **kwargs) -> str`
ä»å†…å­˜ä¸­çš„æ¨¡æ¿æ„å»ºSQLæŸ¥è¯¢ã€‚
- **å‚æ•°**: 
  - `key`: æ¨¡æ¿é”®ï¼ˆæ ¼å¼: "æ–‡ä»¶.æ¨¡æ¿"ï¼‰
  - `**kwargs`: æ¨¡æ¿å˜é‡
- **è¿”å›**: æ¸²æŸ“åçš„SQLå­—ç¬¦ä¸²
- **å¼‚å¸¸**: `KeyError`, `ValueError`

##### `get_template_keys() -> List[str]`
è·å–æ‰€æœ‰å·²åŠ è½½çš„æ¨¡æ¿é”®ã€‚
- **è¿”å›**: æ¨¡æ¿é”®åˆ—è¡¨

### ä¾¿åˆ©å‡½æ•°

#### `builder() -> PyQueryBuilder`
åˆ›å»ºæ–°çš„PyQueryBuilderå®ä¾‹çš„ä¾¿åˆ©å‡½æ•°ã€‚

## ğŸš€ æ€§èƒ½åŸºå‡†

### å†…å­˜ç¼“å­˜ vs æ–‡ä»¶è¯»å–
```python
import time
from query_builder import PyQueryBuilder

# ä¼ ç»Ÿæ–¹å¼æ¨¡æ‹Ÿï¼ˆæ¯æ¬¡è¯»å–æ–‡ä»¶ï¼‰
def old_way():
    # å‡è®¾æ¯æ¬¡æŸ¥è¯¢éœ€è¦ 5ms æ–‡ä»¶IO
    time.sleep(0.005)
    return "SELECT * FROM users"

# æ–°çš„å†…å­˜ç¼“å­˜æ–¹å¼
qb = PyQueryBuilder()
qb.sql_path = "./sql"
qb.load_all_templates()  # ä¸€æ¬¡æ€§åŠ è½½

# æ€§èƒ½å¯¹æ¯”
queries = 1000

# æ–°æ–¹å¼ï¼šä»å†…å­˜æŸ¥è¯¢
start = time.time()
for i in range(queries):
    sql = qb.build("users.select_by_id", user_id=i)
new_time = time.time() - start

print(f"å†…å­˜ç¼“å­˜æ–¹å¼: {new_time:.4f}s")
print(f"å¹³å‡æ¯æŸ¥è¯¢: {new_time/queries*1000:.2f}ms")
```

## ğŸ› ï¸ å¼€å‘

### æœ¬åœ°æ„å»º

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/miaokela/query-builder.git
cd query-builder

# å®‰è£…ä¾èµ–
pip install maturin pyyaml

# å¼€å‘æ¨¡å¼æ„å»º
maturin develop

# è¿è¡Œæµ‹è¯•
python example_with_types.py
```

### æµ‹è¯•

```bash
# æµ‹è¯•åŸºæœ¬åŠŸèƒ½
python -c "
from query_builder import PyQueryBuilder
qb = PyQueryBuilder()
print('Query Builder æ­£å¸¸å·¥ä½œï¼')
"
```

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
query-builder/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lib.rs                  # Rustæ ¸å¿ƒä»£ç 
â”œâ”€â”€ sql/                        # SQLæ¨¡æ¿ç¤ºä¾‹
â”‚   â”œâ”€â”€ users.yaml
â”‚   â””â”€â”€ orders.yaml
â”œâ”€â”€ query_builder.pyi           # ç±»å‹æç¤ºæ–‡ä»¶
â”œâ”€â”€ example_with_types.py       # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ TYPE_HINTS_GUIDE.md         # è¯¦ç»†æŒ‡å—
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ build-simple-maturin.yml  # CI/CDé…ç½®
â”œâ”€â”€ Cargo.toml                  # Rustä¾èµ–é…ç½®
â”œâ”€â”€ pyproject.toml              # PythonåŒ…é…ç½®
â””â”€â”€ README.md
```

## ğŸš¦ CI/CDçŠ¶æ€

- âœ… è‡ªåŠ¨åŒ–æ„å»ºæ”¯æŒmacOSï¼ˆx86_64 + ARM64ï¼‰ã€Windows x64ã€Linux x64
- âœ… æ”¯æŒPython 3.8-3.12
- âœ… è‡ªåŠ¨å‘å¸ƒåˆ°PyPI
- âœ… å…¨é¢çš„å®‰å…¨æµ‹è¯•

## ğŸ“„ è®¸å¯è¯

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼è¯·ç¡®ä¿ï¼š

1. æ‰€æœ‰æµ‹è¯•é€šè¿‡
2. éµå¾ªå®‰å…¨ç¼–ç è§„èŒƒ
3. æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“ è”ç³»

- ä½œè€…: ç¼ªå…‹æ‹‰
- é‚®ç®±: 2972799448@qq.com
- GitHub: https://github.com/miaokela/query-builder

## ğŸ™ è‡´è°¢

- [PyO3](https://github.com/PyO3/pyo3) - ä¼˜ç§€çš„Rust-Pythonç»‘å®šåº“
- [Tera](https://github.com/Keats/tera) - å¼ºå¤§çš„æ¨¡æ¿å¼•æ“
- [maturin](https://github.com/PyO3/maturin) - PythonåŒ…æ„å»ºå·¥å…·

<!-- API Key Generated Success (Partial for HTMX) -->
<div class="notification is-success">
    <button class="delete" onclick="this.parentElement.style.display='none'"></button>
    <p class="has-text-weight-bold">
        <span class="icon">
            <i class="fas fa-check-circle"></i>
        </span>
        {% if is_regeneration %}API Key Regenerated Successfully{% else %}API Key Generated Successfully{% endif %}
    </p>
    <p>Your new API key has been created. Save it now - it will not be shown again.</p>
</div>

<div class="box">
    <div class="notification is-warning">
        <p class="has-text-weight-bold">
            <span class="icon">
                <i class="fas fa-exclamation-triangle"></i>
            </span>
            Important Security Notice
        </p>
        <p>This is the only time you will see your API key. Copy it now and store it securely.</p>
    </div>

    <div class="field">
        <label class="label">Your New API Key</label>
        <div class="field has-addons">
            <div class="control is-expanded">
                <input 
                    class="input is-family-monospace" 
                    type="text" 
                    value="{{ full_key }}" 
                    readonly 
                    id="api-key-value-{{ api_key.id }}"
                >
            </div>
            <div class="control">
                <button 
                    class="button is-primary" 
                    onclick="copyApiKey('{{ api_key.id }}')"
                    id="copy-btn-{{ api_key.id }}"
                >
                    <span class="icon">
                        <i class="fas fa-copy"></i>
                    </span>
                    <span>Copy</span>
                </button>
            </div>
        </div>
    </div>

    <div class="field">
        <label class="label">Key Details</label>
        <table class="table is-narrow">
            <tbody>
                <tr>
                    <td><strong>Name:</strong></td>
                    <td>{{ api_key.name|default:"Unnamed Key" }}</td>
                </tr>
                <tr>
                    <td><strong>Prefix:</strong></td>
                    <td><code>{{ api_key.prefix }}...****</code></td>
                </tr>
                <tr>
                    <td><strong>Created:</strong></td>
                    <td>{{ api_key.created_at|date:'M j, Y g:i A' }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="buttons">
        <button class="button is-success" onclick="acknowledgeKey('{{ api_key.id }}')">
            <span class="icon">
                <i class="fas fa-check"></i>
            </span>
            <span>I've Saved My Key</span>
        </button>
        {% if api_endpoints_enabled %}
        <a href="{% url 'api:api_docs' %}" class="button is-link">
            <span class="icon">
                <i class="fas fa-book"></i>
            </span>
            <span>View API Documentation</span>
        </a>
        {% endif %}
    </div>
</div>

<!-- Now show all API keys -->
{% include "users/partials/api_keys_list.html" %}

<script>
function copyApiKey(keyId) {
    const input = document.getElementById(`api-key-value-${keyId}`);
    const button = document.getElementById(`copy-btn-${keyId}`);
    
    input.select();
    input.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(input.value).then(function() {
        // Update button to show success
        const originalHtml = button.innerHTML;
        button.innerHTML = '<span class="icon"><i class="fas fa-check"></i></span><span>Copied!</span>';
        button.classList.remove('is-primary');
        button.classList.add('is-success');
        
        // Reset button after 2 seconds
        setTimeout(function() {
            button.innerHTML = originalHtml;
            button.classList.remove('is-success');
            button.classList.add('is-primary');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        document.execCommand('copy');
        button.innerHTML = '<span class="icon"><i class="fas fa-check"></i></span><span>Copied!</span>';
        button.classList.remove('is-primary');
        button.classList.add('is-success');
        
        setTimeout(function() {
            button.innerHTML = '<span class="icon"><i class="fas fa-copy"></i></span><span>Copy</span>';
            button.classList.remove('is-success');
            button.classList.add('is-primary');
        }, 2000);
    });
}

function acknowledgeKey(keyId) {
    // Reload the API keys list without the generated key display
    htmx.ajax('GET', '{% url "users:api_keys_list_partial" %}', {target: '#api-keys-container', swap: 'outerHTML'});
}
</script>

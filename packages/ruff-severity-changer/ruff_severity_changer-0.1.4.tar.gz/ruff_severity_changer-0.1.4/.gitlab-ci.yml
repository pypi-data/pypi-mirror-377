stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - publish

build_app:
    stage: build
    image: python:3.12-alpine
    rules:
      - if: '$CI_COMMIT_TAG =~ /release\/\d+\.\d+\.\d+/'
    script:
        - python -m pip install --upgrade build
        - python -m build
    artifacts:
      untracked: true
      paths:
        - "dist/"

publish_testpypi:
    stage: publish
    image: python:3.12-alpine
    rules:
      - if: '$CI_COMMIT_TAG =~ /release\/\d+\.\d+\.\d+/'
    needs:
      - build_app
    script:
        - python3 -m pip install --upgrade twine
        - twine upload -r testpypi --config-file $PY_TOKEN dist/*

publish_pypi:
    stage: publish
    image: python:3.12-alpine
    rules:
      - if: '$CI_COMMIT_TAG =~ /release\/\d+\.\d+\.\d+/'
    when: manual
    needs:
      - build_app
    script:
        - python3 -m pip install --upgrade twine
        - twine upload --config-file $PY_TOKEN dist/*
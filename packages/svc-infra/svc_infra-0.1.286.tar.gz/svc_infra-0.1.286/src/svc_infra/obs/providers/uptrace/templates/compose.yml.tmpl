services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    restart: unless-stopped
    environment:
      - CLICKHOUSE_DB=default
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - ch-data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query=SELECT 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_USER=uptrace
      - POSTGRES_PASSWORD=uptrace
      - POSTGRES_DB=uptrace
    volumes:
      - pg-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U uptrace -d uptrace"]
      interval: 5s
      timeout: 3s
      retries: 20

  uptrace:
    image: uptrace/uptrace:latest
    restart: unless-stopped
    depends_on:
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy
    ports:
      - "14318:14318"  # UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
    environment:
      # Required server storage:
      - UPTRACE_DATABASE_DSN=postgres://uptrace:uptrace@postgres:5432/uptrace?sslmode=disable
      - UPTRACE_CLICKHOUSE_DSN=clickhouse://default:@clickhouse:9000/default

      # Listeners (explicit so we know the UI is bound)
      - UPTRACE_HTTP_LISTEN=:14318
      - UPTRACE_OTLP_GRPC_LISTEN=:4317
      - UPTRACE_OTLP_HTTP_LISTEN=:4318

      # Optional UI auth:
      # - UPTRACE_BASICAUTH_USER=admin
      # - UPTRACE_BASICAUTH_PASS=change-me

      # Optional: if youâ€™ll send traces from apps using DSN auth
      # - UPTRACE_DSN=<your-project-dsn>

volumes:
  ch-data:
  pg-data:

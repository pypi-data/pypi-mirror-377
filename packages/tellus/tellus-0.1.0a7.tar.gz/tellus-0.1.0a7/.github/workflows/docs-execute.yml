name: Execute Documentation

on:
  push:
    branches: [ main, develop, rest ]
    paths:
      - 'docs/**/*.ipynb'
      - '**/*DEMO*.ipynb'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**/*.ipynb'
      - '**/*DEMO*.ipynb'

jobs:
  execute-notebooks:
    name: Execute Documentation Notebooks
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        notebook:
          - "docs/tutorials/CLI_DEMO.ipynb"
          - "docs/tutorials/REST_API_DEMO.ipynb"
      fail-fast: false  # Continue with other notebooks even if one fails
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e .
        python -m pip install jupyter
    
    - name: Prepare notebook environment
      run: |
        # Create temp directories that demos expect
        mkdir -p /tmp/dev-storage
        mkdir -p /tmp/api-demo-storage
        
        # Clean up any existing state for reproducible runs
        rm -f simulations.json locations.json
    
    - name: Execute notebook
      run: |
        notebook="${{ matrix.notebook }}"
        echo "ðŸ““ Executing notebook: $notebook"
        
        # Clear any existing outputs for clean execution
        jupyter nbconvert --clear-output --inplace "$notebook"
        
        # Execute the notebook and capture outputs
        jupyter nbconvert --to notebook --execute --inplace "$notebook"
        
        echo "âœ… Successfully executed: $notebook"
      
    - name: Set artifact name
      run: |
        notebook="${{ matrix.notebook }}"
        basename=$(basename "$notebook" .ipynb)
        echo "ARTIFACT_NAME=$basename" >> $GITHUB_ENV
        
    - name: Upload executed notebook
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: executed-${{ env.ARTIFACT_NAME }}
        path: ${{ matrix.notebook }}
        retention-days: 30
        
    - name: Upload execution logs
      uses: actions/upload-artifact@v4  
      if: failure()
      with:
        name: logs-${{ env.ARTIFACT_NAME }}
        path: |
          simulations.json
          locations.json
        retention-days: 7

